<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>Flask Framework for Python | Dalong's personal blog</title>

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Flask Framework for Python | Dalong’s personal blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Flask Framework for Python" />
<meta name="author" content="Dalong" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Flask是一个轻量级的WSGI Web应用程序框架。它旨在快速轻松地入门，并能够扩展到复杂的应用程序。它最初是围绕Werkzeug和Jinja的简单包装器，现已成为最流行的Python Web应用程序框架之一。本文我会循序渐进的介绍 Flask 一些常用的 web 开发技巧。" />
<meta property="og:description" content="Flask是一个轻量级的WSGI Web应用程序框架。它旨在快速轻松地入门，并能够扩展到复杂的应用程序。它最初是围绕Werkzeug和Jinja的简单包装器，现已成为最流行的Python Web应用程序框架之一。本文我会循序渐进的介绍 Flask 一些常用的 web 开发技巧。" />
<link rel="canonical" href="http://localhost:4000/Flask-framework-for-Python/" />
<meta property="og:url" content="http://localhost:4000/Flask-framework-for-Python/" />
<meta property="og:site_name" content="Dalong’s personal blog" />
<meta property="og:image" content="http://localhost:4000/assets/images/python-flask.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-10T00:00:00+08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Flask Framework for Python","dateModified":"2019-11-10T00:00:00+08:00","datePublished":"2019-11-10T00:00:00+08:00","description":"Flask是一个轻量级的WSGI Web应用程序框架。它旨在快速轻松地入门，并能够扩展到复杂的应用程序。它最初是围绕Werkzeug和Jinja的简单包装器，现已成为最流行的Python Web应用程序框架之一。本文我会循序渐进的介绍 Flask 一些常用的 web 开发技巧。","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"Dalong"},"image":"http://localhost:4000/assets/images/python-flask.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Flask-framework-for-Python/"},"url":"http://localhost:4000/Flask-framework-for-Python/","author":{"@type":"Person","name":"Dalong"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com"> 
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
        <link href="https://fonts.googleapis.com/css2?family=Carter+One&display=swap" rel="stylesheet">
    </noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Dalong's personal blog">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

<!-- 以后再加上相关链接

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://bootstrapstarter.com/bootstrap-templates/template-mediumish-bootstrap-jekyll/"> Docs</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li>
-->
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/dalongli"><i class="fab fa-github"></i> Fork on Github</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">Dalong's personal blog</h1>
    <p class="lead">
        Record the bits and pieces of the technology big bang.
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Flask Framework for Python&url=http://localhost:4000/Flask-framework-for-Python/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/Flask-framework-for-Python/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/Flask-framework-for-Python/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/avatar_dl.png" alt="Dalong">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://dalongli.github.io/about">Dalong</a><a target="_blank" href="https://dalongli.github.io." class="btn follow">Follow</a>
                        <span class="author-description">A profesional technical consultant and blogger.</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Flask Framework for Python</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid" src="/assets/images/python-flask.jpg" alt="Flask Framework for Python">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                    
                    <div class="toc mt-4 mb-4 lead">
                        <h3 class="font-weight-bold">Summary</h3>
                        <ul>
  <li><a href="#flask-框架">Flask 框架</a>
    <ul>
      <li><a href="#开发技巧">开发技巧</a>
        <ul>
          <li><a href="#chrome-快捷键">Chrome 快捷键</a></li>
          <li><a href="#pychar-快捷键">pychar 快捷键</a></li>
          <li><a href="#资源信息">资源信息</a></li>
          <li><a href="#flask-script-监控代码修改-配合谷歌浏览器自动刷新方案-四步">flask-script 监控代码修改, 配合谷歌浏览器自动刷新方案 四步</a></li>
          <li><a href="#apploggerinfo-配合-flask-script-输出log-信息"><code class="language-plaintext highlighter-rouge">app.logger.info</code> 配合 flask-script 输出log 信息</a></li>
          <li><a href="#flask-框架扩展包和使用图示">Flask 框架扩展包和使用图示</a></li>
        </ul>
      </li>
      <li><a href="#flask-框架介绍">Flask 框架介绍</a></li>
      <li><a href="#flask-安装和使用">Flask 安装和使用</a></li>
      <li><a href="#启动参数配置信息">启动参数/配置信息</a></li>
      <li><a href="#请求和响应">请求和响应</a></li>
      <li><a href="#请求钩子函数">请求钩子函数</a></li>
      <li><a href="#视图函数">视图函数</a>
        <ul>
          <li><a href="#路由介绍-approute">路由介绍 <code class="language-plaintext highlighter-rouge">@app.route()</code></a></li>
          <li><a href="#获取客户端请求request-信息--requestxxx">获取客户端请求(<code class="language-plaintext highlighter-rouge">request</code>) 信息.  <code class="language-plaintext highlighter-rouge">request.xxx()</code></a></li>
          <li><a href="#响应response-的处理函数-make_response">响应(response) 的处理函数 <code class="language-plaintext highlighter-rouge">make_response()</code></a></li>
          <li><a href="#重定向-redirect">重定向 <code class="language-plaintext highlighter-rouge">redirect()</code></a></li>
          <li><a href="#通过函数名找到路由-url_for">通过函数名找到路由 <code class="language-plaintext highlighter-rouge">url_for()</code></a></li>
          <li><a href="#异常终止客户请求-abort500">异常终止客户请求 <code class="language-plaintext highlighter-rouge">abort(500)</code></a></li>
          <li><a href="#定制页面报错信息-errorhandler404">定制页面报错信息 <code class="language-plaintext highlighter-rouge">errorhandler(404)</code></a></li>
          <li><a href="#会话控制-respset_cookie-requestcookiesget-sessionusername--大龙-sessionget">会话控制 <code class="language-plaintext highlighter-rouge">resp.set_cookie, request.cookies.get()</code> <code class="language-plaintext highlighter-rouge">session['username'] = '大龙', session.get()</code></a></li>
          <li><a href="#todo-登录访问-login_required">todo 登录访问 <code class="language-plaintext highlighter-rouge">@login_required</code></a></li>
          <li><a href="#todo-缓存-flask-cache-扩展">todo 缓存 <code class="language-plaintext highlighter-rouge">Flask-Cache</code> 扩展</a></li>
          <li><a href="#蓝图-blueprint-两步拆分视图函数">蓝图 <code class="language-plaintext highlighter-rouge">Blueprint</code> 两步拆分视图函数</a></li>
          <li><a href="#完整的视图函数的例子-简单的注册登录登出代码">完整的视图函数的例子: 简单的注册,登录,登出代码</a></li>
        </ul>
      </li>
      <li><a href="#模板引擎">模板引擎</a>
        <ul>
          <li><a href="#模板引擎介绍">模板引擎介绍</a></li>
          <li><a href="#jinja2的使用-from-flask-import-render_template-return-render_templateindexhtml">Jinja2的使用 <code class="language-plaintext highlighter-rouge">from flask import render_template</code> <code class="language-plaintext highlighter-rouge">return render_template('index.html')</code></a></li>
          <li><a href="#模板文件中的变量使用--变量--or--g变量-----逻辑块-----注释内容-">模板文件中的变量使用 <code class="language-plaintext highlighter-rouge">{{ 变量 }} or {{ g.变量 }}</code>   <code class="language-plaintext highlighter-rouge">{% 逻辑块 %}</code>   <code class="language-plaintext highlighter-rouge">{# 注释内容 #}</code></a></li>
          <li><a href="#g-变量的使用"><code class="language-plaintext highlighter-rouge">g</code> 变量的使用*</a></li>
          <li><a href="#在模板中对变量使用过滤器---变量upper-">在模板中对变量使用<strong>过滤器</strong>  <code class="language-plaintext highlighter-rouge">{{ 变量|upper }}</code></a></li>
          <li><a href="#自定义过滤器">自定义过滤器</a></li>
          <li><a href="#模板中的流程控制和循环--if-name---for-i-in-range16-">模板中的流程控制和循环 <code class="language-plaintext highlighter-rouge">{% if name %}</code> <code class="language-plaintext highlighter-rouge">{% for i in range(1,6) %}</code></a></li>
          <li><a href="#模板中的文件包含-include-2html-">模板中的文件包含<code class="language-plaintext highlighter-rouge">{% include '2.html' %}</code></a></li>
          <li><a href="#宏模板函数的定义和调用--macro-show_namename----show_namename-">宏(模板函数)的定义和调用 <code class="language-plaintext highlighter-rouge">{% macro show_name(name) %}</code>  <code class="language-plaintext highlighter-rouge">{{ show_name(name) }}</code></a></li>
          <li><a href="#宏也可以单独定义到文件中然后导入到模板中使用--from-3html-import-show_name-">宏也可以单独定义到文件中,然后导入到模板中使用 <code class="language-plaintext highlighter-rouge">{% from '3.html' import show_name %}</code></a></li>
          <li><a href="#block的定义-及-模板的继承--block-title---extends-parentshtml---super-">block的定义 及 模板的继承 <code class="language-plaintext highlighter-rouge">{% block title %}</code> <code class="language-plaintext highlighter-rouge">{% extends 'parents.html' %}</code> <code class="language-plaintext highlighter-rouge">{{ super() }}</code></a></li>
          <li><a href="#flask-bootstrap-支持-bootstrap">flask-bootstrap 支持 bootstrap</a></li>
          <li><a href="#available-blocks">Available blocks</a></li>
          <li><a href="#定义项目基础模板">定义项目基础模板</a></li>
          <li><a href="#继承基础模板-去定义一个404错误页面errorhtml">继承基础模板, 去定义一个404错误页面<code class="language-plaintext highlighter-rouge">error.html</code></a></li>
          <li><a href="#继承基础模板-跳转新页面-注册页面的例子">继承基础模板, 跳转新页面 (注册页面的例子)</a></li>
          <li><a href="#再看url_for-函数-普通构造-参数构造-外链构造">再看url_for() 函数: <code class="language-plaintext highlighter-rouge">普通构造, 参数构造, 外链构造</code></a></li>
        </ul>
      </li>
      <li><a href="#静态文件-图片-css-js">静态文件 图片, css, js</a>
        <ul>
          <li><a href="#加载静态图片-url_forstatic-filenameimgtimgjpg--block-head-">加载静态图片 <code class="language-plaintext highlighter-rouge">url_for('static', filename='img/timg.jpg')</code> <code class="language-plaintext highlighter-rouge">{% block head %}</code></a></li>
          <li><a href="#加载静态css--block-style-">加载静态CSS <code class="language-plaintext highlighter-rouge">{% block style %}</code></a></li>
          <li><a href="#加载静态js---block-scripts-">加载静态JS  <code class="language-plaintext highlighter-rouge">{% block scripts %}</code></a></li>
          <li><a href="#待完善-使用-flask-assets-管理静态资源">待完善: 使用 Flask-Assets 管理静态资源</a></li>
        </ul>
      </li>
      <li><a href="#flask-表单">Flask 表单</a>
        <ul>
          <li><a href="#flask--表单的使用-原生创建表单和验证">FLASK  表单的使用 (原生创建表单和验证)</a></li>
          <li><a href="#flask-wtf-安全表单的创建和验证">flask-wtf 安全表单的创建和验证</a>
            <ul>
              <li><a href="#说明"><em>说明:</em></a></li>
              <li><a href="#安装"><em>安装:</em></a></li>
              <li><a href="#使用"><em>使用:</em></a></li>
              <li><a href="#常见表单字段类型"><em>常见表单字段类型</em></a></li>
              <li><a href="#常见的字段验证器"><em>常见的字段验证器</em></a></li>
              <li><a href="#字段的自定义校验"><em>字段的自定义校验</em></a></li>
            </ul>
          </li>
          <li><a href="#flash-弹出窗口-消息显示-flash--get_flashed_messages">flash 弹出窗口 消息显示 <code class="language-plaintext highlighter-rouge">flash()  get_flashed_messages()</code></a></li>
          <li><a href="#一段完整的表单生成--表单验证--弹窗-的例子">一段完整的表单生成 + 表单验证 + 弹窗 的例子</a></li>
        </ul>
      </li>
      <li><a href="#flask-moment--负责显示时间戳">flask-moment  负责显示时间戳</a></li>
      <li><a href="#扩展知识---为文件上传做准备">扩展知识 - 为文件上传做准备</a>
        <ul>
          <li><a href="#利用环境变量设置自用的配置信息">利用环境变量设置自用的配置信息</a></li>
          <li><a href="#生成随机字符串">生成随机字符串</a></li>
          <li><a href="#生成图片的缩略图-pillow">生成图片的缩略图 <code class="language-plaintext highlighter-rouge">pillow</code></a></li>
        </ul>
      </li>
      <li><a href="#flask-文件上传">Flask 文件上传</a>
        <ul>
          <li><a href="#原生文件上传">原生文件上传</a></li>
          <li><a href="#flask-uploads-扩展库可以帮助我们上传文件">flask-uploads 扩展库可以帮助我们上传文件</a></li>
          <li><a href="#完整上传的代码-包含flask_upload-flask_wtf-flask_bootstrap">完整上传的代码, 包含flask_upload, flask_wtf, flask_bootstrap</a></li>
        </ul>
      </li>
      <li><a href="#flask-mail-邮件发送">flask-mail 邮件发送</a>
        <ul>
          <li><a href="#基本的发送功能"><em>基本的发送功能</em></a></li>
          <li><a href="#重构在刚才的基础上-把邮件内容封装函数使用"><em>重构,在刚才的基础上, 把邮件内容封装函数使用</em></a></li>
          <li><a href="#重构-将发送邮件做到线程里面"><em>重构, 将发送邮件做到线程里面</em></a></li>
        </ul>
      </li>
      <li><a href="#flask-sqlalchemy-操作数据库">Flask-SQLAlchemy 操作数据库</a>
        <ul>
          <li><a href="#数据库回顾">数据库回顾</a></li>
          <li><a href="#sqlite介绍">sqlite介绍:</a>
            <ul>
              <li><a href="#sqlite命令行">sqlite命令行:</a></li>
            </ul>
          </li>
          <li><a href="#flask-sqlalchemy">flask-sqlalchemy</a>
            <ul>
              <li><a href="#1-导入-sqlalchemy-包并做基本配置然后初始化">(1) 导入 SQLAlchemy 包,并做基本配置,然后初始化</a></li>
              <li><a href="#2-设计数据表-数据模型">(2) 设计数据表 数据模型：</a></li>
              <li><a href="#3-通过路由-创建删除表">(3) 通过路由 创建删除表：</a></li>
              <li><a href="#4-命令行创建删除表-可以有人机交互-prompt_bool">(4) 命令行创建删除表, 可以有人机交互 <code class="language-plaintext highlighter-rouge">prompt_bool</code>：</a></li>
              <li><a href="#自定义-flask_script-的-shell命令">自定义 flask_script 的 shell命令</a></li>
            </ul>
          </li>
          <li><a href="#sqlite-数据的curd操作">SQLite 数据的CURD操作</a>
            <ul>
              <li><a href="#增加数据-dbsessionaddfeng-dbsessionadd_allzhong-fei-hui--dbsessioncommit">增加数据 <code class="language-plaintext highlighter-rouge">db.session.add(feng), db.session.add_all([zhong, fei, hui]) , db.session.commit()</code></a></li>
              <li><a href="#根据主键primary_key查询数据-userquerygetuid">根据主键(primary_key)查询数据 <code class="language-plaintext highlighter-rouge">User.query.get(uid)</code></a></li>
              <li><a href="#多种条件查询-userqueryget4-userqueryall-userqueryfilter_byusernamehuifirst">多种条件查询 <code class="language-plaintext highlighter-rouge">User.query.get(4), User.query.all(), User.query.filter_by(username='hui').first(),</code></a></li>
              <li><a href="#更新数据--dbsessionaddu">更新数据  <code class="language-plaintext highlighter-rouge">db.session.add(u)</code></a></li>
              <li><a href="#删除数据--dbsessiondeleteu">删除数据  <code class="language-plaintext highlighter-rouge">db.session.delete(u)</code></a></li>
            </ul>
          </li>
          <li><a href="#sqlite-表字段类型-和-字段参数">SQLite 表字段类型 和 字段参数</a></li>
          <li><a href="#sqlalchemy-建表和插数据技巧二则">SQLAlchemy 建表和插数据技巧二则：</a></li>
          <li><a href="#数据库的迁移-flask-migrate">数据库的迁移 <code class="language-plaintext highlighter-rouge">flask-migrate</code></a>
            <ul>
              <li><a href="#概念-">概念 :</a></li>
              <li><a href="#安装和配置">安装和配置</a></li>
              <li><a href="#开始迁移分三步">开始迁移分三步：</a></li>
            </ul>
          </li>
          <li><a href="#练习">练习</a></li>
        </ul>
      </li>
      <li><a href="#项目练习">项目练习</a>
        <ul>
          <li><a href="#1-利用虚拟环境创建一个pycharm项目-并创建目录">(1) 利用虚拟环境创建一个pycharm项目, 并创建目录</a>
            <ul>
              <li><a href="#pycharm-创建创建虚拟s">pycharm 创建创建虚拟s</a></li>
              <li><a href="#为虚拟环境做依赖的配置信息文件">为虚拟环境做依赖的配置信息文件</a></li>
              <li><a href="#为项目创建目录结构">为项目创建目录结构</a></li>
            </ul>
          </li>
          <li><a href="#1-设置项目配置信息-appconfigpy">(1) 设置项目配置信息 <code class="language-plaintext highlighter-rouge">app/config.py</code></a>
            <ul>
              <li><a href="#配置文件appconfigpy"><em>配置文件app/config.py</em></a></li>
            </ul>
          </li>
          <li><a href="#2-添加扩展类库">(2) 添加扩展类库</a>
            <ul>
              <li><a href="#appextensionspy-中导入扩展并初始化"><code class="language-plaintext highlighter-rouge">app/extensions.py</code> 中导入扩展并初始化</a></li>
            </ul>
          </li>
          <li><a href="#3-配置蓝图-在蓝图中增加路由">(3) 配置蓝图, 在蓝图中增加路由</a>
            <ul>
              <li><a href="#appviews-下创建蓝本">app/views/ 下创建蓝本</a></li>
              <li><a href="#创建-appviews__init__py">创建 <code class="language-plaintext highlighter-rouge">app/views/__init__.py</code></a></li>
            </ul>
          </li>
          <li><a href="#4-初始化配置--app__init__py">(4) 初始化配置  <code class="language-plaintext highlighter-rouge">app/__init__.py</code></a></li>
          <li><a href="#5-创建项目基础模板">(5) 创建项目基础模板</a>
            <ul>
              <li><a href="#在-apptemplatescommon-中创建basehtml-是最基本的模板">在 app/templates/common 中创建base.html 是最基本的模板</a></li>
              <li><a href="#创建-404-模板-templateserrors404page">创建 404 模板 templates/errors/404.page</a></li>
              <li><a href="#在-apptemplatesmain-中创建-indexhtml-继承-basehtml">在 app/templates/main 中创建 index.html 继承 base.html</a></li>
              <li><a href="#在-appviewsmainpy-中创建路由-调用-indexhtml">在 app/views/main.py 中创建路由 调用 index.html</a></li>
            </ul>
          </li>
          <li><a href="#6-managepy-中-调用-create_app函数-然后启动">(6) <code class="language-plaintext highlighter-rouge">manage.py</code> 中 调用 create_app函数, 然后启动</a></li>
          <li><a href="#邮件发送">邮件发送</a></li>
          <li><a href="#用户管理模块">用户管理模块</a>
            <ul>
              <li><a href="#用户注册-登录-找回密码-修改密码-个人中心">用户注册, 登录, 找回密码, 修改密码, 个人中心</a></li>
              <li><a href="#执行数据迁移命令"><em>执行数据迁移命令</em></a></li>
            </ul>
          </li>
          <li><a href="#用户登录认证">用户登录认证</a></li>
          <li><a href="#flask_login总结">flask_login总结</a>
            <ul>
              <li><a href="#换头像的代码">换头像的代码:</a></li>
            </ul>
          </li>
          <li><a href="#博客管理">博客管理:</a></li>
          <li><a href="#分页功能--flask_sqlalchemy-的--paginate-扩展包">分页功能- flask_SQLalchemy 的  <code class="language-plaintext highlighter-rouge">paginate</code> 扩展包</a>
            <ul>
              <li><a href="#分页查询介绍paginate">分页查询介绍:paginate</a></li>
              <li><a href="#将分页封装做成一个宏-用于显示分页条">将分页封装做成一个宏, 用于显示分页条</a></li>
            </ul>
          </li>
          <li><a href="#博客收藏功能重点---表的多对多关系">博客收藏功能:重点 - 表的多对多关系</a>
            <ul>
              <li><a href="#收藏博客实现步骤">收藏博客实现步骤</a></li>
            </ul>
          </li>
          <li><a href="#项目总结">项目总结:</a></li>
        </ul>
      </li>
      <li><a href="#restful-api-开发">RESTFul API 开发</a>
        <ul>
          <li><a href="#概念">概念:</a></li>
          <li><a href="#原生实现">原生实现</a>
            <ul>
              <li><a href="#get请求--获取所有资源">GET请求- 获取所有资源</a></li>
              <li><a href="#get-请求---获取指定资源">GET 请求 - 获取指定资源</a></li>
              <li><a href="#post-创建新的资源">POST 创建新的资源</a></li>
              <li><a href="#put-修改指定资源">PUT 修改指定资源</a></li>
              <li><a href="#delete-删除指定资源">DELETE 删除指定资源</a></li>
              <li><a href="#错误定制">错误定制</a></li>
              <li><a href="#身份认证">身份认证</a></li>
              <li><a href="#完整代码">完整代码</a></li>
            </ul>
          </li>
          <li><a href="#flask-restful-实现restful">flask-restful 实现RestFul</a>
            <ul>
              <li><a href="#安装-1">安装:</a></li>
              <li><a href="#完整代码-1">完整代码</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#flask-项目部署">Flask 项目部署</a>
        <ul>
          <li><a href="#nginx-安装">nginx 安装</a></li>
          <li><a href="#1配置nginx-虚拟主机">(1)配置Nginx 虚拟主机</a></li>
          <li><a href="#2添加博客内容">(2)添加博客内容</a></li>
          <li><a href="#3安装-uwsgi">(3)安装 uWSGI</a>
            <ul>
              <li><a href="#配置参数">配置参数:</a></li>
              <li><a href="#wsgi-以-http-启动方法">WSGI 以 http 启动方法:</a></li>
              <li><a href="#wsgi-以-socket-启动">WSGI 以 socket 启动:</a></li>
            </ul>
          </li>
          <li><a href="#静态文件处理">静态文件处理</a></li>
          <li><a href="#流程回顾">流程回顾:</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
                    </div>
                
                <!-- End Toc -->
                <p>Flask是一个轻量级的WSGI Web应用程序框架。它旨在快速轻松地入门，并能够扩展到复杂的应用程序。它最初是围绕Werkzeug和Jinja的简单包装器，现已成为最流行的Python Web应用程序框架之一。本文我会循序渐进的介绍 Flask 一些常用的 web 开发技巧。</p>

<h1 id="flask-框架">Flask 框架</h1>

<h2 id="开发技巧">开发技巧</h2>

<h3 id="chrome-快捷键">Chrome 快捷键</h3>

<p>cmd + shift+ delete: 清除浏览器缓存</p>

<p>cmd + option + u : 查看页面原代码</p>

<p>cmd + option + j : 查看页面console</p>

<p>cmd + option + i : developer tools</p>

<h3 id="pychar-快捷键">pychar 快捷键</h3>

<p>双击 shift 可以快速找到想要找的文件</p>

<p>cmd + option + L : 代码快速格式化</p>

<p>cmd + fn + 左右 : 到代码的第一行和最后一行</p>

<p>cmd + shift + <code class="language-plaintext highlighter-rouge">[</code> <code class="language-plaintext highlighter-rouge">]</code>  上一个tab, 下一个 tab.</p>

<p>cmd + option + 左右  上一个,下一个修改点</p>

<h3 id="资源信息">资源信息</h3>

<p><a href="http://flask.pocoo.org">官网</a></p>

<p><a href="http://www.pythondoc.com/flask/">中文官网</a></p>

<p>python命令行查看帮助</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">flask</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">make_response</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">redirect</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">flask</span><span class="o">.</span><span class="n">Blueprint</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="flask-script-监控代码修改-配合谷歌浏览器自动刷新方案-四步">flask-script 监控代码修改, 配合谷歌浏览器自动刷新方案 四步</h3>

<p>(1) 在谷歌浏览器上安装插件 <code class="language-plaintext highlighter-rouge">Easy Auto Refresh</code></p>

<p>(2) 安装flash-script 扩展包 <code class="language-plaintext highlighter-rouge">pip3.7 install flask-script</code></p>

<p><strong>flask-script 简介:</strong></p>

<ul>
  <li>flask-script 是一个 flask 终端解析器, 可以在命令行启动app 并指定相应的参数</li>
  <li>因为参数是从命令行走的, 所以代码中就不需要指定参数了, 这样就可以做到让代码可以从测试环境部署到生产环境时不改任何代码.</li>
  <li>是通过传递不同的启动参数完成的.</li>
  <li>需要 pip 安装</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-script
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 修改代码, 让 Manager 代替app run</p>

<p><em>只增加2行代码, 替换一行代码即可实现</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c"># flask-script 让代码可以从测试环境部署到生产环境时不改任何代码</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c"># 要将 app作为参数</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c"># 命令行执行:   python3.6 manager.py runserver</span>
<span class="c"># 查看帮助信息: python3.6 manager.py runserver --help</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>(4) 启动flask 服务, 并开始刷新谷歌浏览器</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.6 index.py runserver -d -r --threaded
</pre></td></tr></tbody></table>
</div>
</div>

<p>参数</p>

<ul>
  <li>
    <p>-h –host # 指定主机</p>
  </li>
  <li>
    <p>-p –port  # 指定端口</p>
  </li>
  <li>
    <p>-d          # debug模式</p>
  </li>
  <li>
    <p>-r          # 监控代码自动加载</p>
  </li>
  <li>
    <p>–threaded  # 多线程模式</p>
  </li>
  <li>
    <p>–help -?   # 帮助信息</p>
  </li>
  <li>
    <div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre>python3.6 index.py runserver --help
usage: index.py runserver <span class="o">[</span>-?] <span class="o">[</span>-h HOST] <span class="o">[</span>-p PORT] <span class="o">[</span>--threaded]
                          <span class="o">[</span>--processes PROCESSES] <span class="o">[</span>--passthrough-errors] <span class="o">[</span>-d]
                          <span class="o">[</span>-D] <span class="o">[</span>-r] <span class="o">[</span>-R] <span class="o">[</span>--ssl-crt SSL_CRT]
                          <span class="o">[</span>--ssl-key SSL_KEY]

Runs the Flask development server i.e. app.run<span class="o">()</span>

optional arguments:
  -?, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  -h HOST, --host HOST
  -p PORT, --port PORT
  --threaded
  --processes PROCESSES
  --passthrough-errors
  -d, --debug           <span class="nb">enable </span>the Werkzeug debugger <span class="o">(</span>DO NOT use <span class="k">in </span>production
                        code<span class="o">)</span>
  -D, --no-debug        disable the Werkzeug debugger
  -r, --reload          monitor Python files <span class="k">for </span>changes <span class="o">(</span>not 100% safe <span class="k">for
                        </span>production use<span class="o">)</span>
  -R, --no-reload       <span class="k">do </span>not monitor Python files <span class="k">for </span>changes
  --ssl-crt SSL_CRT     Path to ssl certificate
  --ssl-key SSL_KEY     Path to ssl key

</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h3 id="apploggerinfo-配合-flask-script-输出log-信息"><code class="language-plaintext highlighter-rouge">app.logger.info</code> 配合 flask-script 输出log 信息</h3>

<p><a href="https://www.polarxiong.com/archives/Flask使用日志记录到文件示例.html">更多日志输出教程</a></p>

<p>在代码任意位置写上 app.logger.info , 就可以在终端中输出info 信息.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'info log'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">'warning log'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><code class="language-plaintext highlighter-rouge">logging</code>的级别主有</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">NOTSET</code>、</li>
  <li><code class="language-plaintext highlighter-rouge">DEBUG</code>、</li>
  <li><code class="language-plaintext highlighter-rouge">INFO</code>、</li>
  <li><code class="language-plaintext highlighter-rouge">WARNING</code>、</li>
  <li><code class="language-plaintext highlighter-rouge">ERROR</code></li>
  <li><code class="language-plaintext highlighter-rouge">CRITICAL</code></li>
</ul>

<h3 id="flask-框架扩展包和使用图示">Flask 框架扩展包和使用图示</h3>

<p><img src="/Users/dalong/Library/Mobile Documents/com~apple~CloudDocs/python1702笔记/flask.jpg" alt="flask" /></p>

<h2 id="flask-框架介绍">Flask 框架介绍</h2>

<p>简介:</p>

<ul>
  <li>非常小的一个Python web框架, 被称为微型框架</li>
  <li>只提供了强健的核心, 其他功能通过扩展功能实现</li>
  <li>这意味着你可以根据项目需要进行量身定制</li>
</ul>

<p>组成:</p>

<ul>
  <li>调试, 路由, WSGI系统</li>
  <li>模板引擎 (jinja2, flask 核心人员开发)</li>
</ul>

<p>MVC:</p>

<ul>
  <li>M: Model 模型,既数据</li>
  <li>V: View: 视图.</li>
  <li>C: Controller, 控制器</li>
</ul>

<p>MTV:</p>

<ul>
  <li>Model 模型,既数据</li>
  <li>Ttemplate 模板, 负责显示</li>
  <li>View function 视图函数</li>
</ul>

<h2 id="flask-安装和使用">Flask 安装和使用</h2>

<p>(1). pip 安装 flask</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2). pycharm 创建一个flask 项目</p>

<p><strong>注意: 项目目录名字不能叫做 flask ,否则python import flask 时会找项目目录,而不是找类库</strong></p>

<p>(3). 创建一个视图函数文件<code class="language-plaintext highlighter-rouge">index.py</code> 并写如下代码:</p>

<p><strong>注意: 不要将应用的名字起名为 flask.py, 否则会和框架冲突</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="c">#创建一个flask 应用, 名字可以随意 , 比如可以是bpp, 但是后面所有的app 都要改成bpp.</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span> 	<span class="c">#这里的 __name__ 就是 字符串 "__main__"</span>


<span class="c"># 根目录路由的处理方式</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>  		
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="k">return</span> <span class="s">'Hello World!'</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>			<span class="c">#运行应用</span>
<span class="c">#    app.run(debug=True, threaded=True, host='0.0.0.0', port=5050)</span>
    
<span class="c">#run 输出如下:</span>
<span class="c"># * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="启动参数配置信息">启动参数/配置信息</h2>

<p><a href="http://www.pythondoc.com/exploreflask/configuration.html">更多配置信息的使用技巧</a></p>

<table>
  <thead>
    <tr>
      <th>启动参数</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>debug=True</td>
      <td>开启调试模式 (生产环境需要关闭). 代码修改会自动重启服务</td>
    </tr>
    <tr>
      <td>threaded=True</td>
      <td>是否开启多线程, 默认不开启</td>
    </tr>
    <tr>
      <td>host</td>
      <td>指定主机. 设置成 ‘0.0.0.0’ 可以通过内网IP进行访问</td>
    </tr>
    <tr>
      <td>port</td>
      <td>指定端口</td>
    </tr>
  </tbody>
</table>

<p><em>三种 <code class="language-plaintext highlighter-rouge">debug=True</code> 的设置方法</em> 同样适用于 <code class="language-plaintext highlighter-rouge">threaded=True</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DEBUG'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span> <span class="c"># 也可以定义到一个 config.py文件中,然后被调用(每行一个配置)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s">'myconfig.cfg'</span><span class="p">)</span> <span class="c">#还可以定义在文件中 配置中要有 DEBUG = True</span>
<span class="c"># 但是如果想用 .from_pyfile() 必须提前设定app = Flask(__name__, instance_relative_config=True)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>config.py 内容如下:</em></p>

<ul>
  <li>前提是要在视图文件中设置 app.config.from_object(‘config’)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>
<span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>
<span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="s">'xxxxxxx'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>flask 默认配置 - 源代码 (app.py)</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre> <span class="c">#: Default configuration parameters.</span>
    <span class="n">default_config</span> <span class="o">=</span> <span class="n">ImmutableDict</span><span class="p">({</span>
        <span class="s">'DEBUG'</span><span class="p">:</span>                                <span class="n">get_debug_flag</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="s">'TESTING'</span><span class="p">:</span>                              <span class="bp">False</span><span class="p">,</span>
        <span class="s">'PROPAGATE_EXCEPTIONS'</span><span class="p">:</span>                 <span class="bp">None</span><span class="p">,</span>
        <span class="s">'PRESERVE_CONTEXT_ON_EXCEPTION'</span><span class="p">:</span>        <span class="bp">None</span><span class="p">,</span>
        <span class="s">'SECRET_KEY'</span><span class="p">:</span>                           <span class="bp">None</span><span class="p">,</span>
        <span class="s">'PERMANENT_SESSION_LIFETIME'</span><span class="p">:</span>           <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">31</span><span class="p">),</span>
        <span class="s">'USE_X_SENDFILE'</span><span class="p">:</span>                       <span class="bp">False</span><span class="p">,</span>
        <span class="s">'LOGGER_NAME'</span><span class="p">:</span>                          <span class="bp">None</span><span class="p">,</span>
        <span class="s">'LOGGER_HANDLER_POLICY'</span><span class="p">:</span>               <span class="s">'always'</span><span class="p">,</span>
        <span class="s">'SERVER_NAME'</span><span class="p">:</span>                          <span class="bp">None</span><span class="p">,</span>
        <span class="s">'APPLICATION_ROOT'</span><span class="p">:</span>                     <span class="bp">None</span><span class="p">,</span>
        <span class="s">'SESSION_COOKIE_NAME'</span><span class="p">:</span>                  <span class="s">'session'</span><span class="p">,</span>
        <span class="s">'SESSION_COOKIE_DOMAIN'</span><span class="p">:</span>                <span class="bp">None</span><span class="p">,</span>
        <span class="s">'SESSION_COOKIE_PATH'</span><span class="p">:</span>                  <span class="bp">None</span><span class="p">,</span>
        <span class="s">'SESSION_COOKIE_HTTPONLY'</span><span class="p">:</span>              <span class="bp">True</span><span class="p">,</span>
        <span class="s">'SESSION_COOKIE_SECURE'</span><span class="p">:</span>                <span class="bp">False</span><span class="p">,</span>
        <span class="s">'SESSION_REFRESH_EACH_REQUEST'</span><span class="p">:</span>         <span class="bp">True</span><span class="p">,</span>
        <span class="s">'MAX_CONTENT_LENGTH'</span><span class="p">:</span>                   <span class="bp">None</span><span class="p">,</span>
        <span class="s">'SEND_FILE_MAX_AGE_DEFAULT'</span><span class="p">:</span>            <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="s">'TRAP_BAD_REQUEST_ERRORS'</span><span class="p">:</span>              <span class="bp">False</span><span class="p">,</span>
        <span class="s">'TRAP_HTTP_EXCEPTIONS'</span><span class="p">:</span>                 <span class="bp">False</span><span class="p">,</span>
        <span class="s">'EXPLAIN_TEMPLATE_LOADING'</span><span class="p">:</span>             <span class="bp">False</span><span class="p">,</span>
        <span class="s">'PREFERRED_URL_SCHEME'</span><span class="p">:</span>                 <span class="s">'http'</span><span class="p">,</span>
        <span class="s">'JSON_AS_ASCII'</span><span class="p">:</span>                        <span class="bp">True</span><span class="p">,</span>
        <span class="s">'JSON_SORT_KEYS'</span><span class="p">:</span>                       <span class="bp">True</span><span class="p">,</span>
        <span class="s">'JSONIFY_PRETTYPRINT_REGULAR'</span><span class="p">:</span>          <span class="bp">True</span><span class="p">,</span>
        <span class="s">'JSONIFY_MIMETYPE'</span><span class="p">:</span>                     <span class="s">'application/json'</span><span class="p">,</span>
        <span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">:</span>                <span class="bp">None</span><span class="p">,</span>
    <span class="p">})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="请求和响应">请求和响应</h2>

<p>变量或对象</p>

<table>
  <thead>
    <tr>
      <th>变量/对象</th>
      <th>上下文__<strong>__</strong>__</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>current_app</td>
      <td>程序上下文</td>
      <td>代表当前运行的实例app 名, 也就是文件名(去掉.py)</td>
    </tr>
    <tr>
      <td>g</td>
      <td>程序上下文</td>
      <td>处理请求用到的临时变量, 不同页面都可以使用(设置和获取). 每次请求会重置该变量</td>
    </tr>
    <tr>
      <td>request</td>
      <td>请求上下文</td>
      <td>请求对象, 所有和HTTP请求信息都在request中.保存了客户端HTTP请求的信息.</td>
    </tr>
    <tr>
      <td>session</td>
      <td>请求上下文</td>
      <td>用户会话, 用于保存需要被’记住’的会话信息.</td>
    </tr>
  </tbody>
</table>

<p><em>测试current_app, 文件名为 <code class="language-plaintext highlighter-rouge">testEnv.py</code></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">current_app</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello, </span><span class="si">%</span><span class="s">s!'</span> <span class="o">%</span> <span class="n">current_app</span><span class="o">.</span><span class="n">name</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c"># 输出为 Hello, testEnv!</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="请求钩子函数">请求钩子函数</h2>

<p>在特定场景被触发的装饰器函数</p>

<table>
  <thead>
    <tr>
      <th>钩子函数</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>@app.before_first_request</td>
      <td>第一次请求之间调用的函数</td>
    </tr>
    <tr>
      <td>@app.before_request</td>
      <td>每次请求之前都调用的函数</td>
    </tr>
    <tr>
      <td>@app.after_request</td>
      <td>每次请求之后调用. 前提是没有异常</td>
    </tr>
    <tr>
      <td>@app.teardown_rquest</td>
      <td>每次请求之后调用, 即使有异常页调用</td>
    </tr>
  </tbody>
</table>

<h2 id="视图函数">视图函数</h2>

<h3 id="路由介绍-approute">路由介绍 <code class="language-plaintext highlighter-rouge">@app.route()</code></h3>

<p>使用说明:</p>

<ol>
  <li>路由末尾的 <code class="language-plaintext highlighter-rouge">/</code> 最好还是加上, 防止路由错误</li>
  <li>如果路由需要指定参数, 那么参数需要写在 <code class="language-plaintext highlighter-rouge">&lt;&gt;</code> 中, 且该参数名子需要在绑定的函数的参数名一致</li>
  <li>如果参数需要指定数据类型(int/float/path/string),那么类型需要写在参数前面, 且用冒号隔开 <code class="language-plaintext highlighter-rouge">&lt;int:uid&gt;</code></li>
  <li>如果不指定参数类型, 默认就是 string</li>
  <li>path 类型其实也是字符串类型, 只不过 不把 <code class="language-plaintext highlighter-rouge">/</code> 作为分割符</li>
</ol>

<p><em><code class="language-plaintext highlighter-rouge">无</code>参数路由</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
  <span class="k">return</span> <span class="s">'&lt;h1&gt;你好&lt;/h1&gt;'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>单参数路由</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/welcome/&lt;name&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'你好</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">name</span>

<span class="c"># 调用方法 http://127.0.0.1:5000/welcome/dalong</span>
<span class="c"># 页面输出: 你好dalong</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>多参数路由</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/ma/&lt;name&gt;/&lt;age&gt;/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ma</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'</span><span class="si">%</span><span class="s">s and </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">)</span>
<span class="c">#调用: http://127.0.0.1:5000/ma/dalong/15</span>
<span class="c">#输出: dalong and 15</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>todo 参数默认值</p>

<p><em>指定参数类型</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c"># 指定参数类型, 默认是 string, 还可以是 int, float, path</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/user/&lt;int:uid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"</span><span class="si">%</span><span class="s">d 号用户"</span> <span class="o">%</span><span class="n">uid</span>
<span class="c">#调用方法: http://127.0.0.1:5000/user/1</span>
<span class="c">#输出: 1 号用户</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>path 类型参数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c"># path类型, 其实仍然是字符串, 只是'/' 不再是分隔符</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/path/&lt;path:p&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"路径是 </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span><span class="n">p</span>
  
<span class="c">#调用方法: http://127.0.0.1:5000/path/1/2/3/4</span>
<span class="c">#输出 : 路径是 1/2/3/4</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>万能路由的例子</em></p>

<ul>
  <li>任何网址都可以进入这个页面</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">werkzeug.routing</span> <span class="kn">import</span> <span class="n">BaseConverter</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RegexConverter</span><span class="p">(</span><span class="n">BaseConverter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="s">'regex'</span><span class="p">]</span> <span class="o">=</span> <span class="n">RegexConverter</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;regex(r"[</span><span class="err">\</span><span class="s">w</span><span class="err">\</span><span class="s">W]*"):url&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'万能路由'</span> <span class="o">+</span> <span class="n">url</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="获取客户端请求request-信息--requestxxx">获取客户端请求(<code class="language-plaintext highlighter-rouge">request</code>) 信息.  <code class="language-plaintext highlighter-rouge">request.xxx()</code></h3>

<p>首先要 import</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>定义路由</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>from flask import request
@app.route<span class="o">(</span><span class="s1">'/request/'</span><span class="o">)</span>
def req<span class="o">()</span>:  <span class="c"># 定义的函数名必须是  req()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>不同request 的详细说明</em></p>

<ul>
  <li>http://127.0.0.1:5000/cat1/cat2/cat3/?a=1&amp;b=2&amp;c=3 为例</li>
</ul>

<table>
  <thead>
    <tr>
      <th>request 类型</th>
      <th>输出样式</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>request.url</td>
      <td>http://127.0.0.1:5000/cat1/cat2/cat3/?a=1&amp;b=2&amp;c=3</td>
      <td>是完整的url , 不包含?号 后面get 参数</td>
    </tr>
    <tr>
      <td>request.base_url</td>
      <td>http://127.0.0.1:5000/cat1/cat2/cat3/</td>
      <td>是base url, 不包含任何路径信息</td>
    </tr>
    <tr>
      <td>request.path</td>
      <td>/cat1/cat2/cat3/</td>
      <td>只是装饰器中的路径, 不含base url , request</td>
    </tr>
    <tr>
      <td>request.method</td>
      <td>GET</td>
      <td>返回http请求类型GET/POST</td>
    </tr>
    <tr>
      <td>request.host</td>
      <td>127.0.0.1:5000</td>
      <td>获取访问者的IP地址 127.0.0.1:5000</td>
    </tr>
    <tr>
      <td>request.args</td>
      <td>ImmutableMultiDict([(‘a’, ‘1’), (‘b’, ‘2’), (‘c’, ‘3’)])</td>
      <td>获取get信息中的某个参数</td>
    </tr>
    <tr>
      <td>request.headers</td>
      <td>一大堆, 看下面的例子</td>
      <td>获取客户端的请求的头信息, 比如头信息中的 User-Agent</td>
    </tr>
    <tr>
      <td>request.environ</td>
      <td><code class="language-plaintext highlighter-rouge">{'wsgi.version': (1, 0), 'wsgi.url_scheme': 'http', 'wsgi.input': &lt;_io.BufferedReader name=7&gt;, 'wsgi.errors': &lt;_io.TextIOWrapper name='&lt;stderr&gt;' mode='w' encoding='UTF-8'&gt;, 'wsgi.multithread': True, 'wsgi.multiprocess': False, 'wsgi.run_once': False, 'werkzeug.server.shutdown': &lt;function WSGIRequestHandler.make_environ.&lt;locals&gt;.shutdown_server at 0x10dc61f28&gt;, 'SERVER_SOFTWARE': 'Werkzeug/0.13', 'REQUEST_METHOD': 'GET', 'SCRIPT_NAME': '', 'PATH_INFO': '/cat1/cat2/cat3/', 'QUERY_STRING': 'a=1&amp;b=2&amp;c=3', 'REMOTE_ADDR': '127.0.0.1', 'REMOTE_PORT': 57839, 'SERVER_NAME': '127.0.0.1', 'SERVER_PORT': '5000', 'SERVER_PROTOCOL': 'HTTP/1.1', 'HTTP_HOST': '127.0.0.1:5000', 'HTTP_CONNECTION': 'keep-alive', 'HTTP_CACHE_CONTROL': 'max-age=0', 'HTTP_USER_AGENT': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.108 Safari/537.36', 'HTTP_UPGRADE_INSECURE_REQUESTS': '1', 'HTTP_ACCEPT': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate, br', 'HTTP_ACCEPT_LANGUAGE': 'zh-CN,zh;q=0.9', 'HTTP_COOKIE': 'session=eyJjc3JmX3Rva2VuIjoiNGZkNTE0OTBhMGNlOGMyYjg0YWY3ODllMjFhNjdiOTU0ZTE4ZmM0ZCIsIm5hbWUiOiJkYWxvbmcifQ.DS-T-A.N8xYS4q8ApBWqBXDpB21OtOH1uk', 'werkzeug.request': &lt;Request 'http://127.0.0.1:5000/cat1/cat2/cat3/?a=1&amp;b=2&amp;c=3' [GET]&gt;}</code></td>
      <td>环境变量</td>
    </tr>
    <tr>
      <td>request.form</td>
      <td>ImmutableMultiDict([])</td>
      <td> </td>
    </tr>
    <tr>
      <td>request.cookies</td>
      <td>{‘session’: ‘eyJjc3JmX3Rva2VuIjoiNGZkNTE0OTBhMGNlOGMyYjg0YWY3ODllMjFhNjdiOTU0ZTE4ZmM0ZCIsIm5hbWUiOiJkYWxvbmcifQ.DS-T-A.N8xYS4q8ApBWqBXDpB21OtOH1uk’}</td>
      <td> </td>
    </tr>
    <tr>
      <td>request.charset</td>
      <td>utf-8</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><em>下面文件的请求地址 : http://127.0.0.1:5000/ma/dalong/16/</em></p>

<p><em>或者 : http://127.0.0.1:5000/ma/dalong/16/?a=1&amp;b=2</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/ma/&lt;string:name&gt;/&lt;int:age&gt;/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ma</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>  	<span class="c"># 是完整的url , 不包含?号 后面get 参数</span>
<span class="c"># 输出: http://127.0.0.1:5000/ma/dalong/15/</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">base_url</span> <span class="c"># 是base url, 不包含任何路径信息</span>
<span class="c"># 输出: http://127.0.0.1:5000/ma/dalong/15/</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> 	<span class="c"># 只是装饰器中的路径, 不含base url , request</span>
<span class="c"># 输出: /ma/dalong/15/</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>  	<span class="c"># 返回http请求类型GET/POST</span>
<span class="c"># 输出 GET</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span>  	<span class="c"># 获取访问者的IP地址 127.0.0.1:5000</span>
<span class="c"># 输出 127.0.0.1:5000</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s">'a'</span><span class="p">]</span> 	<span class="c"># 获取get信息中的某个参数</span>
<span class="c">#http://127.0.0.1:5000/ma/dalong/16/?a=1&amp;b=2</span>
<span class="c"># 1</span>
<span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 	<span class="c"># 获取get信息中的所有参数</span>
<span class="c">#http://127.0.0.1:5000/ma/dalong/16/?a=1&amp;b=2</span>
<span class="c">#输出: ImmutableMultiDict([('a', '1'), ('b', '2')])</span>
<span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'User-Agent'</span><span class="p">]</span>  <span class="c">#获取客户端请求的头User-Agent 信息</span>
<span class="c">#输出: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.108 Safari/537.36</span>
<span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span> <span class="c"># 获得所有头信息</span>
<span class="c">#输出: Host: 127.0.0.1:5000 Connection: keep-alive Cache-Control: max-age=0 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.108 Safari/537.36 Upgrade-Insecure-Requests: 1 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8 Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.9 Cookie: name=dalong; session=eyJ1c2VybmFtZSI6Ilx1NTkyN1x1OWY5OSJ9.DSzR_w.Ikn8WTP2wiNKFPrWKc0xKtfUZM8; class=1702</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="响应response-的处理函数-make_response">响应(response) 的处理函数 <code class="language-plaintext highlighter-rouge">make_response()</code></h3>

<p><a href="https://baike.baidu.com/item/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/5053660?fr=aladdin">http 状态码</a></p>

<ul>
  <li>1xx 处理中</li>
  <li>2xx 成功</li>
  <li>3xx 跳转</li>
  <li>4xx 客户端错误</li>
  <li>5xx 服务端错误</li>
</ul>

<p>如果需要构造响应, 需要先<code class="language-plaintext highlighter-rouge">from flask import make_response</code> 包</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/response/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">response</span><span class="p">():</span>
    <span class="c"># return 'OK' 											# 最基本响应</span>
    <span class="c"># return 'Page 没找到啊', 404  	    	 				 # 指定状态码</span>
    <span class="c"># resp = make_response('我是构造响应', 404); return resp  # 使用函数构造响应.</span>
    
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">'我是构造响应'</span><span class="p">,</span> <span class="mi">404</span><span class="p">);</span> <span class="k">return</span> <span class="n">resp</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="重定向-redirect">重定向 <code class="language-plaintext highlighter-rouge">redirect()</code></h3>

<p>先要<code class="language-plaintext highlighter-rouge">from flask import redirect</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/redirect/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/new/'</span><span class="p">)</span>
    <span class="c">#return '老旧内容'</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/new/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"新的页面"</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="通过函数名找到路由-url_for">通过函数名找到路由 <code class="language-plaintext highlighter-rouge">url_for()</code></h3>

<p>通过视图函数名,找到函数对应的装饰器的参数.</p>

<ul>
  <li>首先导入 <code class="language-plaintext highlighter-rouge">from flask import url_for</code></li>
  <li>传递的参数 <code class="language-plaintext highlighter-rouge">return url_for('old')</code> 需要是另一个函数的名字</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/redirect/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/new/'</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/new/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'old'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>另一种方法: 找路由并带上参数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/redirect/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'welcome'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'dalong'</span><span class="p">))</span>
    <span class="c">#return '老旧内容'</span>

<span class="c"># 指定普通参数的路由</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/welcome/&lt;name&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'你好</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="n">name</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="异常终止客户请求-abort500">异常终止客户请求 <code class="language-plaintext highlighter-rouge">abort(500)</code></h3>

<p>通过flask 框架 传递异常参数(404,500等)给页面,让页面输出浏览器默认的异常页面.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/error/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">error</span><span class="p">():</span>
    <span class="c"># 框架会通过传递的参数,提前给出既定的报错信息.</span>
    <span class="c"># abort(404) # 模拟404错误</span>
    <span class="c"># abort(500) # 模拟</span>
    <span class="c"># return '出错了'</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="定制页面报错信息-errorhandler404">定制页面报错信息 <code class="language-plaintext highlighter-rouge">errorhandler(404)</code></h3>

<p>一旦定制页面报错信息(404), 定制后, app中任何404都会走这个函数</p>

<ul>
  <li>应该也可以定制500, 200</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c"># 定制404, 定制后, app中任何404都会走这里</span>
<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'大哥,报错了'</span>
<span class="c">#请求方法: http://127.0.0.1:5000/abcd</span>
<span class="c">#页面输出: 大哥,报错了</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="会话控制-respset_cookie-requestcookiesget-sessionusername--大龙-sessionget">会话控制 <code class="language-plaintext highlighter-rouge">resp.set_cookie, request.cookies.get()</code> <code class="language-plaintext highlighter-rouge">session['username'] = '大龙', session.get()</code></h3>

<p>首先讲一下Python的flask中session与cookies的关系</p>

<ul>
  <li>php 的 session是储存在服务器中的，cookies是储存在浏览器本地中</li>
  <li>flask的session与cookies，session是经过加密保存在cookies中。</li>
  <li>在flask中使用session需要先设置<code class="language-plaintext highlighter-rouge">secret_key</code>，根据算法加密session信息</li>
  <li>如果你设置了 <code class="language-plaintext highlighter-rouge">Flask.secret_key</code> ，你可以在 Flask 应用中使用会话。</li>
  <li>会话主要使得在页面跳转过程中保留信息成为可能。 Flask 的实现方法是使用一个签名的 cookie 。 这样，用户可以查看会话的内容，但是不能修改它，除非用户知道密钥。所以确保密钥被设置为一个复杂且无法被容易猜测的值。</li>
  <li>之所以用 <code class="language-plaintext highlighter-rouge">cookies.get('name')</code> 而不是 <code class="language-plaintext highlighter-rouge">cookies['name']</code> 是因为 get() 函数就算拿不到信息也不会报错. <code class="language-plaintext highlighter-rouge">session.get()</code> 也是一个道理</li>
</ul>

<p><em>设置 , 获取 和 删除 Cookie</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c"># 设置 cookie</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/set_cookie/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_cookie</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">'cookie 已经设置了'</span><span class="p">)</span>
    <span class="n">exps</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">100</span> <span class="c"># 设置cookie 100秒后失效</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span><span class="s">'dalong'</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">exps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="c"># 获取 cookie</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/get_cookie/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_cookie</span><span class="p">():</span>
    <span class="c"># 客户再次请求, cookie 在客户的request中可以找到</span>
    <span class="c"># return request.cookies['name']</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'你是哪个二哥?'</span>

<span class="c"># 删除 cookie</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/del_cookie/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_cookie</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">'cookie 已经删除了'</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s">'class'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>

  
<span class="c">#使用方法:</span>
<span class="c"># http://127.0.0.1:5000/set_cookie/</span>
<span class="c"># http://127.0.0.1:5000/get_cookie/</span>
<span class="c"># http://127.0.0.1:5000/del_cookie/</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>获取所有cookie 信息</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'你是哪个二哥?'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>还可以同时设置cookie, render_template</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'userprofile.html'</span><span class="p">))</span>
<span class="n">resp</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="s">'the username'</span><span class="p">)</span>
<span class="k">return</span> <span class="n">resp</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>设置 获取 和 删除  sesison</em></p>

<ul>
  <li>设置session 必须先设置 安全秘钥</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span>
<span class="c"># 设置秘钥</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>  <span class="c"># 返回24个字节的用以加密的随机字符串</span>
<span class="c"># app.config['SECRET_KEY'] = '123456'</span>

<span class="c"># 设置 session</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/set_session/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_session</span><span class="p">():</span>
    <span class="n">session</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'大龙'</span>
    <span class="k">return</span> <span class="s">'session 已经设置'</span>

<span class="c"># 获取session</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/get_session/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'who are you'</span>

<span class="c"># 删除 session</span>
<span class="c">#可以直接使用session.pop('key',None) 即：</span>
<span class="c">#session.pop('name',None)</span>
<span class="c">#如果要删除session中所有数据使用：clear()即：</span>
<span class="c">#session.clear()</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/del_session/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_session</span><span class="p">():</span>
	<span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
	<span class="c"># session.pop('username',None)</span>
	<span class="k">return</span> <span class="s">"session 已经清空"</span>

<span class="c"># 请求方法 </span>
<span class="c"># http://127.0.0.1:5000/set_session/</span>
<span class="c"># http://127.0.0.1:5000/get_session/</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="todo-登录访问-login_required">todo 登录访问 <code class="language-plaintext highlighter-rouge">@login_required</code></h3>

<p><a href="http://www.pythondoc.com/flask-login/index.html">Flask-Login官方文档</a></p>

<p>Flask-Login 扩展可以很容易地实现登录系统。除了处理用户认证的细节，Flask-Login 提供给我们一个装饰器，它用来限制只允许登录的用户访问某些视图</p>

<p><em>一个登录过的用户才能够访问 /dashboard 路由。</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="c"># app.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">current_user</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/dashboard'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">account</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"account.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@app.route</code> 应该是外层的视图装饰器（换句话说，<code class="language-plaintext highlighter-rouge">@app.route</code> 应该在所有装饰器的最前面）。</li>
</ul>

<h3 id="todo-缓存-flask-cache-扩展">todo 缓存 <code class="language-plaintext highlighter-rouge">Flask-Cache</code> 扩展</h3>

<p><a href="http://pythonhosted.org/Flask-Cache/">Flask-Cache官方文档</a></p>

<p>目的:</p>

<ul>
  <li>将一些页面内容缓存,提高服务器的负载</li>
</ul>

<p>使用 Flask-Cache 扩展。这个扩展提供我们一个装饰器，我们可以在我们的首页视图上使用这个装饰器用来在一段时间内缓存响应。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="c"># app.py</span>

<span class="kn">from</span> <span class="nn">flask.ext.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">()</span>

<span class="c"># We'd normally include configuration settings in this call</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="nd">@cache.cached</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="c"># Make a few database calls to get the information we need</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s">'index.html'</span><span class="p">,</span>
        <span class="n">latest_posts</span><span class="o">=</span><span class="n">latest_posts</span><span class="p">,</span>
        <span class="n">recent_users</span><span class="o">=</span><span class="n">recent_users</span><span class="p">,</span>
        <span class="n">recent_photos</span><span class="o">=</span><span class="n">recent_photos</span>
    <span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="蓝图-blueprint-两步拆分视图函数">蓝图 <code class="language-plaintext highlighter-rouge">Blueprint</code> 两步拆分视图函数</h3>

<p>说明:</p>

<ul>
  <li>当代码越来越复杂, 将所有视图函数放在一个文件中会比较麻烦, 查找定位问题速度会降低. 如果能根据功能模块进行划分,并拆分到不同文件中会更有效率.</li>
</ul>

<p>步骤:</p>

<p>(1) 创建一个新的蓝图文件<code class="language-plaintext highlighter-rouge">reg.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>

<span class="c"># 创建应用, user 其实和app 是一样的对象</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'user'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span> <span class="c"># 第一个参数的名字要和app名字一致.</span>


<span class="c"># 添加路由</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'登录'</span>

<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/register/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'注册'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 然后在主文件中注册一个蓝图</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c"># 注册蓝图, 顺便可以指定路由的前缀</span>
<span class="kn">from</span> <span class="nn">reg</span> <span class="kn">import</span> <span class="n">user</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s">'/ur'</span><span class="p">)</span>

<span class="c">#访问方法: </span>
<span class="c">#http://127.0.0.1:5000/ur/register/</span>
<span class="c">#http://127.0.0.1:5000/ur/login/</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="完整的视图函数的例子-简单的注册登录登出代码">完整的视图函数的例子: 简单的注册,登录,登出代码</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="c"># 主页</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userId'</span><span class="p">)</span>
    <span class="n">userName</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userName'</span><span class="p">)</span>
    <span class="c"># print('获得的用户信息:',userId, userName)</span>
    <span class="k">if</span> <span class="n">userId</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'这是主页, 请 &lt;a href="/login/"&gt;登录&lt;/a&gt; 或&lt;a href="/register/"&gt;注册&lt;/a&gt;'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'你好 '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span> <span class="o">+</span> <span class="s">'&lt;a href="/logout/"&gt;退出登录&lt;/a&gt;'</span>


<span class="c"># 注册</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/register/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="c"># todo 省略注册的页面</span>
    <span class="c"># 生成 randint 数字, 写到cookie中.</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">'注册成功, 请进行&lt;a href="/login/"&gt;登录&lt;/a&gt;'</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">'userId'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">resp</span>

<span class="c"># 登录</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="c"># todo 省略登录页面</span>
    <span class="c"># 读 cookie, 写session</span>
    <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userId'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userId'</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/register/'</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s">'userId'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'userId'</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s">'userName'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'大龙'</span>
    <span class="k">return</span> <span class="s">'登录成功, session 设置完毕, 请回到&lt;a href="/"&gt;主页&lt;/a&gt;'</span>

<span class="c"># 登出</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/logout/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="c">#清除cookie 和 session</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">'您已经退出系统 &lt;a href="/"&gt;回到主页&lt;/a&gt;'</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s">'userId'</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5050</span><span class="p">)</span>


</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="模板引擎">模板引擎</h2>

<p>如果希望模板的修改自动加载,需要在视图函数中增加如下代码.</p>

<p>注意:</p>

<ul>
  <li>
    <p>先把DEBUG = True 打开</p>
  </li>
  <li>
    <p>在 flask-script 命令行模式下有效.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="模板引擎介绍">模板引擎介绍</h3>

<p>模板的概念:</p>

<blockquote>
  <p>模板文件就是按照特定的语法规则书写的,负责展示效果的HTML 文件</p>

  <p>模板引擎就是提供了规则的解析和替换的工具</p>
</blockquote>

<p>Jinja2:</p>

<blockquote>
  <p>Flask框架中使用的默认模板引擎, 是由 Flask 开发人员开发的.</p>
</blockquote>

<h3 id="jinja2的使用-from-flask-import-render_template-return-render_templateindexhtml">Jinja2的使用 <code class="language-plaintext highlighter-rouge">from flask import render_template</code> <code class="language-plaintext highlighter-rouge">return render_template('index.html')</code></h3>

<p>(1) 准备工作, 先项目根目录下创建一个模板文件夹 templates</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>project/			<span class="c">#项目根目录</span>
	templates/		<span class="c">#模板目录</span>
	testJinja2.py	<span class="c">#视图函数</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 在模板文件夹中创建一个<code class="language-plaintext highlighter-rouge">index.html</code> 模板文件</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>hello Jinja2 from template<span class="nt">&lt;/h1&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 在视图函数中 <code class="language-plaintext highlighter-rouge">from flask import render_template</code> or <code class="language-plaintext highlighter-rouge">from flask import render_template_string</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template_string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="c"># return render_template_string('&lt;h1&gt;hello Jinja2 from template string&lt;/h1&gt;')</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">)</span>
    <span class="c"># return 'Janja2 Hi'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">return render_template('index.html')</code> 负责渲染整个页面</li>
  <li><code class="language-plaintext highlighter-rouge">return render_template_string('&lt;h1&gt;hello Jinja2 from template string&lt;/h1&gt;')</code> 负责渲染页面局部内容</li>
</ul>

<p><em>render_template 接收任意多个参数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.txt'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="模板文件中的变量使用--变量--or--g变量-----逻辑块-----注释内容-">模板文件中的变量使用 <code class="language-plaintext highlighter-rouge">{{ 变量 }} or {{ g.变量 }}</code>   <code class="language-plaintext highlighter-rouge">{% 逻辑块 %}</code>   <code class="language-plaintext highlighter-rouge">{# 注释内容 #}</code></h3>

<p>Jinja有两种分隔符。<code class="language-plaintext highlighter-rouge">{% ... %}</code> 和 <code class="language-plaintext highlighter-rouge">{{ ... }}</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">{% 逻辑块 %}</code> 用于执行类似 for 循环或者赋值的声明，</li>
  <li><code class="language-plaintext highlighter-rouge">{{ 变量 }}</code> 用于输出表达的结果到模板中。</li>
  <li><code class="language-plaintext highlighter-rouge">{# 注释内容 #}</code></li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>hello Jinja2 from template<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;h2&gt;</span>你好 {{ name|upper }}<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;</span>这个g.name也行 {{ g.name }} g变量不需要分配<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;</span>这个是注释 {# 看不到 #}<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;br&gt;</span>
去掉html标签 {{ tags|safe }}
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template_string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'大龙'</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'dalong'</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s">'&lt;h2&gt;我带h2标签吗&lt;/h2&gt;'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="g-变量的使用"><code class="language-plaintext highlighter-rouge">g</code> 变量的使用*</h3>

<p>g 变量的好处是可以在视图函数和模板之间传递多个变量,而不用将g 转 return 的时候传递给模板.</p>

<p><em>用法</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'小龙'</span>
    <span class="n">g</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'testG_index.html'</span><span class="p">)</span>
<span class="c"># 模板中使用 : &lt;h2&gt;这个g.name也行 {{ g.name }} g变量不需要分配&lt;/h2&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>g 变量的赋值只能发生在路由函数中, 如果在外面就会报错.</li>
</ul>

<h3 id="在模板中对变量使用过滤器---变量upper-">在模板中对变量使用<strong>过滤器</strong>  <code class="language-plaintext highlighter-rouge">{{ 变量|upper }}</code></h3>

<p>过滤器是一个函数，它像linux 中的<strong>管道符</strong>, 能够在 <code class="language-plaintext highlighter-rouge">{{ ... }}</code> 中用于处理一个表达式的结果。在表达式结果输出到模板之前它就被调用。</p>

<p><em>用法如下</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{{ 变量|upper }}
{{ 变量|capitalize }}
{{ 变量|striptags }}
{{ 变量|safe }}
{{ g.name|replace('da','xiao')|title }}
</pre></td></tr></tbody></table>
</div>
</div>

<p>可用的过滤器函数</p>

<p><a href="http://jinja.pocoo.org/docs/templates/#builtin-filters">过滤器完整列表</a>。</p>

<table>
  <thead>
    <tr>
      <th>修饰函数</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>upper</td>
      <td>全大写</td>
    </tr>
    <tr>
      <td>lower</td>
      <td>全小写</td>
    </tr>
    <tr>
      <td>capitalize</td>
      <td>首字母大写</td>
    </tr>
    <tr>
      <td>title</td>
      <td>每个单词首字母大写</td>
    </tr>
    <tr>
      <td>trim</td>
      <td>去两边空白</td>
    </tr>
    <tr>
      <td>striptags</td>
      <td>过滤掉html标签.</td>
    </tr>
    <tr>
      <td>safe</td>
      <td>将变量带的html标签保留.如果不用safe, 默认变量中的html 标签会转义后展现在页面中. 但使用要谨慎.确保安全才能使用. 比如用户从表单提交的数据要严格禁止使用safe.</td>
    </tr>
    <tr>
      <td>abs</td>
      <td>数字的绝对值</td>
    </tr>
    <tr>
      <td>first/last</td>
      <td>获取可迭代数据的第一条, 最后一条</td>
    </tr>
    <tr>
      <td>format</td>
      <td>相当于 python 的 format函数</td>
    </tr>
    <tr>
      <td>min/max</td>
      <td>最大最小值</td>
    </tr>
    <tr>
      <td>map</td>
      <td>将一系列内容进行逐一处理. 比如 <code class="language-plaintext highlighter-rouge">{{ titles|map('lower')|join(', ') }}</code> 将titles数组进行小写,然后逗号分隔组成字符串</td>
    </tr>
    <tr>
      <td>replace</td>
      <td>替换字符串 <code class="language-plaintext highlighter-rouge">{{ "Hello World"|replace("Hello", "Goodbye") }}</code></td>
    </tr>
    <tr>
      <td>slice</td>
      <td>可迭代元素的切片</td>
    </tr>
    <tr>
      <td>join</td>
      <td>将迭代单元组合到一起. <code class="language-plaintext highlighter-rouge">{{ [1, 2, 3]|join('|') }}</code> -&gt; 1|2|3 , <code class="language-plaintext highlighter-rouge">{{ [1, 2, 3]|join }}</code> -&gt; 123</td>
    </tr>
  </tbody>
</table>

<h3 id="自定义过滤器">自定义过滤器</h3>

<p>我们可以在是视图函数中自定义过滤器, 用于将我们想要的效果作用域变量上.</p>

<p>语法:</p>

<ul>
  <li>使用 <code class="language-plaintext highlighter-rouge">@app.template_filter()</code> 装饰器来定义装饰器,然后在装饰器下面定义一个过滤器函数(普通python函数)</li>
  <li>如果装饰器定义了参数, 那么过滤器名字就是该参数. 如果装饰器没有参数,那么函数名就是过滤器的名字</li>
</ul>

<p><em>定义</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.template_filter</span><span class="p">(</span><span class="s">'rjusts'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rightjust</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">'-'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>{{ "abc"|rightjust }}
</pre></td></tr></tbody></table>
</div>
</div>

<p>输出效果: ——-abc</p>

<h3 id="模板中的流程控制和循环--if-name---for-i-in-range16-">模板中的流程控制和循环 <code class="language-plaintext highlighter-rouge">{% if name %}</code> <code class="language-plaintext highlighter-rouge">{% for i in range(1,6) %}</code></h3>

<p><em>分支结构</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{% if name %}
    <span class="nt">&lt;h1&gt;</span>hello {{ name }} 是if 判断中的<span class="nt">&lt;/h1&gt;</span>
{% else %}
    <span class="nt">&lt;h1&gt;</span>hello world<span class="nt">&lt;/h1&gt;</span>
{% endif %}
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'dalong'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>循环结构</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>{# 循环结构 #}
<span class="nt">&lt;ol&gt;</span>
{% for i in range(1,6) %}
    <span class="nt">&lt;li&gt;</span>{{ i }}<span class="nt">&lt;/li&gt;</span>
{% endfor %}
<span class="nt">&lt;/ol&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="模板中的文件包含-include-2html-">模板中的文件包含<code class="language-plaintext highlighter-rouge">{% include '2.html' %}</code></h3>

<p>可以提前把那些会被重复使用的html 内容定义到单独的文件中, 然后在jinja模板中将定义好的html文件包含进来</p>

<p><em>主模板文件</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>{% include '2.html' %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>被包含的模板文件2.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h2&gt;</span>这是被包含的文件2.html的内容<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="宏模板函数的定义和调用--macro-show_namename----show_namename-">宏(模板函数)的定义和调用 <code class="language-plaintext highlighter-rouge">{% macro show_name(name) %}</code>  <code class="language-plaintext highlighter-rouge">{{ show_name(name) }}</code></h3>

<p>宏相当于定义一个模板函数, 为函数传递一个参数, 然后函数返回一段固定的html内容</p>

<p>宏的目的:</p>

<ul>
  <li>我们模板中坚持 DRY（不要重复自己）的原则，通过抽象出重复出现的代码片段到 <strong>宏</strong> , 避免编写一大段 <code class="language-plaintext highlighter-rouge">if ... else</code>语句( 将 <code class="language-plaintext highlighter-rouge">if ... else</code> 写到宏里面去 )</li>
  <li>通常我们可以将特定的显示效果定义成宏, 然后在需要的地方导入即可. 避免相同效果的重复代码 .</li>
  <li>比如: 将很多使用了不同css样式和文字的 <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> 链接定义在宏里面, 然后根据需要在不同的地方通过参数进行调用.</li>
</ul>

<p>宏的原理:</p>

<ul>
  <li>宏采用类似python 函数定义的方法进行定义</li>
  <li>用 python 类似 import 的形式对宏进行调用.</li>
  <li>核函数类似的方法传递参数并进行调用.</li>
</ul>

<p><em>宏定义, 调用宏</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>{# 定义宏 #}
{% macro show_name(name) %}
    <span class="nt">&lt;h1&gt;</span>hello {{ name }} 这是宏里的内容<span class="nt">&lt;/h1&gt;</span>
{% endmacro %}

{# 调用宏 #}
{{ show_name(name) }}
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>定义宏用<code class="language-plaintext highlighter-rouge">{%%}</code></li>
  <li>调用宏用<code class="language-plaintext highlighter-rouge">{{}}</code></li>
  <li>调用宏的代码一定要放在定义宏的后面,否则会报错找不到该宏</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'dalong'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="宏也可以单独定义到文件中然后导入到模板中使用--from-3html-import-show_name-">宏也可以单独定义到文件中,然后导入到模板中使用 <code class="language-plaintext highlighter-rouge">{% from '3.html' import show_name %}</code></h3>

<p><em>3.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{# 定义宏 #}
{% macro show_name(name) %}
    <span class="nt">&lt;h1&gt;</span>hello {{ name }} 这是被导入的宏里的内容<span class="nt">&lt;/h1&gt;</span>
{% endmacro %}

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>主模板导入宏</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{# 导入宏 #}
{% from '3.html' import show_name %}

{# 调用宏 #}
{{ show_name(name) }}
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="block的定义-及-模板的继承--block-title---extends-parentshtml---super-">block的定义 及 模板的继承 <code class="language-plaintext highlighter-rouge">{% block title %}</code> <code class="language-plaintext highlighter-rouge">{% extends 'parents.html' %}</code> <code class="language-plaintext highlighter-rouge">{{ super() }}</code></h3>

<p>目的:</p>

<ul>
  <li>用于将一些公共的模板作为父类, 子类可以继承父类,然后重写父类的部分显示效果.</li>
  <li>大点的网站项目通常有一个顶层的 <em>layout.html</em>，它定义了你的应用程序的通用布局以及你的网站的每一部分。其他模板继承它</li>
</ul>

<p>block的意义: 定义html代码块</p>

<ul>
  <li>用于在html 中将小块的内容进行定义, 以便于后续的子模板进行调用和重写</li>
</ul>

<p>注意:</p>

<ul>
  <li>当重写了一个block 后发现原来的显示没有了, 很可能是没有调用 super()</li>
</ul>

<p><em>父模板 parents.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>{% block ptitle %}父模板的标题{% endblock %}<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    {% block pcontent %}父模板的内容{% endblock %}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>子模板 child.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>{# 继承 #}
{% extends 'parents.html' %}

{# 完全重写父类模板 #}
{% block ptitle %} 重写父母版的标题 {% endblock %}

{# 部分重写模板中的内容 #}
{% block pcontent %}
    {{ super() }} {# 调用父类的内容 #}
    部分重写父母版的标题

{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>视图函数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/extends/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extends</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'child.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="flask-bootstrap-支持-bootstrap">flask-bootstrap 支持 bootstrap</h3>

<p><a href="http://pythonhosted.org/Flask-Bootstrap/">官方文档</a></p>

<p>安装:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.6 install flask-bootstrap
</pre></td></tr></tbody></table>
</div>
</div>

<p>使用方法:</p>

<p>(1). 首先创建bootstrap 实例, 并用它初始化app应用.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>   
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/bs/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boot</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'bs.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2). 在程序中使用一个包含所有<code class="language-plaintext highlighter-rouge">Bootstrap</code> 文件的基模版。这个模版利用 <code class="language-plaintext highlighter-rouge">Jinja2</code> 的模版继承机制，让程序扩展一个具有基本页面结构的基模版，其中就有用来引入 <code class="language-plaintext highlighter-rouge">Bootstrap</code> 的元素。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Jinja2</code> 中的 <code class="language-plaintext highlighter-rouge">extends</code> 指令从 <code class="language-plaintext highlighter-rouge">Flask-Bootstrap</code> 中导入 <code class="language-plaintext highlighter-rouge">bootstrap/base.html</code>，从而实现模版继承。<code class="language-plaintext highlighter-rouge">Flask-Bootstrap</code> 中的基模版提供了一个网页框架，引入了 <code class="language-plaintext highlighter-rouge">Bootstrap</code> 中的所有 CSS 和 JavaScript 文件。</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre>{# 集成bootstrap的基础模板 #}

{% extends 'bootstrap/base.html' %}

{% block title %}BootStrap 用户注册页面{% endblock %}

{% block content %}

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>欢迎注册gogog<span class="nt">&lt;/div&gt;</span>

{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>基模版中定义了可在衍生模版中重定义的块。<code class="language-plaintext highlighter-rouge">block</code> 和 <code class="language-plaintext highlighter-rouge">endblock</code> 指令定义的块中的内容可添加到基模版中。</li>
  <li>上面这个示例定义了3个块，分别名为 <code class="language-plaintext highlighter-rouge">title</code>、<code class="language-plaintext highlighter-rouge">navbar</code>和<code class="language-plaintext highlighter-rouge">content</code>。这些块都是基模版提供的，可在衍生模版中重新定义。</li>
</ul>

<p><em><code class="language-plaintext highlighter-rouge">Flask-Bootstrap</code> 的 <code class="language-plaintext highlighter-rouge">base.html</code> 模块定义的可用块。</em></p>

<h3 id="available-blocks">Available blocks</h3>

<table>
  <thead>
    <tr>
      <th>Block name</th>
      <th>Outer Block</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>doc</td>
      <td> </td>
      <td>Outermost block.</td>
    </tr>
    <tr>
      <td>html</td>
      <td>doc</td>
      <td>Contains the complete content of the <code class="language-plaintext highlighter-rouge">&lt;html&gt;</code> tag.</td>
    </tr>
    <tr>
      <td>html_attribs</td>
      <td>doc</td>
      <td>Attributes for the HTML tag.</td>
    </tr>
    <tr>
      <td>head</td>
      <td>doc</td>
      <td>Contains the complete content of the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> tag.</td>
    </tr>
    <tr>
      <td>body</td>
      <td>doc</td>
      <td>Contains the complete content of the <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> tag.</td>
    </tr>
    <tr>
      <td>body_attribs</td>
      <td>body</td>
      <td>Attributes for the Body Tag.</td>
    </tr>
    <tr>
      <td><strong>title</strong></td>
      <td>head</td>
      <td>Contains the complete content of the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tag.</td>
    </tr>
    <tr>
      <td><strong>styles</strong></td>
      <td>head</td>
      <td>Contains all CSS style <code class="language-plaintext highlighter-rouge">&lt;link&gt;</code> tags inside head.</td>
    </tr>
    <tr>
      <td>metas</td>
      <td>head</td>
      <td>Contains all <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> tags inside head.</td>
    </tr>
    <tr>
      <td><strong>navbar</strong></td>
      <td>body</td>
      <td>An empty block directly above <em>content</em>.</td>
    </tr>
    <tr>
      <td><strong>content</strong></td>
      <td>body</td>
      <td>Convenience block inside the body. Put stuff here.</td>
    </tr>
    <tr>
      <td><strong>scripts</strong></td>
      <td>body</td>
      <td>Contains all <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tags at the end of the body.</td>
    </tr>
  </tbody>
</table>

<p>注意:</p>

<ul>
  <li>
    <p>如果使用了bootstrap , 如果重写了一个block 之后, 原来的效果消失了, 那么可能是忘了super()</p>
  </li>
  <li>
    <p>上表中很多块都是 <code class="language-plaintext highlighter-rouge">Flask-Bootstap</code> 自用的， 如果直接重定义可能会导致一些问题。如果程序需要向已经有内容的块中添加新内容， 必须使用 <code class="language-plaintext highlighter-rouge">Jinja2</code> 提供的 <code class="language-plaintext highlighter-rouge">super()</code> 函数。例如，如果要在衍生模版中添加新的 <code class="language-plaintext highlighter-rouge">JavaScript</code> 文件，需要这么定义：</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>{% block scripts %}
{{ super() }}
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"my-script.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<p>Bootstrap 官方的基类: <code class="language-plaintext highlighter-rouge">bootstrap/base.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></td><td class="code"><pre>{% block doc -%}
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span><span class="err">{%</span> <span class="na">block</span> <span class="na">html_attribs</span> <span class="err">%}{%</span> <span class="na">endblock</span> <span class="na">html_attribs</span> <span class="err">%}</span><span class="nt">&gt;</span>
{%- block html %}
  <span class="nt">&lt;head&gt;</span>
    {%- block head %}
    <span class="nt">&lt;title&gt;</span>{% block title %}{{title|default}}{% endblock title %}<span class="nt">&lt;/title&gt;</span>

    {%- block metas %}
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    {%- endblock metas %}

    {%- block styles %}
    <span class="c">&lt;!-- Bootstrap --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"{{bootstrap_find_resource('css/bootstrap.css', cdn='bootstrap')}}"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
    {%- endblock styles %}
    {%- endblock head %}
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body</span><span class="err">{%</span> <span class="na">block</span> <span class="na">body_attribs</span> <span class="err">%}{%</span> <span class="na">endblock</span> <span class="na">body_attribs</span> <span class="err">%}</span><span class="nt">&gt;</span>
    {% block body -%}
    {% block navbar %}
    {%- endblock navbar %}
    {% block content -%}
    {%- endblock content %}

    {% block scripts %}
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"{{bootstrap_find_resource('jquery.js', cdn='jquery')}}"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"{{bootstrap_find_resource('js/bootstrap.js', cdn='bootstrap')}}"</span><span class="nt">&gt;&lt;/script&gt;</span>
    {%- endblock scripts %}
    {%- endblock body %}
  <span class="nt">&lt;/body&gt;</span>
{%- endblock html %}
<span class="nt">&lt;/html&gt;</span>
{% endblock doc -%} 
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="定义项目基础模板">定义项目基础模板</h3>

<p>说明:</p>

<ul>
  <li>一个项目中,如果很多页面相似, 只有细微差别, 那么为了避免重复工作, 通常可以为项目制定一个基础模板(继承自bootstrap 基础模板),然后其他页面对基础模板进行继承, 然后根据需要进行简单修改.</li>
</ul>

<p>步骤:</p>

<p>(1). 重bootcss.com上复制一个顺眼的导航条</p>

<p>(2). 将内容赋值到模板中</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre>{# 集成bootstrap的基础模板 #}
{% extends 'bootstrap/base.html' %}
{% block title %}BootStrap 基础模板{% endblock %}
{# 定制导航条 #}
{% block navbar %}

	{# 将拷贝的导航条拷贝到这里 #}

{% endblock %}


</pre></td></tr></tbody></table>
</div>
</div>

<p>(3). 根据需要,定制导航条内容</p>

<p>(4). 然后再定制页面主体部分</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre>{# 集成bootstrap的基础模板 #}
{% extends 'bootstrap/base.html' %}
{% block title %}BootStrap 基础模板{% endblock %}
{# 定制导航条 #}
{% block navbar %}

	{# 将拷贝的导航条拷贝到这里 #}

{% endblock %}

{# 定制页面主体部分 #}
{% block content %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        {# 为页面弹框预留空间 #}
        {% block popwindow %}
            默认内容
        {% endblock %}
        {% include '2.html' %}
    <span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>一个完整的基础模板例子 base.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></td><td class="code"><pre>{# 集成bootstrap的基础模板 #}

{% extends 'bootstrap/base.html' %}

{% block title %}BootStrap 基础模板{% endblock %}

    {# 定制导航条 #}
    {% block navbar %}

        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-inverse"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#bs-example-navbar-collapse-1"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
              <span class="nt">&lt;/button&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>三手店<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="c">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"bs-example-navbar-collapse-1"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"active"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>产品 <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>(current)<span class="nt">&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>服务<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>更多... <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
                  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Action<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Another action<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Something else here<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li</span> <span class="na">role=</span><span class="s">"separator"</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Separated link<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li</span> <span class="na">role=</span><span class="s">"separator"</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>One more separated link<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                  <span class="nt">&lt;/ul&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
              <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"navbar-form navbar-left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"猪手"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default"</span><span class="nt">&gt;</span>搜索<span class="nt">&lt;/button&gt;</span>
              <span class="nt">&lt;/form&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>登录<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>用户选项 <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
                  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Action<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Another action<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Something else here<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li</span> <span class="na">role=</span><span class="s">"separator"</span> <span class="na">class=</span><span class="s">"divider"</span><span class="nt">&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Separated link<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                  <span class="nt">&lt;/ul&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.navbar-collapse --&gt;</span>
          <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.container-fluid --&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>


    {% endblock %}

    {# 定制页面主体部分 #}
    {% block content %}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            {# 为页面弹框预留空间 #}
            {% block page_content %}
                默认内容
            {% endblock %}
        <span class="nt">&lt;/div&gt;</span>
    {% endblock %}

</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template_string</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/base/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">base</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'base.html'</span><span class="p">)</span>
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="继承基础模板-去定义一个404错误页面errorhtml">继承基础模板, 去定义一个404错误页面<code class="language-plaintext highlighter-rouge">error.html</code></h3>

<p>(1) 创建一个继承自基础模板的错误页面子模板</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{% extends 'base.html' %}

{% block title %} 出错了 404 {% endblock %}

{% block page_content %} 404 臣妾做不到...{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 为404错误创建统一路由</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'error.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="继承基础模板-跳转新页面-注册页面的例子">继承基础模板, 跳转新页面 (注册页面的例子)</h3>

<p>(1)在基础模板中为链接增加 url_for 函数</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('register') }}"</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2)在视图函数中创建route 注册用的路由</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/register/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'register.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3)创建一个继承自基础模板的子模板 <code class="language-plaintext highlighter-rouge">register.html</code></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>{% extends 'base.html' %}

{% block title %} 注册页 {% endblock %}

{% block page_content %} 注册了...{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="再看url_for-函数-普通构造-参数构造-外链构造">再看url_for() 函数: <code class="language-plaintext highlighter-rouge">普通构造, 参数构造, 外链构造</code></h3>

<p><em>普通URL构造</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('register') }}"</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>带参数的URL构造</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('welcome', name='xiaoming', id=3, page=5) }}"</span><span class="nt">&gt;</span>欢迎页<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>输出结果: /welcome/xiaoming?id=3&amp;page=5, 没有主机和端口号, 只能在网站内部使用</li>
</ul>

<p><em>外链URL构造</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('welcome', name='xiaolong', id=3, page=5, _external=True) }}"</span><span class="nt">&gt;</span>欢迎页<span class="nt">&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('welcome', name='xiaolong', id=3, page=5, _external=True) }}"</span><span class="nt">&gt;</span>欢迎页<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>如果需要构造完整的外部链接地址, 需要添加参数 <code class="language-plaintext highlighter-rouge">_external=True</code></li>
  <li>构造出的HTML为<code class="language-plaintext highlighter-rouge">&lt;a href="http://127.0.0.1:5000/welcome/xiaolong?id=3&amp;amp;page=5"&gt;欢迎页&lt;/a&gt;</code></li>
  <li>没有用<code class="language-plaintext highlighter-rouge">_external=True</code>参数的url_for 构造出来的HTML为 <code class="language-plaintext highlighter-rouge">&lt;a href="/register/"&gt;注册&lt;/a&gt;</code></li>
</ul>

<h2 id="静态文件-图片-css-js">静态文件 图片, css, js</h2>

<p>静态文件就是那些不会改变的文件。在一般的应用程序中，静态文件包括 CSS 文件，JavaScript 文件以及图片。它们也可能是音频文件以及其它类似的东西。</p>

<h3 id="加载静态图片-url_forstatic-filenameimgtimgjpg--block-head-">加载静态图片 <code class="language-plaintext highlighter-rouge">url_for('static', filename='img/timg.jpg')</code> <code class="language-plaintext highlighter-rouge">{% block head %}</code></h3>

<p>目录结构:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>project/			<span class="c">#项目目录</span>
	static/			<span class="c">#静态资源</span>
	templates/		<span class="c">#模板文件</span>
	mnage.py		<span class="c">#视图函数/启动控制文件</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>加载一个静态图片</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre>{% extends 'base.html' %}

{% block title %} 加载静态资源 {% endblock %}

{% block page_content %}
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ url_for('static', filename='img/timg.jpg') }}"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
{% endblock %}
{##}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>找个favicon.ico 文件放到静态目录下</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>{% block head %}
    {{ super() }}
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">type=</span><span class="s">"image/x-icon"</span> <span class="na">href=</span><span class="s">"{{ url_for('static', filename='img/favicon.ico') }}"</span><span class="nt">&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>{% block head %} 标签是在bootstrap 中自带的,所以不需要在父类中提前定义.</li>
  <li>{{ supper() }} 是必须的, 因为子类需要继承并重现bootstrap 中的head 内容</li>
  <li>favicon.ico 标签要写成 <code class="language-plaintext highlighter-rouge">&lt;link rel="icon" type="image/x-icon" href=""&gt;</code>
    <ul>
      <li>或者: <code class="language-plaintext highlighter-rouge">&lt;link rel="shortcut icon" href=""&gt;</code></li>
    </ul>
  </li>
</ul>

<h3 id="加载静态css--block-style-">加载静态CSS <code class="language-plaintext highlighter-rouge">{% block style %}</code></h3>

<p><em>视图函数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/mycss/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mycss</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'mycss.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>mycss.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre>{% extends 'base.html' %}
{% block title %}定制CSS{% endblock %}
{% block page_content %}
    {% block style %}
        {{ super() }}
        <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
            <span class="nc">.myclass</span><span class="p">{</span>
                <span class="nl">height</span><span class="p">:</span><span class="m">100px</span><span class="p">;</span>
                <span class="nl">width</span><span class="p">:</span><span class="m">100px</span><span class="p">;</span>
                <span class="nl">background-color</span><span class="p">:</span> <span class="no">green</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="nt">&lt;/style&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"{{ url_for('static', filename='css/base.css') }}"</span> <span class="nt">/&gt;</span>
    {% endblock %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"myclass"</span><span class="nt">&gt;</span>123<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"myclass2"</span><span class="nt">&gt;</span>123<span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>{{ supper() }} 是必须的, 因为子类需要继承并重现bootstrap 中的CSS样式 内容</li>
  <li>{% block style %} 内部可以写内嵌标签,也可以引入独立的css文件.</li>
  <li><strong>注意 !!!</strong> 独立的css文件的名字不要和路由的名字重名,否则可能造成找不到静态文件的可能.</li>
</ul>

<p><em>base.css</em></p>

<div class="language-css highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nc">.myclass2</span><span class="p">{</span>
    <span class="nl">height</span><span class="p">:</span><span class="m">100px</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span><span class="m">50px</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="加载静态js---block-scripts-">加载静态JS  <code class="language-plaintext highlighter-rouge">{% block scripts %}</code></h3>

<p><em>路由函数</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/myjs/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myjs</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'myjs.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>myjs.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>{% extends 'base.html' %}
{% block title %}测试js{% endblock %}

    {% block scripts %}
        {{ super() }}
        <span class="nt">&lt;script&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'这是自定义的内嵌js'</span><span class="p">)</span>
        <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"{{ url_for('static', filename='js/myjs.js') }}"</span><span class="nt">&gt;&lt;/script&gt;</span>
    {% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>myjs.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'这是独立js'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>{{ supper() }} 是必须的, 因为子类需要继承并重现bootstrap 中的js 内容</li>
  <li>{% block scripts %} 内部可以写内嵌js,也可以引入独立的js文件.</li>
</ul>

<h3 id="待完善-使用-flask-assets-管理静态资源">待完善: 使用 Flask-Assets 管理静态资源</h3>

<p><a href="https://www.jianshu.com/p/11c0feaad0f8">详细使用说明</a></p>

<p>介绍</p>

<blockquote>
  <p>Flask-Assets 是一个用来管理你的静态文件的扩展。Flask-Assets 提供了两个非常有用的工具。首先，它可以让你们在 Python 代码中定义资源的 <strong>束/包（bundles）</strong>，这些束/包（bundles）能够被一起插入到你的模板。其次，它可以让你们 <strong>预处理（pre-process）</strong> 这些文件。这就意味着你们能够合并和压缩你们的 CSS 和 JavaScript 文件，使得用户仅仅只需要加载两个压缩的文件（CSS 和 JavaScript），而不需要迫使你开发一个复杂的资源管道。你甚至可以编译来自 Sass, LESS, CoffeeScript 以及一堆其它来源的文件。</p>
</blockquote>

<p>安装Flask-Assets</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install Flask-Assets
</pre></td></tr></tbody></table>
</div>
</div>

<p>使用说明</p>

<blockquote>
  <ul>
    <li>首先，创建一个<code class="language-plaintext highlighter-rouge">Environments</code>对象，并使用它初始化<code class="language-plaintext highlighter-rouge">Flask</code>应用，</li>
    <li>然后创建一个Buldle 对象</li>
    <li>最后将<code class="language-plaintext highlighter-rouge">Bundle</code>对象注册到<code class="language-plaintext highlighter-rouge">Environments</code>对象上。</li>
  </ul>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_assets</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">Bundle</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">assets</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c"># 首先，创建一个Environments实例, 并使用它初始化Flask应用</span>

<span class="n">js</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="s">'jquery.js'</span><span class="p">,</span> <span class="s">'base.js'</span><span class="p">,</span> <span class="s">'widgets.js'</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="s">'jsmin'</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s">'gen/packed.js'</span><span class="p">)</span>  	<span class="c"># 创建 Bundle 对象</span>
<span class="n">assets</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">'js_all'</span><span class="p">,</span> <span class="n">js</span><span class="p">)</span> 							<span class="c"># 将对象绑定到Assets 上</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Bundle</code>对象可以传递任意数量的源文件作为参数，使用<code class="language-plaintext highlighter-rouge">output</code>参数指定输出文件路径，使用<code class="language-plaintext highlighter-rouge">filters</code>参数指定过滤器。所有文件的路径都是相对路径，以应用的静态文件路径为基准。</li>
</ul>

<h2 id="flask-表单">Flask 表单</h2>

<p>提交的表单数据都放在 request.form 中</p>

<h3 id="flask--表单的使用-原生创建表单和验证">FLASK  表单的使用 (原生创建表单和验证)</h3>

<p><em>新建一个模板文件 login.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"{{ url_for('check') }}"</span><span class="nt">&gt;</span>
  用户名: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"登录"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>渲染模板文件,处理表单提交</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/check/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>


</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>接收表单数据的路由必须添加一个数组参数.</li>
  <li>参数: <code class="language-plaintext highlighter-rouge">methods=['POST']</code></li>
  <li><code class="language-plaintext highlighter-rouge">request.form</code>数组包含了form 提交的所有数据</li>
</ul>

<p><em>表单渲染与提交处理可以放在一个路由中</em></p>

<ul>
  <li>表单的提交地址<code class="language-plaintext highlighter-rouge">action=''</code> 需要设置为空, 默认提交到当前路由地址</li>
  <li>路由参数methods 需要同时有 GET 和 POST</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="flask-wtf-安全表单的创建和验证">flask-wtf 安全表单的创建和验证</h3>

<p>WTF 是 Write &amp; Test Form 的缩写</p>

<p><a href="http://docs.jinkan.org/docs/flask-wtf/">官方文档</a></p>

<p><a href="http://www.pythondoc.com/flask-wtf/index.html">中文官方文档</a></p>

<h4 id="说明"><em>说明:</em></h4>

<ul>
  <li>
    <p>Flask-WTF 表单保护你免受 CSRF 威胁，你不需要有任何担心。尽管如此，如果你有不包含表单的视图，那么它们仍需要额外的保护。</p>
  </li>
  <li>是一个处理表单的扩展库, 通过了 SCRF 安全认证</li>
  <li>可以进行字段校验, 跨站攻击保护.</li>
</ul>

<h4 id="安装"><em>安装:</em></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-wtf
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="使用"><em>使用:</em></h4>

<p>(1) 首先导入flask-wtf 相关的模块</p>

<ul>
  <li>Form模块: <code class="language-plaintext highlighter-rouge">FlaskForm</code> , 用于被后续定义表单类继承</li>
  <li>表单字段模块: <code class="language-plaintext highlighter-rouge">StringField, SubmitField ...</code> : , 用于生成表单字段</li>
  <li>表单验证模块: <code class="language-plaintext highlighter-rouge">DataRequired..</code> ,用于对提交的表单内容进行验证</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span> <span class="c">#  form 模块</span>

<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">SubmitField</span> <span class="c">#  字段模块</span>

<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span> <span class="c">#  验证器模块</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c">#CSRF 需要使用秘钥</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123456'</span>  <span class="c"># 必须要为app设置SECRET_key </span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>必须要为app设置<code class="language-plaintext highlighter-rouge">SECRET_KEY</code></li>
</ul>

<p>(2) 在视图函数中定义一个form类</p>

<ul>
  <li>该类必须继承自 <code class="language-plaintext highlighter-rouge">FlaskForm</code> 模块</li>
  <li>在form 类中生成 表单字段的对象 , 并为对象指定 label 名字和验证器
    <ul>
      <li>第一个参数: label 名称</li>
      <li>第二个参数: 为validators 传递验证器数组</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c"># 表单类: 要求继承自 FlaskForm</span>
<span class="k">class</span> <span class="nc">NameForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'用户名'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'提交'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 在路由中实例化form 类, 并将对象传递给模板</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c"># 原生渲染</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="c"># bootstrap 渲染</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/boot/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">boot</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'form.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(4.1)  原生渲染form 表单</p>

<ul>
  <li>通过传递进来的form 对象渲染表单字段</li>
  <li>需要把渲染内容放到一个自己写的<code class="language-plaintext highlighter-rouge">&lt;form&gt;</code> 标签中</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
    {# CSRF 的隐藏字段 #}
    {{ form.hidden_tag() }}

    {# 渲染name 字段 #}
    {{ form.name.label() }}{{ form.name(id='xxx', class='yyy') }}

    {# 提交按钮 #}
    {{ form.submit() }}

<span class="nt">&lt;/form&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>form.hidden_tag(): 生成安全token , 生成的隐藏表单内容如下:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"csrf_token"</span> <span class="na">name=</span><span class="s">"csrf_token"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"IjRmZDUxNDkwYTBjZThjMmI4NGFmNzg5ZTIxYTY3Yjk1NGUxOGZjNGQi.DS8uzQ.6at3jdtOQTbYEKny63J1H_HbTM4"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>form.name.label(): 是name字段的标签名</p>
  </li>
  <li>
    <p>form.name(id=’xxx’, class=’yyy’): 生成name字段, 并指定css样式的id 和 class</p>
  </li>
</ul>

<p>(4.2) 通过 bootstrap 渲染 form 表单</p>

<ul>
  <li>目的: Bootstrap 自带了wtf 的渲染宏, 可以直接import 使用</li>
  <li>使用: 将form 对象作为参数, 让宏进行调用即可</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre>{% extends 'bootstrap/base.html' %}

{# 使用bootstrap自带的表单渲染宏 #}
{% import 'bootstrap/wtf.html' as wtf %}

{% block title %}
    bootstrap 表单渲染
{% endblock %}

{% block content %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        {% if name %}
            <span class="nt">&lt;h2&gt;</span>{{ name }}<span class="nt">&lt;/h2&gt;</span>
        {% endif %}
        {# 渲染表单 #}
        {{ wtf.quick_form(form) }}
    <span class="nt">&lt;/div&gt;</span>

{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">import 'bootstrap/wtf.html' as wtf</code>: 用 <code class="language-plaintext highlighter-rouge">as</code> 关键字可以为宏起别名</li>
  <li><code class="language-plaintext highlighter-rouge">wtf.quick_form(form)</code>: quick_form 是宏的一个方法, 将form 对象直接传递给该方法.</li>
  <li>注意: bootstrap form宏 需要放在 <code class="language-plaintext highlighter-rouge">&lt;div class="container"&gt;</code> 中进行渲染</li>
</ul>

<p>(5.1) 表单提交后的处理 - 无跳转方案</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># 为了安全, 现将存储提交数据的变量初始化为None</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span> <span class="c"># 验证是否是有效提交</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>     <span class="c"># 获取提交信息</span>
        <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">''</span>		  <span class="c"># 为了安全, 得到信息后,就立刻清空信息源</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'form.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(5.1) 表单提交后的处理 - redirect 跳转方案</p>

<ul>
  <li>原因: 浏览器默认会记录最后的请求状态, 如果POST后刷新页面后会提示再次提交表单.</li>
  <li>方案: POST 重定向 GET</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span> 

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span> <span class="c"># 验证是否是有效提交</span>

        <span class="n">session</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="c"># 为了保存提交过来的名字, 需要将name 保存到session中</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'index'</span><span class="p">))</span> <span class="c"># 然后redirect 到当前页, 为的是不让刷新后的弹出框出现</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span> <span class="c"># 重新从session中拿到name 变量</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'form.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="c">#渲染模板</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="常见表单字段类型"><em>常见表单字段类型</em></h4>

<ul>
  <li>使用前需要提前导入:<code class="language-plaintext highlighter-rouge">from wtforms import StringField, SubmitField</code></li>
</ul>

<table>
  <thead>
    <tr>
      <th>字段</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>StringField</td>
      <td>普通文本字段</td>
    </tr>
    <tr>
      <td>SubmitField</td>
      <td>提交按钮</td>
    </tr>
    <tr>
      <td>PasswordField</td>
      <td>密码字段</td>
    </tr>
    <tr>
      <td>HiddenField</td>
      <td>隐藏字段</td>
    </tr>
    <tr>
      <td>TextAreaField</td>
      <td>文本域字段</td>
    </tr>
    <tr>
      <td>DateField</td>
      <td>文本字段,datetime.date格式</td>
    </tr>
    <tr>
      <td>DataTimeField</td>
      <td>文本字段,datetime.datetime格式</td>
    </tr>
    <tr>
      <td>IntegerField</td>
      <td>文本字段, 整数</td>
    </tr>
    <tr>
      <td>FloatField</td>
      <td>文本字段,浮点数格式</td>
    </tr>
    <tr>
      <td>BooleanField</td>
      <td>复选框, 值为True 或 False</td>
    </tr>
    <tr>
      <td>RadioField</td>
      <td>单选框</td>
    </tr>
    <tr>
      <td>SelectField</td>
      <td>下拉框</td>
    </tr>
    <tr>
      <td>FileField</td>
      <td>文件上传</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'BooleanField'</span><span class="p">,</span> <span class="s">'DecimalField'</span><span class="p">,</span> <span class="s">'DateField'</span><span class="p">,</span> <span class="s">'DateTimeField'</span><span class="p">,</span> <span class="s">'FieldList'</span><span class="p">,</span>
    <span class="s">'FloatField'</span><span class="p">,</span> <span class="s">'FormField'</span><span class="p">,</span> <span class="s">'IntegerField'</span><span class="p">,</span> <span class="s">'RadioField'</span><span class="p">,</span> <span class="s">'SelectField'</span><span class="p">,</span>
    <span class="s">'SelectMultipleField'</span><span class="p">,</span> <span class="s">'StringField'</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="常见的字段验证器"><em>常见的字段验证器</em></h4>

<ul>
  <li>使用前需要提前导入: <code class="language-plaintext highlighter-rouge">from wtforms.validators import DataRequired</code></li>
</ul>

<table>
  <thead>
    <tr>
      <th>验证器</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DataRequired</td>
      <td>字段不为空</td>
    </tr>
    <tr>
      <td>Email</td>
      <td>验证邮箱地址</td>
    </tr>
    <tr>
      <td>EqualTo</td>
      <td>验证字段一致性</td>
    </tr>
    <tr>
      <td>IPAddress</td>
      <td>IP 地址验证</td>
    </tr>
    <tr>
      <td>Length</td>
      <td>字符串长度验证</td>
    </tr>
    <tr>
      <td>NumberRange</td>
      <td>数字范围验证</td>
    </tr>
    <tr>
      <td>URL</td>
      <td>URL 验证</td>
    </tr>
    <tr>
      <td>Regexp</td>
      <td>正则验证方法</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'DataRequired'</span><span class="p">,</span> <span class="s">'data_required'</span><span class="p">,</span> <span class="s">'Email'</span><span class="p">,</span> <span class="s">'email'</span><span class="p">,</span> <span class="s">'EqualTo'</span><span class="p">,</span> <span class="s">'equal_to'</span><span class="p">,</span>
    <span class="s">'IPAddress'</span><span class="p">,</span> <span class="s">'ip_address'</span><span class="p">,</span> <span class="s">'InputRequired'</span><span class="p">,</span> <span class="s">'input_required'</span><span class="p">,</span> <span class="s">'Length'</span><span class="p">,</span>
    <span class="s">'length'</span><span class="p">,</span> <span class="s">'NumberRange'</span><span class="p">,</span> <span class="s">'number_range'</span><span class="p">,</span> <span class="s">'Optional'</span><span class="p">,</span> <span class="s">'optional'</span><span class="p">,</span>
    <span class="s">'Required'</span><span class="p">,</span> <span class="s">'required'</span><span class="p">,</span> <span class="s">'Regexp'</span><span class="p">,</span> <span class="s">'regexp'</span><span class="p">,</span> <span class="s">'URL'</span><span class="p">,</span> <span class="s">'url'</span><span class="p">,</span> <span class="s">'AnyOf'</span><span class="p">,</span>
    <span class="s">'any_of'</span><span class="p">,</span> <span class="s">'NoneOf'</span><span class="p">,</span> <span class="s">'none_of'</span><span class="p">,</span> <span class="s">'MacAddress'</span><span class="p">,</span> <span class="s">'mac_address'</span><span class="p">,</span> <span class="s">'UUID'</span>
<span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="字段的自定义校验"><em>字段的自定义校验</em></h4>

<p>(1) 先导入 自定义验证抛异常模块</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Length</span><span class="p">,</span> <span class="n">ValidationError</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 在表单类中定义一个新的验证<code class="language-plaintext highlighter-rouge">函数</code></p>

<ul>
  <li>函数名字必须为: <code class="language-plaintext highlighter-rouge">validate_字段名</code></li>
  <li>函数的参数 field: 表示被验证的字段.</li>
  <li>函数的报错信息需要用 <code class="language-plaintext highlighter-rouge">raise ValidationError('用户名长度不能小于6个字符')</code> 定义</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c"># 表单类: 要求继承自 FlaskForm</span>
<span class="k">class</span> <span class="nc">NameForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'用户名'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"不能为空"</span><span class="p">))])</span>
    <span class="c"># Length(5,20,message='必须在5~20个字符之间')</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'提交'</span><span class="p">)</span>

    <span class="c">#自定义校验, 名字必须为: 'validate_字段名'</span>
    <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">'用户名长度不能小于6个字符'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 使用: 把form 对象直接传递到模板中就可以直接生效了.</p>

<h3 id="flash-弹出窗口-消息显示-flash--get_flashed_messages">flash 弹出窗口 消息显示 <code class="language-plaintext highlighter-rouge">flash()  get_flashed_messages()</code></h3>

<p>目的:</p>

<ul>
  <li>当用户在页面中进行交互时, 系统可以有针对性的给用户一些提示, 警告, 引导等信息.</li>
  <li>这些信息可以通过弹窗的形式告诉用户如何操作.</li>
  <li>弹窗可以让用户自己关闭,或者延时自动小时.</li>
</ul>

<p>使用方法:</p>

<p>(1) 引入flash发送消息和获取消息模块</p>

<ul>
  <li>注意: 因为消息机制涉及到安全, 所以必须要设置SECRET_KEY</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span><span class="p">,</span> <span class="n">get_flashed_messages</span>  <span class="c"># 引入模块</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123456'</span>  <span class="c"># 必须设置 SECRET_KEY</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 在路由中设置触发消息的机制</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'财神到'</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'财神天天到'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'testFlash.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3.1) 普通模板中获取flash 消息</p>

<ul>
  <li>因为内容可能不止一条, 所以需要循环遍历.</li>
  <li>如果有多个页面都需要弹出flash 消息, 可以再项目的基础模板中写一次就可以了.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>{% for message in get_flashed_messages() %}
    <span class="nt">&lt;div&gt;</span>{{ message }}<span class="nt">&lt;/div&gt;</span>
{% endfor %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3.2) bootstrap 中获取flash 消息</p>

<ul>
  <li>bootstrap 组件来自 <a href="https://v3.bootcss.com/components/#alerts">这里</a></li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre>{% extends 'bootstrap/base.html' %}

{# 使用bootstrap自带的表单渲染宏 #}

{% block title %}
    bootstrap flash 弹出框
{% endblock %}

{% block content %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        {% for message in get_flashed_messages() %}
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-warning alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span>
                      <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;&lt;/button&gt;</span>
              <span class="nt">&lt;strong&gt;</span>Warning!<span class="nt">&lt;/strong&gt;</span> <span class="nt">&lt;div&gt;</span>{{ message }}<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      	{% endfor %}
    <span class="nt">&lt;/div&gt;</span>

{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="一段完整的表单生成--表单验证--弹窗-的例子">一段完整的表单生成 + 表单验证 + 弹窗 的例子</h3>

<p>路由文件mywtf.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">get_flashed_messages</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span><span class="p">,</span> <span class="n">SubmitField</span><span class="p">,</span> <span class="n">BooleanField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">EqualTo</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Length</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123456'</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">myForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">useremail</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'邮件地址: '</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="s">'用户名不能为空'</span><span class="p">),</span> <span class="n">Email</span><span class="p">(</span><span class="s">'邮箱格式不正确'</span><span class="p">)])</span>
    <span class="n">password1</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">'密码: '</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="s">'密码不能为空'</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="s">"密码必须介于5~15位字符"</span><span class="p">)])</span>
    <span class="n">password2</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">'密码: '</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="s">'密码不能为空'</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="s">"密码必须介于5~15位字符"</span><span class="p">),</span> <span class="n">EqualTo</span><span class="p">(</span><span class="s">'password1'</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"两次密码输入不一致"</span><span class="p">)])</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="s">'记住我'</span><span class="p">)</span>
    <span class="n">button</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'提交'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'表单提交了'</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">myForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>

        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'表单验证成功'</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">"用户名 {} 已经存在, 请尝试新的用户名"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">useremail</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">useremail</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="s">''</span>
        <span class="n">form</span><span class="o">.</span><span class="n">password1</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="s">''</span>
        <span class="n">form</span><span class="o">.</span><span class="n">password2</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="s">''</span>
        <span class="n">form</span><span class="o">.</span><span class="n">confirm</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="s">''</span>


    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'mywtf.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>模板文件mywtf.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></td><td class="code"><pre>{% extends 'bootstrap/base.html' %}
{% block title %}
    测试wtf
{% endblock %}
{% block content %}
    <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>用户注册<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.container-fluid --&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        {% block page %}
            {% for message in get_flashed_messages() %}
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-warning alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span>
                            <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;&lt;/button&gt;</span>
                    <span class="nt">&lt;strong&gt;</span>Warning!<span class="nt">&lt;/strong&gt;</span>
                    <span class="nt">&lt;div&gt;</span>{{ message }}<span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            {% endfor %}
        {% endblock %}


        <span class="nt">&lt;hr/&gt;</span>

        {# Bootstrap 渲染方案 #}

        {% import 'bootstrap/wtf.html' as wtf %}
        {{ wtf.quick_form(form) }}


    <span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="flask-moment--负责显示时间戳">flask-moment  负责显示时间戳</h2>

<p><a href="http://momentjs.com">官网</a></p>

<p>说明:</p>

<ul>
  <li>专门根据本地时间显示时间戳的扩展库, 使用非常方便</li>
</ul>

<p>(1) 安装包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-moment
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 导入模块, 创建对象 设置路由</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_moment</span> <span class="kn">import</span> <span class="n">Moment</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="c">#</span>
<span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'本地化显示'</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/moment/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mmt</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">old_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="mi">3600</span><span class="p">)</span>  <span class="c"># 一小时之前</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'mement.html'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 设置模板显示时间</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>本地化时间显示<span class="nt">&lt;/h1&gt;</span>

{# 简化的显示方式 #}
<span class="nt">&lt;div&gt;</span>时间: {{ moment(g.current_time).format('LLLL') }}<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>时间: {{ moment(g.current_time).format('LLL') }}<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>时间: {{ moment(g.current_time).format('LL') }}<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>时间: {{ moment(g.current_time).format('L') }}<span class="nt">&lt;/div&gt;</span>

{# 自定义显示方式 #}
<span class="nt">&lt;div&gt;</span>自定义: {{ moment(g.current_time).format('YYYY.MM.DD') }}<span class="nt">&lt;/div&gt;</span>

{# 显示时间差. 既某个时间距离今天多少天了. #}
<span class="nt">&lt;div&gt;</span>发表于: {{ moment(g.old_time).fromNow() }}<span class="nt">&lt;/div&gt;</span>

{# 包含Jquery.js  因为 moment 依赖jquery; 如果用bootstrap 渲染,就不需要引入jquery了 #}
{{ moment.include_jquery() }}

{# 包含moment.js #}
{{ moment.include_moment() }}

{# 设置中文显示 #}
{{ moment.locale('zh-CN') }}
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="扩展知识---为文件上传做准备">扩展知识 - 为文件上传做准备</h2>

<h3 id="利用环境变量设置自用的配置信息">利用环境变量设置自用的配置信息</h3>

<p>目的: 避免将个人隐私信息公布出来, 又可以完成原有的功能</p>

<p>linux命令行设置 环境变量</p>

<ul>
  <li>设置环境变量时,不要用空格</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>设置: <span class="nb">export </span><span class="nv">ABC</span><span class="o">=</span>hello
获取: <span class="nb">echo</span> <span class="nv">$ABC</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>代码中设置和获取环境变量</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span><span class="o">=</span><span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SECRET_KEY'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'123456'</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/env/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">env</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'wangzhe'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'jiangziya'</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'wangzhe'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">"没有ABC 变量"</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="生成随机字符串">生成随机字符串</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">randStr</span><span class="p">(</span><span class="n">lenth</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">base_str</span> <span class="o">=</span> <span class="s">'abcdefghijklnmopgrstuvwxyz1234567890'</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">base_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenth</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/random/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rand</span><span class="p">():</span>

    <span class="k">return</span> <span class="n">randStr</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="生成图片的缩略图-pillow">生成图片的缩略图 <code class="language-plaintext highlighter-rouge">pillow</code></h3>

<p>(1) 安装包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install pillow
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 导入</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c"># 缩略图</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/zoom/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zoom</span><span class="p">():</span>
    
    <span class="c">#打开文件</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'1.jpg'</span><span class="p">)</span>
    <span class="c">#设置尺寸</span>
    <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
    <span class="c">#保存图片</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'2.jpg'</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'缩略图已经生成'</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="flask-文件上传">Flask 文件上传</h2>

<h3 id="原生文件上传">原生文件上传</h3>

<p>目的:</p>

<ul>
  <li>通过设置上传文件的类型, 文件的大小以及上传文件的目录来进行文件上传.</li>
</ul>

<p>原理:</p>

<ul>
  <li>判断上传的文件是否符合大小,类型的要求. 如果符合, 那么就为上传文件生成一个随机的文件名,然后保存在指定的目录下. 然后对该文件生成缩略图,生成的缩略图覆盖原文件. 之后将该图片展示在网页中.</li>
</ul>

<p>步骤:</p>

<p>(1) 写一个路由函数, 再写个HTML模板, 允许上传文件</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'upload.html'</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>{% if img_url %}
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ img_url }}"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    文件上传
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"photo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"上传"</span><span class="nt">&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 设置文件的大小, 目录,文件类型 的配置信息</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="c"># 文件大小的限制, 最大不能超过8M. 只写这行代码就可以限制了, 不需要做其他代码修改</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAX_CONTENT_LENGTH'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span>

<span class="c"># 上传图片的保存路径. 在项目的根目录上需要创建一个 upload 目录</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOAD_FOLDER'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'upload'</span><span class="p">)</span>

<span class="c"># 允许的文件后缀</span>
<span class="n">ALLOW_EXTENSIONS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">'png'</span><span class="p">,</span> <span class="s">'jpg'</span><span class="p">,</span> <span class="s">'jpeg'</span><span class="p">,</span> <span class="s">'gif'</span><span class="p">])</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 写两个函数, 用于生成随机文件名 和 判断上传文件名是否符合规范</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c"># 判断文件中是否有点, 并且后缀是否在 ALLOW_EXTENSIONS 中</span>
<span class="k">def</span> <span class="nf">allow_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'.'</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALLOW_EXTENSIONS</span>

<span class="c"># 随机生成文件名</span>
<span class="k">def</span> <span class="nf">randStr</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">base_str</span> <span class="o">=</span> <span class="s">'abcdefghijklnmopgrstuvwxyz1234567890'</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">base_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(4) 在路由函数中进行判断,</p>

<ul>
  <li>如果满足要求
    <ul>
      <li>就对文件生成随机文件名</li>
      <li>保存</li>
      <li>生成缩略图, 覆盖原文件</li>
      <li>展示图片</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片提交了'</span><span class="p">)</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'photo'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allow_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span> <span class="c"># 判断文件上传了, 且文件名满足上传条件</span>
            <span class="c"># 获取文件后缀, 用于拼接新的随机文件名</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c"># 随机文件名</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">randStr</span><span class="p">()</span><span class="o">+</span><span class="n">postfix</span>
            <span class="c"># 拼接完整路径名</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOAD_FOLDER'</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="c"># 保存文件</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片上传成功了'</span><span class="p">)</span>
            <span class="c"># 生成缩略图</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="c"># 构造图片URL</span>
            <span class="n">img_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'uploaded'</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'upload.html'</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片上传失败了'</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">'图片上传失败'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>完整视图函数文件</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># 文件大小的限制, 最大不能超过8M. 只写这行代码就可以限制了, 不需要做其他代码修改</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAX_CONTENT_LENGTH'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span>

<span class="c"># 上传图片的保存路径. 在项目的根目录上需要创建一个 upload 目录</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOAD_FOLDER'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'upload'</span><span class="p">)</span>

<span class="c"># 允许的文件后缀</span>
<span class="n">ALLOW_EXTENSIONS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">'png'</span><span class="p">,</span> <span class="s">'jpg'</span><span class="p">,</span> <span class="s">'jpeg'</span><span class="p">,</span> <span class="s">'gif'</span><span class="p">])</span>

<span class="c"># 判断文件中是否有点, 并且后缀是否在 ALLOW_EXTENSIONS 中</span>
<span class="k">def</span> <span class="nf">allow_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'.'</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALLOW_EXTENSIONS</span>

<span class="c"># 随机生成文件名</span>
<span class="k">def</span> <span class="nf">randStr</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">base_str</span> <span class="o">=</span> <span class="s">'abcdefghijklnmopgrstuvwxyz1234567890'</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">base_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片提交了'</span><span class="p">)</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'photo'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allow_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span> <span class="c"># 判断文件上传了, 且文件名满足上传条件</span>
            <span class="c"># 获取文件后缀, 用于拼接新的随机文件名</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c"># 随机文件名</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">randStr</span><span class="p">()</span><span class="o">+</span><span class="n">postfix</span>
            <span class="c"># 拼接完整路径名</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOAD_FOLDER'</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="c"># 保存文件</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片上传成功了'</span><span class="p">)</span>
            <span class="c"># 生成缩略图</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="c"># 构造图片URL</span>
            <span class="n">img_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'uploaded'</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'upload.html'</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'图片上传失败了'</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">'图片上传失败'</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'upload.html'</span><span class="p">)</span>


<span class="c"># 访问上传图片</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/uploaded/&lt;filename&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">uploaded</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c"># flask 自带的 安全的发送静态文件 http://127.0.0.1:5000/uploaded/timg-4.jpeg</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOAD_FOLDER'</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>设定上传文件大小需要设定 <code class="language-plaintext highlighter-rouge">app.config['MAX_CONTENT_LENGTH'] = 1024 * 1024 * 8</code></li>
  <li>接收上传的路由要指定 <code class="language-plaintext highlighter-rouge">methods=['POST', 'GET']</code></li>
  <li>上传的文件需要从 <code class="language-plaintext highlighter-rouge">file = request.files.get('photo')</code> 获取</li>
  <li>文件名 是  file.filename</li>
  <li>文件保存需要用 file.save()</li>
  <li>保存路径需要自己拼接 <code class="language-plaintext highlighter-rouge">file.save(os.path.join(app.config['UPLOAD_FOLDER'], file.filename))</code></li>
  <li>用安全的方式在页面展示图片 用 <code class="language-plaintext highlighter-rouge">send_from_directory</code></li>
</ul>

<p><em>模板文件</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>文件上传<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
{% if img_url %}
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ img_url }}"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    文件上传
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"photo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"上传"</span><span class="nt">&gt;</span>

<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>
    <p>form 提交方法必须是 post</p>
  </li>
  <li>上传文件时, <code class="language-plaintext highlighter-rouge">&lt;form&gt;</code> 标签要指定 <code class="language-plaintext highlighter-rouge">enctype="multipart/form-data"</code></li>
  <li>input 类型必须是 file, 且需要指定 name 属性</li>
</ul>

<h3 id="flask-uploads-扩展库可以帮助我们上传文件">flask-uploads 扩展库可以帮助我们上传文件</h3>

<p><a href="http://pythonhosted.org/Flask-Uploads/">官方文档</a></p>

<p>安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-uploads
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>完整视图文件</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_uploads</span> <span class="kn">import</span> <span class="n">UploadSet</span><span class="p">,</span> <span class="n">IMAGES</span><span class="p">,</span> <span class="n">configure_uploads</span><span class="p">,</span> <span class="n">patch_request_class</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_LOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># flask 自己的上传文件位置设置. 中间名字要和 UploadSet('ABC', IMAGES) 第一个参数一致</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOADED_ABC_DEST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'upload'</span><span class="p">,</span> <span class="s">'ABC'</span><span class="p">)</span>

<span class="c"># flask 自己的文件大小限制. 该设置是flask_upload 中设置文件大小的上限</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAX_CONTENT_LENGTH'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

<span class="c"># 创建 flask_upload 上传限制文件上传大小, 默认64M, 如果size=None 则采取 MAX_CONTENT_LENGTH, 也可以自己设定大小.</span>
<span class="n">patch_request_class</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c"># 创建 flask_upload 上传对象, 第一个参数匹配到 app.config['UPLOADED_ABC_DEST'] 中间名(大小写可以无所谓).</span>
<span class="c"># IMAGES = tuple('jpg jpe jpeg png gif svg bmp'.split())</span>
<span class="c"># 除了 IMAGES 之外, 还可以是: TEXT, DOCUMENTS, AUDIO, DATA, SCRIPTS, ARCHIVES, EXECUTABLES</span>
<span class="c"># 不设置第二个参数, 默认是 DEFAULTS = TEXT + DOCUMENTS + IMAGES + DATA</span>
<span class="n">picUp</span> <span class="o">=</span> <span class="n">UploadSet</span><span class="p">(</span><span class="s">'ABC'</span><span class="p">,</span> <span class="n">IMAGES</span><span class="p">)</span>

<span class="c"># 上传对象对app做初始化</span>
<span class="n">configure_uploads</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">picUp</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">img_url</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span> <span class="ow">and</span> <span class="s">'photo'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span> <span class="c">#photo是form中的文件域</span>
        <span class="c"># 保存文件 , 调用</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">picUp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">'photo'</span><span class="p">])</span> <span class="c"># 保存文件同时返回文件名给变量. 该函数可以指定保存路径和保存的文件名</span>
        <span class="c"># 获取上传的文件名</span>
        <span class="n">img_url</span> <span class="o">=</span> <span class="n">picUp</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'testFlaskUpload.html'</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>模板文件同上面的原生模板一样,没有区别</li>
  <li>上传文件的访问路由无需添加, 扩展库自动添加了一个路由</li>
  <li>
    <p>需要先配置上传文件的路径和文件大小</p>
  </li>
  <li>picUp.url(filename) 输出: http://127.0.0.1:5000/_uploads/ABC/timg-4_1.jpeg</li>
  <li>picUp.path(filename) 输出: /Users/dalong/code/python1702/flaskprojects/upload/ABC/timg-4_1.jpeg</li>
  <li>picUp.get_basename(filename) 输出: timg-4_1.jpeg</li>
</ul>

<p><em>模板文件</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>文件上传<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
{% if img_url %}
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ img_url }}"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    文件上传
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"photo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"上传"</span><span class="nt">&gt;</span>

<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="完整上传的代码-包含flask_upload-flask_wtf-flask_bootstrap">完整上传的代码, 包含flask_upload, flask_wtf, flask_bootstrap</h3>

<p><em>视图文件 uploadFinal.py</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">flask_wtf.file</span> <span class="kn">import</span> <span class="n">FileField</span><span class="p">,</span> <span class="n">FileRequired</span><span class="p">,</span> <span class="n">FileAllowed</span>
<span class="kn">from</span> <span class="nn">flask_uploads</span> <span class="kn">import</span> <span class="n">UploadSet</span><span class="p">,</span> <span class="n">IMAGES</span>
<span class="kn">from</span> <span class="nn">flask_uploads</span> <span class="kn">import</span> <span class="n">configure_uploads</span><span class="p">,</span> <span class="n">patch_request_class</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SECRET_KEY'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'123456'</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOADED_PHOTOS_DEST'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAX_CONTENT_LENGTH'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

<span class="n">photos</span> <span class="o">=</span> <span class="n">UploadSet</span><span class="p">(</span><span class="s">'photos'</span><span class="p">,</span> <span class="n">IMAGES</span><span class="p">)</span>
<span class="n">configure_uploads</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">photos</span><span class="p">)</span>
<span class="n">patch_request_class</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UploadForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">FileField</span><span class="p">(</span><span class="s">'头像'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">FileRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">'文件未选择'</span><span class="p">),</span> <span class="n">FileAllowed</span><span class="p">(</span><span class="n">photos</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">'只能上传图片'</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'上传'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">random_string</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">base_str</span> <span class="o">=</span> <span class="s">'abcdefghijklmnopqrstuvwxyz1234567890'</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">base_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>



<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
    <span class="n">img_url</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 获取文件后缀</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">photo</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># 生成随机文件名</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">random_string</span><span class="p">()</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="c"># 保存文件</span>
        <span class="n">photos</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">photo</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="c"># 拼接完整路径名</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOADED_PHOTOS_DEST'</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c"># 打开文件</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="c"># 设置尺寸</span>
        <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="c"># 保存文件</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="c"># 获取URL</span>
        <span class="n">img_url</span> <span class="o">=</span> <span class="n">photos</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'uploadFinal.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>模板文件 uploadFinal.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre>{% extends 'bootstrap/base.html' %}

{% from 'bootstrap/wtf.html' import quick_form %}

{% block title %}完整的文件上传{% endblock %}

{% block content %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>文件上传<span class="nt">&lt;/h1&gt;</span>
        {% if img_url %}
            <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ img_url }}"</span><span class="nt">&gt;</span>
        {% endif %}
        {{ quick_form(form) }}
    <span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="flask-mail-邮件发送">flask-mail 邮件发送</h2>

<p><a href="http://www.pythondoc.com/flask-mail/index.html">官方文档</a></p>

<p>说明: 是一个邮件发送的扩展库, 使用非常简单</p>

<p>安装:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-mail
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="基本的发送功能"><em>基本的发送功能</em></h3>

<p>(1) 导入类库: 一个是邮箱类, 一个是邮件类</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 设置基本的邮箱的配置信息, 创建邮箱对象: 邮箱地址, 用户名, 授权码</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c"># 邮箱的配置, 配置要放在mail 对象前面</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_SERVER'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>  <span class="c"># 邮箱服务器</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>  <span class="c"># 邮箱地址</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_PASSWORD'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'*******'</span>  <span class="c"># 邮箱服务器密码或者授权码</span>

<span class="c"># 创建邮箱对象</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 在路由中设置邮件发送对象并发送邮件</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c"># 创建邮件对象, 包含标题和接收人</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s">'账户激活'</span><span class="p">,</span> <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="s">'37016175@qq.com'</span><span class="p">])</span>
<span class="c"># 发送者</span>
<span class="n">msg</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
<span class="c"># 邮件主体, 包含html 和 纯文本两种, 看收件人邮箱默认选择看哪一种.</span>
<span class="n">msg</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="s">'&lt;h1&gt;hello dalong, 激活点击右边连接&lt;/h1&gt;'</span>
<span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">'hello dalong'</span>
<span class="c"># 发送邮件</span>
<span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>完整代码</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># 邮箱的配置, 配置要放在mail 对象前面</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_SERVER'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>  <span class="c"># 邮箱服务器</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>  <span class="c"># 邮箱地址</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_PASSWORD'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'*******'</span>  <span class="c"># 邮箱服务器密码或者授权码</span>

<span class="c"># 创建邮箱对象</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
  	<span class="c"># 创建邮件对象</span>
  	<span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="s">'账户激活'</span><span class="p">,</span>
        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="s">'37016175@qq.com'</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="s">'hello dalong'</span><span class="p">,</span>
        <span class="n">html</span><span class="o">=</span><span class="s">'&lt;h1&gt;hello dalong, 激活点击右边连接&lt;/h1&gt;'</span><span class="p">,</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c"># 发送邮件</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">'邮件已经发送'</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="重构在刚才的基础上-把邮件内容封装函数使用"><em>重构,在刚才的基础上, 把邮件内容封装函数使用</em></h3>

<p>目的: 需要更灵活的使用邮件发送功能,使用不同模板, 传递不通过参数</p>

<p>原理: 只是将邮件发送部分抽象出来,作为独立函数, 可以接受若干基本参数:</p>

<ol>
  <li>收件人地址</li>
  <li>邮件标题</li>
  <li>邮件主题用的模板</li>
  <li>模板中用到的若干变量</li>
</ol>

<p>实现步骤</p>

<p>(1) 将原来的邮件主体做成两个邮件模板文件.一个是html格式, 一个是纯文本格式</p>

<ul>
  <li>文件内的一些可变文字用变量替换</li>
</ul>

<p><em>password.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>hello {{ name }}, 激活点击右边连接<span class="nt">&lt;/h1&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>password.txt</em></p>

<pre><code class="language-txt">hello {{ name }}, 激活点击右边连接
</code></pre>

<p>(2) 将发送邮件对象的部分合并到一个函数中, 用函数参数代替实体内容.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="c"># 封装函数</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c"># 创建邮件对象</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.txt'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.html'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c"># 发送邮件</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 路由中调用邮件发送函数, 并灵活传递参数</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">send_mail</span><span class="p">(</span><span class="s">'37016175@qq.com'</span><span class="p">,</span> <span class="s">'找回密码'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"大龙"</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>完整代码</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_LOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_SERVER'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>  <span class="c"># 邮箱服务器</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>  <span class="c"># 邮箱地址</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_PASSWORD'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'*******'</span>  <span class="c"># 邮箱服务器密码或者授权码</span>

<span class="c"># 创建邮箱 对象</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="c"># 封装函数</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c"># 创建邮件对象</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.txt'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.html'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c"># 发送邮件</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">send_mail</span><span class="p">(</span><span class="s">'37016175@qq.com'</span><span class="p">,</span> <span class="s">'找回密码'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"大龙"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'邮件已经发送'</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="重构-将发送邮件做到线程里面"><em>重构, 将发送邮件做到线程里面</em></h3>

<p>目的: 让浏览器触发的邮件发送不再同步等待发送结果, 也可以同时发送多封邮件</p>

<p>原理:通过建立线程, 主线程不再需要等待邮件发送结束.</p>

<p>实现步骤:</p>

<p>(1) 导入线程 和 current_app 类库, 并创建一个可以被线程执行的函数.</p>

<ul>
  <li>该函数的作用
    <ul>
      <li>模拟一个app上下文</li>
      <li>然后发送邮件.</li>
    </ul>
  </li>
  <li>两个参数
    <ul>
      <li>app: 第一个参数用于模拟app上下文</li>
      <li>msg: 发送邮件的对象</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="c"># 异步发送邮件</span>
<span class="k">def</span> <span class="nf">async_send_mail</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="c"># 必须在程序的上下文中才能发送邮件. 新建的线程没有, 因此需要手动创建</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>  <span class="c"># 创建程序上下文</span>
        <span class="c"># 在程序上下文中发送邮件</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 实例化线程对象,传递可以上下文的app对象 和 msg 对象, 启动线程</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="c"># 获取原始的app实例, 因为是发邮件是线程, 而线程需要实例上下文才能发送邮件, 所以需要创建一个带有上下文的app实例, 传递给邮件线程函数.</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
<span class="c"># 创建线程对象, 并启动线程</span>
<span class="n">thr</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">async_send_mail</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
<span class="n">thr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>完整代码</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span> <span class="c"># 导入线程类库</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_SERVER'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>  <span class="c"># 邮箱服务器</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>  <span class="c"># 邮箱地址</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_PASSWORD'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'*******'</span>  <span class="c"># 邮箱服务器密码或者授权码</span>

<span class="c"># 创建email 对象</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># 异步发送邮件</span>
<span class="k">def</span> <span class="nf">async_send_mail</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="c"># 必须在程序的上下文中才能发送邮件. 新建的线程没有, 因此需要手动创建</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>  <span class="c"># 创建程序上下文</span>
        <span class="c"># 在程序上下文中发送邮件</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="c"># 封装函数</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c"># 获取原始的app实例, 因为是发邮件是线程, 而线程需要实例上下文才能发送邮件, 所以需要创建一个带有上下文的app实例, 传递给邮件线程函数.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
    <span class="c"># 创建邮件对象</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.txt'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'mailTemplate/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.html'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c"># 创建线程对象, 并启动线程</span>
    <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">async_send_mail</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="c"># 发送邮件的配置, 配置要放在mail 对象前面</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">send_mail</span><span class="p">(</span><span class="s">'37016175@qq.com'</span><span class="p">,</span> <span class="s">'修改邮箱'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">"小龙"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'邮件已经发送'</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>password.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>hello {{ name }}, 激活点击右边连接<span class="nt">&lt;/h1&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>password.txt</em></p>

<pre><code class="language-txt">hello {{ name }}, 激活点击右边连接
</code></pre>

<h2 id="flask-sqlalchemy-操作数据库">Flask-SQLAlchemy 操作数据库</h2>

<p><a href="http://www.pythondoc.com/flask-sqlalchemy/quickstart.html">中文文档</a></p>

<p><a href="http://flask-sqlalchemy.pocoo.org/2.3/">官方文档</a></p>

<h3 id="数据库回顾">数据库回顾</h3>

<ul>
  <li>
    <p>分类：</p>

    <p>关系型数据库：MySQL、sqlite、oracle、MariaDB…</p>

    <p>非关系型数据库：Redis、MongoDB、…</p>
  </li>
  <li>
    <p>选择：</p>

    <p>数据库本身没有好坏，需要根据项目的需要进行选择。</p>
  </li>
</ul>

<h3 id="sqlite介绍">sqlite介绍:</h3>

<ul>
  <li>基本命令和 mysql一样</li>
  <li>不需要单独起服务, 直接可以使用</li>
  <li>不需要创建一个库, 就在一个库中操作各种表</li>
</ul>

<h4 id="sqlite命令行">sqlite命令行:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre>sqlite3 --help
Usage: sqlite3 <span class="o">[</span>OPTIONS] FILENAME <span class="o">[</span>SQL]
FILENAME is the name of an SQLite database. A new database is created
<span class="k">if </span>the file does not previously exist.
OPTIONS include:
   -ascii               <span class="nb">set </span>output mode to <span class="s1">'ascii'</span>
   -bail                stop after hitting an error
   -batch               force batch I/O
   -column              <span class="nb">set </span>output mode to <span class="s1">'column'</span>
   -cmd COMMAND         run <span class="s2">"COMMAND"</span> before reading stdin
   -csv                 <span class="nb">set </span>output mode to <span class="s1">'csv'</span>
   -echo                print commands before execution
   -init FILENAME       <span class="nb">read</span>/process named file
   -[no]header          turn headers on or off
   -help                show this message
   -html                <span class="nb">set </span>output mode to HTML
   -interactive         force interactive I/O
   -line                <span class="nb">set </span>output mode to <span class="s1">'line'</span>
   -list                <span class="nb">set </span>output mode to <span class="s1">'list'</span>
   -lookaside SIZE N    use N entries of SZ bytes <span class="k">for </span>lookaside memory
   -mmap N              default mmap size <span class="nb">set </span>to N
   -newline SEP         <span class="nb">set </span>output row separator. Default: <span class="s1">'\n'</span>
   -nullvalue TEXT      <span class="nb">set </span>text string <span class="k">for </span>NULL values. Default <span class="s1">''</span>
   -pagecache SIZE N    use N slots of SZ bytes each <span class="k">for </span>page cache memory
   -scratch SIZE N      use N slots of SZ bytes each <span class="k">for </span>scratch memory
   -separator SEP       <span class="nb">set </span>output column separator. Default: <span class="s1">'|'</span>
   -stats               print memory stats before each finalize
   -version             show SQLite version
   -vfs NAME            use NAME as the default VFS
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>不输入任何文件名作为参数, 就会默认在当前目录创建一个数据库文件</p>
  </li>
  <li>
    <p>就是一个文件, 直接用python函数调用就可以了</p>
  </li>
</ul>

<p>可以在命令行直接用 sqlite 查看创建的库文件和表内容</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nb">cd</span> /Users/dalong/code/python1702/testDB/
sqlite3 data.sqlite

<span class="c"># 或者不指定参数, 而是直接  sqlite3 进入数据库终端, 然后 输入 .open data.sqlite 获取数据库</span>
sqlite3

</pre></td></tr></tbody></table>
</div>
</div>

<p>基本的sqlite 命令操作</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="p">.</span><span class="k">open</span> <span class="k">data</span><span class="p">.</span><span class="n">sqlite</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">mytest</span><span class="p">(</span>
   <span class="p">...</span><span class="o">&gt;</span> <span class="n">id</span> <span class="n">int</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
   <span class="p">...</span><span class="o">&gt;</span> <span class="n">name</span> <span class="n">String</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
   <span class="p">...</span><span class="o">&gt;</span> <span class="n">age</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">mytest</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'dalong'</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">mytest</span><span class="p">;</span> <span class="o">#</span> <span class="err">输出</span> <span class="mi">1</span><span class="o">|</span><span class="n">dalong</span><span class="o">|</span><span class="mi">15</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>sqlite  数据库命令</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></td><td class="code"><pre><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="n">help</span>
<span class="p">.</span><span class="n">auth</span> <span class="k">ON</span><span class="o">|</span><span class="k">OFF</span>           <span class="k">Show</span> <span class="n">authorizer</span> <span class="n">callbacks</span>
<span class="p">.</span><span class="n">backup</span> <span class="o">?</span><span class="n">DB</span><span class="o">?</span> <span class="n">FILE</span>      <span class="n">Backup</span> <span class="n">DB</span> <span class="p">(</span><span class="k">default</span> <span class="nv">"main"</span><span class="p">)</span> <span class="k">to</span> <span class="n">FILE</span>
<span class="p">.</span><span class="n">bail</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>           <span class="n">Stop</span> <span class="k">after</span> <span class="n">hitting</span> <span class="n">an</span> <span class="n">error</span><span class="p">.</span>  <span class="k">Default</span> <span class="k">OFF</span>
<span class="p">.</span><span class="n">binary</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>         <span class="n">Turn</span> <span class="n">binary</span> <span class="k">output</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span><span class="p">.</span>  <span class="k">Default</span> <span class="k">OFF</span>
<span class="p">.</span><span class="n">cd</span> <span class="n">DIRECTORY</span>          <span class="n">Change</span> <span class="n">the</span> <span class="n">working</span> <span class="n">directory</span> <span class="k">to</span> <span class="n">DIRECTORY</span>
<span class="p">.</span><span class="n">changes</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>        <span class="k">Show</span> <span class="n">number</span> <span class="k">of</span> <span class="k">rows</span> <span class="n">changed</span> <span class="k">by</span> <span class="k">SQL</span>
<span class="p">.</span><span class="k">check</span> <span class="n">GLOB</span>            <span class="n">Fail</span> <span class="n">if</span> <span class="k">output</span> <span class="n">since</span> <span class="p">.</span><span class="n">testcase</span> <span class="n">does</span> <span class="k">not</span> <span class="k">match</span>
<span class="p">.</span><span class="n">clone</span> <span class="n">NEWDB</span>           <span class="n">Clone</span> <span class="k">data</span> <span class="k">into</span> <span class="n">NEWDB</span> <span class="k">from</span> <span class="n">the</span> <span class="k">existing</span> <span class="k">database</span>
<span class="p">.</span><span class="n">databases</span>             <span class="n">List</span> <span class="k">names</span> <span class="k">and</span> <span class="n">files</span> <span class="k">of</span> <span class="n">attached</span> <span class="n">databases</span>
<span class="p">.</span><span class="n">dbinfo</span> <span class="o">?</span><span class="n">DB</span><span class="o">?</span>           <span class="k">Show</span> <span class="n">status</span> <span class="n">information</span> <span class="n">about</span> <span class="n">the</span> <span class="k">database</span>
<span class="p">.</span><span class="n">dump</span> <span class="o">?</span><span class="k">TABLE</span><span class="o">?</span> <span class="p">...</span>      <span class="n">Dump</span> <span class="n">the</span> <span class="k">database</span> <span class="k">in</span> <span class="n">an</span> <span class="k">SQL</span> <span class="n">text</span> <span class="n">format</span>
                         <span class="n">If</span> <span class="k">TABLE</span> <span class="n">specified</span><span class="p">,</span> <span class="k">only</span> <span class="n">dump</span> <span class="n">tables</span> <span class="n">matching</span>
                         <span class="k">LIKE</span> <span class="n">pattern</span> <span class="k">TABLE</span><span class="p">.</span>
<span class="p">.</span><span class="n">echo</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>           <span class="n">Turn</span> <span class="n">command</span> <span class="n">echo</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span>
<span class="p">.</span><span class="n">eqp</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span><span class="o">|</span><span class="k">full</span>       <span class="n">Enable</span> <span class="k">or</span> <span class="n">disable</span> <span class="n">automatic</span> <span class="k">EXPLAIN</span> <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="p">.</span><span class="n">exit</span>                  <span class="n">Exit</span> <span class="n">this</span> <span class="n">program</span>
<span class="p">.</span><span class="k">explain</span> <span class="o">?</span><span class="k">on</span><span class="o">|</span><span class="k">off</span><span class="o">|</span><span class="n">auto</span><span class="o">?</span> <span class="n">Turn</span> <span class="k">EXPLAIN</span> <span class="k">output</span> <span class="k">mode</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span> <span class="k">or</span> <span class="k">to</span> <span class="n">automatic</span>
<span class="p">.</span><span class="n">fullschema</span> <span class="o">?</span><span class="c1">--indent? Show schema and the content of sqlite_stat tables</span>
<span class="p">.</span><span class="n">headers</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>        <span class="n">Turn</span> <span class="n">display</span> <span class="k">of</span> <span class="n">headers</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span>
<span class="p">.</span><span class="n">help</span>                  <span class="k">Show</span> <span class="n">this</span> <span class="n">message</span>
<span class="p">.</span><span class="n">import</span> <span class="n">FILE</span> <span class="k">TABLE</span>     <span class="n">Import</span> <span class="k">data</span> <span class="k">from</span> <span class="n">FILE</span> <span class="k">into</span> <span class="k">TABLE</span>
<span class="p">.</span><span class="n">imposter</span> <span class="k">INDEX</span> <span class="k">TABLE</span>  <span class="k">Create</span> <span class="n">imposter</span> <span class="k">table</span> <span class="k">TABLE</span> <span class="k">on</span> <span class="k">index</span> <span class="k">INDEX</span>
<span class="p">.</span><span class="n">indexes</span> <span class="o">?</span><span class="k">TABLE</span><span class="o">?</span>       <span class="k">Show</span> <span class="k">names</span> <span class="k">of</span> <span class="k">all</span> <span class="n">indexes</span>
                         <span class="n">If</span> <span class="k">TABLE</span> <span class="n">specified</span><span class="p">,</span> <span class="k">only</span> <span class="k">show</span> <span class="n">indexes</span> <span class="k">for</span> <span class="n">tables</span>
                         <span class="n">matching</span> <span class="k">LIKE</span> <span class="n">pattern</span> <span class="k">TABLE</span><span class="p">.</span>
<span class="p">.</span><span class="k">limit</span> <span class="o">?</span><span class="k">LIMIT</span><span class="o">?</span> <span class="o">?</span><span class="n">VAL</span><span class="o">?</span>   <span class="n">Display</span> <span class="k">or</span> <span class="n">change</span> <span class="n">the</span> <span class="n">value</span> <span class="k">of</span> <span class="n">an</span> <span class="n">SQLITE_LIMIT</span>
<span class="p">.</span><span class="n">lint</span> <span class="k">OPTIONS</span>          <span class="n">Report</span> <span class="n">potential</span> <span class="k">schema</span> <span class="n">issues</span><span class="p">.</span> <span class="k">Options</span><span class="p">:</span>
                         <span class="n">fkey</span><span class="o">-</span><span class="n">indexes</span>     <span class="n">Find</span> <span class="n">missing</span> <span class="k">foreign</span> <span class="k">key</span> <span class="n">indexes</span>
<span class="p">.</span><span class="n">log</span> <span class="n">FILE</span><span class="o">|</span><span class="k">off</span>          <span class="n">Turn</span> <span class="n">logging</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span><span class="p">.</span>  <span class="n">FILE</span> <span class="n">can</span> <span class="n">be</span> <span class="n">stderr</span><span class="o">/</span><span class="k">stdout</span>
<span class="p">.</span><span class="k">mode</span> <span class="k">MODE</span> <span class="o">?</span><span class="k">TABLE</span><span class="o">?</span>     <span class="k">Set</span> <span class="k">output</span> <span class="k">mode</span> <span class="k">where</span> <span class="k">MODE</span> <span class="k">is</span> <span class="n">one</span> <span class="k">of</span><span class="p">:</span>
                         <span class="n">ascii</span>    <span class="n">Columns</span><span class="o">/</span><span class="k">rows</span> <span class="n">delimited</span> <span class="k">by</span> <span class="mi">0</span><span class="n">x1F</span> <span class="k">and</span> <span class="mi">0</span><span class="n">x1E</span>
                         <span class="n">csv</span>      <span class="n">Comma</span><span class="o">-</span><span class="n">separated</span> <span class="k">values</span>
                         <span class="k">column</span>   <span class="k">Left</span><span class="o">-</span><span class="n">aligned</span> <span class="n">columns</span><span class="p">.</span>  <span class="p">(</span><span class="n">See</span> <span class="p">.</span><span class="n">width</span><span class="p">)</span>
                         <span class="n">html</span>     <span class="n">HTML</span> <span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span> <span class="n">code</span>
                         <span class="k">insert</span>   <span class="k">SQL</span> <span class="k">insert</span> <span class="n">statements</span> <span class="k">for</span> <span class="k">TABLE</span>
                         <span class="n">line</span>     <span class="n">One</span> <span class="n">value</span> <span class="n">per</span> <span class="n">line</span>
                         <span class="n">list</span>     <span class="k">Values</span> <span class="n">delimited</span> <span class="k">by</span> <span class="nv">"|"</span>
                         <span class="n">quote</span>    <span class="k">Escape</span> <span class="n">answers</span> <span class="k">as</span> <span class="k">for</span> <span class="k">SQL</span>
                         <span class="n">tabs</span>     <span class="n">Tab</span><span class="o">-</span><span class="n">separated</span> <span class="k">values</span>
                         <span class="n">tcl</span>      <span class="n">TCL</span> <span class="n">list</span> <span class="n">elements</span>
<span class="p">.</span><span class="n">nullvalue</span> <span class="n">STRING</span>      <span class="n">Use</span> <span class="n">STRING</span> <span class="k">in</span> <span class="n">place</span> <span class="k">of</span> <span class="k">NULL</span> <span class="k">values</span>
<span class="p">.</span><span class="n">once</span> <span class="n">FILENAME</span>         <span class="k">Output</span> <span class="k">for</span> <span class="n">the</span> <span class="k">next</span> <span class="k">SQL</span> <span class="n">command</span> <span class="k">only</span> <span class="k">to</span> <span class="n">FILENAME</span>
<span class="p">.</span><span class="k">open</span> <span class="o">?</span><span class="k">OPTIONS</span><span class="o">?</span> <span class="o">?</span><span class="n">FILE</span><span class="o">?</span> <span class="k">Close</span> <span class="k">existing</span> <span class="k">database</span> <span class="k">and</span> <span class="n">reopen</span> <span class="n">FILE</span>
                         <span class="n">The</span> <span class="c1">--new option starts with an empty file</span>
<span class="p">.</span><span class="k">output</span> <span class="o">?</span><span class="n">FILENAME</span><span class="o">?</span>     <span class="n">Send</span> <span class="k">output</span> <span class="k">to</span> <span class="n">FILENAME</span> <span class="k">or</span> <span class="k">stdout</span>
<span class="p">.</span><span class="n">print</span> <span class="n">STRING</span><span class="p">...</span>       <span class="n">Print</span> <span class="n">literal</span> <span class="n">STRING</span>
<span class="p">.</span><span class="n">prompt</span> <span class="n">MAIN</span> <span class="k">CONTINUE</span>  <span class="k">Replace</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">prompts</span>
<span class="p">.</span><span class="n">quit</span>                  <span class="n">Exit</span> <span class="n">this</span> <span class="n">program</span>
<span class="p">.</span><span class="k">read</span> <span class="n">FILENAME</span>         <span class="k">Execute</span> <span class="k">SQL</span> <span class="k">in</span> <span class="n">FILENAME</span>
<span class="p">.</span><span class="n">restore</span> <span class="o">?</span><span class="n">DB</span><span class="o">?</span> <span class="n">FILE</span>     <span class="n">Restore</span> <span class="n">content</span> <span class="k">of</span> <span class="n">DB</span> <span class="p">(</span><span class="k">default</span> <span class="nv">"main"</span><span class="p">)</span> <span class="k">from</span> <span class="n">FILE</span>
<span class="p">.</span><span class="n">save</span> <span class="n">FILE</span>             <span class="k">Write</span> <span class="k">in</span><span class="o">-</span><span class="n">memory</span> <span class="k">database</span> <span class="k">into</span> <span class="n">FILE</span>
<span class="p">.</span><span class="n">scanstats</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>      <span class="n">Turn</span> <span class="n">sqlite3_stmt_scanstatus</span><span class="p">()</span> <span class="n">metrics</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span>
<span class="p">.</span><span class="k">schema</span> <span class="o">?</span><span class="n">PATTERN</span><span class="o">?</span>      <span class="k">Show</span> <span class="n">the</span> <span class="k">CREATE</span> <span class="n">statements</span> <span class="n">matching</span> <span class="n">PATTERN</span>
                          <span class="k">Add</span> <span class="c1">--indent for pretty-printing</span>
<span class="p">.</span><span class="n">selftest</span> <span class="o">?</span><span class="c1">--init?     Run tests defined in the SELFTEST table</span>
<span class="p">.</span><span class="n">separator</span> <span class="n">COL</span> <span class="o">?</span><span class="k">ROW</span><span class="o">?</span>   <span class="n">Change</span> <span class="n">the</span> <span class="k">column</span> <span class="n">separator</span> <span class="k">and</span> <span class="n">optionally</span> <span class="n">the</span> <span class="k">row</span>
                         <span class="n">separator</span> <span class="k">for</span> <span class="k">both</span> <span class="n">the</span> <span class="k">output</span> <span class="k">mode</span> <span class="k">and</span> <span class="p">.</span><span class="n">import</span>
<span class="p">.</span><span class="k">session</span> <span class="n">CMD</span> <span class="p">...</span>       <span class="k">Create</span> <span class="k">or</span> <span class="n">control</span> <span class="n">sessions</span>
<span class="p">.</span><span class="n">sha3sum</span> <span class="o">?</span><span class="k">OPTIONS</span><span class="p">...</span><span class="o">?</span>  <span class="n">Compute</span> <span class="n">a</span> <span class="n">SHA3</span> <span class="n">hash</span> <span class="k">of</span> <span class="k">database</span> <span class="n">content</span>
<span class="p">.</span><span class="n">shell</span> <span class="n">CMD</span> <span class="n">ARGS</span><span class="p">...</span>     <span class="n">Run</span> <span class="n">CMD</span> <span class="n">ARGS</span><span class="p">...</span> <span class="k">in</span> <span class="n">a</span> <span class="k">system</span> <span class="n">shell</span>
<span class="p">.</span><span class="k">show</span>                  <span class="k">Show</span> <span class="n">the</span> <span class="k">current</span> <span class="k">values</span> <span class="k">for</span> <span class="n">various</span> <span class="n">settings</span>
<span class="p">.</span><span class="n">stats</span> <span class="o">?</span><span class="k">on</span><span class="o">|</span><span class="k">off</span><span class="o">?</span>        <span class="k">Show</span> <span class="n">stats</span> <span class="k">or</span> <span class="n">turn</span> <span class="n">stats</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span>
<span class="p">.</span><span class="k">system</span> <span class="n">CMD</span> <span class="n">ARGS</span><span class="p">...</span>    <span class="n">Run</span> <span class="n">CMD</span> <span class="n">ARGS</span><span class="p">...</span> <span class="k">in</span> <span class="n">a</span> <span class="k">system</span> <span class="n">shell</span>
<span class="p">.</span><span class="n">tables</span> <span class="o">?</span><span class="k">TABLE</span><span class="o">?</span>        <span class="n">List</span> <span class="k">names</span> <span class="k">of</span> <span class="n">tables</span>
                         <span class="n">If</span> <span class="k">TABLE</span> <span class="n">specified</span><span class="p">,</span> <span class="k">only</span> <span class="n">list</span> <span class="n">tables</span> <span class="n">matching</span>
                         <span class="k">LIKE</span> <span class="n">pattern</span> <span class="k">TABLE</span><span class="p">.</span>
<span class="p">.</span><span class="n">testcase</span> <span class="n">NAME</span>         <span class="k">Begin</span> <span class="n">redirecting</span> <span class="k">output</span> <span class="k">to</span> <span class="s1">'testcase-out.txt'</span>
<span class="p">.</span><span class="n">timeout</span> <span class="n">MS</span>            <span class="n">Try</span> <span class="n">opening</span> <span class="n">locked</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">MS</span> <span class="n">milliseconds</span>
<span class="p">.</span><span class="n">timer</span> <span class="k">on</span><span class="o">|</span><span class="k">off</span>          <span class="n">Turn</span> <span class="k">SQL</span> <span class="n">timer</span> <span class="k">on</span> <span class="k">or</span> <span class="k">off</span>
<span class="p">.</span><span class="n">trace</span> <span class="n">FILE</span><span class="o">|</span><span class="k">off</span>        <span class="k">Output</span> <span class="k">each</span> <span class="k">SQL</span> <span class="k">statement</span> <span class="k">as</span> <span class="n">it</span> <span class="k">is</span> <span class="n">run</span>
<span class="p">.</span><span class="n">vfsinfo</span> <span class="o">?</span><span class="n">AUX</span><span class="o">?</span>         <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="k">level</span> <span class="n">VFS</span>
<span class="p">.</span><span class="n">vfslist</span>               <span class="n">List</span> <span class="k">all</span> <span class="n">available</span> <span class="n">VFSes</span>
<span class="p">.</span><span class="n">vfsname</span> <span class="o">?</span><span class="n">AUX</span><span class="o">?</span>         <span class="n">Print</span> <span class="n">the</span> <span class="n">name</span> <span class="k">of</span> <span class="n">the</span> <span class="n">VFS</span> <span class="n">stack</span>
<span class="p">.</span><span class="n">width</span> <span class="n">NUM1</span> <span class="n">NUM2</span> <span class="p">...</span>   <span class="k">Set</span> <span class="k">column</span> <span class="n">widths</span> <span class="k">for</span> <span class="nv">"column"</span> <span class="k">mode</span>
                         <span class="n">Negative</span> <span class="k">values</span> <span class="k">right</span><span class="o">-</span><span class="n">justify</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="flask-sqlalchemy">flask-sqlalchemy</h3>

<p>说明：</p>

<ul>
  <li>通过了大多数的关系型数据库的支持，而且提供了ORM支持。</li>
</ul>

<p>安装：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip install flask-sqlalchemy
</pre></td></tr></tbody></table>
</div>
</div>

<p>python 中 连接配置语法：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>MySQL：mysql://username:password@host:port/database	<span class="c"># 如果是mysql, 那么数据库需要提前创建好</span>
SQLite：
	windows：sqlite:///c:/path/to/database
	linux：sqlite:////path/to/database
配置选项：SQLALCHEMY_DATABASE_URI
</pre></td></tr></tbody></table>
</div>
</div>

<p>使用方法：</p>

<h4 id="1-导入-sqlalchemy-包并做基本配置然后初始化">(1) 导入 SQLAlchemy 包,并做基本配置,然后初始化</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="c"># 导入类库</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="c"># 连接地址</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>  <span class="c"># 输出: /Users/dalong/code/python1702/testDB</span>
<span class="c"># 配置URI</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'data.sqlite'</span><span class="p">)</span>
<span class="c"># 是否允许sqlite追踪数据库的改变，发出警告，不需要可以禁用(默认开启)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SQLALCHEMY_TRACK_MODIFICATIONS'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># 创建对象</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>以上代码可以在 项目目录下直接创建一个  data.sqlite 文件.</p>
  </li>
  <li>
    <p>uri: <code class="language-plaintext highlighter-rouge">sqlite:////Users/dalong/code/python1702/testDB/data.sqlite</code></p>
  </li>
</ul>

<h4 id="2-设计数据表-数据模型">(2) 设计数据表 数据模型：</h4>

<ul>
  <li>创建一个类, 类需要继承自 <code class="language-plaintext highlighter-rouge">db.Model</code></li>
  <li>每行对应一个字段.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c"># 定义数据模型类</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># 若不指定表名，则默认将模型类名转为'小写+下划线'的形式</span>
    <span class="c"># 例一: 类名(UserModel)，对应的表名(user_model)</span>
    <span class="c"># 例二: 类名(User)，对应的表名(user)</span>
    <span class="c"># 若想指定表名，通过__tablename__属性</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'users'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="3-通过路由-创建删除表">(3) 通过路由 创建删除表：</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/create/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">():</span>
    <span class="c"># 若表已经存在，则不会再次创建，可以先删除再创建</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="c"># 创建所有的表</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">'数据表已创建'</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/drop/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">drop</span><span class="p">():</span>
    <span class="c"># 删除所有的表</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">'数据表已删除'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>创建好后可以通过sqlite3 命令行查看数据库内容 <code class="language-plaintext highlighter-rouge">sqlite3 data.sqlite</code></li>
  <li>也可以在pycharm 中将项目中的data.sqlite文件拖拽到 database 视图中查看</li>
  <li>第一次创建时, 也会创建一些管理表.</li>
  <li>如果表已经存在, 则创建不会成功.</li>
</ul>

<h4 id="4-命令行创建删除表-可以有人机交互-prompt_bool">(4) 命令行创建删除表, 可以有人机交互 <code class="language-plaintext highlighter-rouge">prompt_bool</code>：</h4>

<ul>
  <li>因为通过路由操作数据库有一定风险,尤其是删除操作, 这里提供了另一种方法</li>
  <li>通过  flask_script 中的Manager实例, 为需要通过命令行才能操作的数据库从操作命令加一个装饰器  @manager.command</li>
  <li>在pycharm 的 terminal中直接删除或者创建
    <ul>
      <li><code class="language-plaintext highlighter-rouge">python manage.py createall</code></li>
      <li><code class="language-plaintext highlighter-rouge">python manage.py dropall</code></li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">prompt_bool</span> <span class="c"># 用于命令行人机交互.  </span>

<span class="nd">@manager.command</span>
<span class="k">def</span> <span class="nf">createall</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">'数据表已创建'</span>

<span class="nd">@manager.command</span>
<span class="k">def</span> <span class="nf">dropall</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">prompt_bool</span><span class="p">(</span><span class="s">'您确定删库跑路吗?'</span><span class="p">):</span> <span class="c"># 命令行会提示 : 您确定删库跑路吗?, 回答yes删,否则不删.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">'数据表已删除'</span>
    <span class="k">return</span> <span class="s">'删库有风险，操作需谨慎'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="自定义-flask_script-的-shell命令">自定义 flask_script 的 shell命令</h4>

<ul>
  <li>flask_script 自带了一个 shell 方法, 可以直接在终端里面和代码进行交互.</li>
  <li>shell 执行方法: <code class="language-plaintext highlighter-rouge">python manage.py shell</code></li>
  <li>但是这个方法有一些局限性, 因为默认的shell命令没有任何数据(需要手动导入)</li>
  <li>所以如果需要的话, 可以让shell 带入自定义的上下文</li>
  <li><code class="language-plaintext highlighter-rouge">shell</code> 可以改成任何命令名字</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Shell</span>

<span class="c"># 自定义shell命令，因为默认的shell命令没有任何数据(需要手动导入)</span>
<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="c"># 必须返回一个字典，字典中的所有数据都可以在shell中使用</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>

<span class="c"># 下面代码是用自定义的 'shell' 代替原有shell, 新的shell 带有一个字典参数,包含了需要导入的数据对象</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">'shell'</span><span class="p">,</span> <span class="n">Shell</span><span class="p">(</span><span class="n">make_context</span><span class="o">=</span><span class="n">make_shell_context</span><span class="p">))</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="sqlite-数据的curd操作">SQLite 数据的CURD操作</h3>

<h4 id="增加数据-dbsessionaddfeng-dbsessionadd_allzhong-fei-hui--dbsessioncommit">增加数据 <code class="language-plaintext highlighter-rouge">db.session.add(feng), db.session.add_all([zhong, fei, hui]) , db.session.commit()</code></h4>

<ul>
  <li>添加/修改/删除后必须 commit 才能真正提交</li>
  <li>SQLALCHEMY_COMMIT_ON_TEARDOWN 设置成 True 之后就不需要每次 commit了</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="c"># 在每次请求之后自动提交，否则每次都需要手动提交</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/insert/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insert</span><span class="p">():</span>
    <span class="c"># 创建对象</span>
    <span class="c"># feng = User(username='feng', email='feng@163.com')</span>
    <span class="c"># 添加一天数据到数据库</span>
    <span class="c"># db.session.add(feng)</span>

    <span class="c"># 一次添加多条数据</span>
    <span class="n">zhong</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'zhong'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'zhong@163.com'</span><span class="p">)</span>
    <span class="n">fei</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'fei'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'fei@163.com'</span><span class="p">)</span>
    <span class="n">hui</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'hui'</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s">'hui@163.com'</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">zhong</span><span class="p">,</span> <span class="n">fei</span><span class="p">,</span> <span class="n">hui</span><span class="p">])</span>

    <span class="c"># 提交操作(执行前面的SQL)，每次都要提交，</span>
    <span class="c"># 除非设置SQLALCHEMY_COMMIT_ON_TEARDOWN</span>
    <span class="c"># db.session.commit()</span>
    <span class="k">return</span> <span class="s">'数据已添加'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="根据主键primary_key查询数据-userquerygetuid">根据主键(primary_key)查询数据 <code class="language-plaintext highlighter-rouge">User.query.get(uid)</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/select/&lt;uid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="c"># 根据主键进行查询</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span>
    <span class="k">return</span> <span class="s">'查无此人'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="多种条件查询-userqueryget4-userqueryall-userqueryfilter_byusernamehuifirst">多种条件查询 <code class="language-plaintext highlighter-rouge">User.query.get(4), User.query.all(), User.query.filter_by(username='hui').first(),</code></h4>

<p><em>查询主键是4的数据</em> <code class="language-plaintext highlighter-rouge">get(4)</code></p>

<ul>
  <li>get() 用户查主键id</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>查询所有数据</em>  <code class="language-plaintext highlighter-rouge">all()</code></p>

<ul>
  <li>all() 用户查所有</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
<span class="k">return</span> <span class="s">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>查询用户名是’hui’的用户,只取第一条数据</em> <code class="language-plaintext highlighter-rouge">filter_by()</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">filter_by()</code> 只能用于等值条件(xxx=’yyy’)</li>
  <li>filter_by().filter_by().filter_by() 也可以</li>
  <li><code class="language-plaintext highlighter-rouge">first()</code> 用于返回第一条</li>
  <li>查询结果可以是多条结果</li>
  <li><code class="language-plaintext highlighter-rouge">first()</code> 可以改成  <code class="language-plaintext highlighter-rouge">all()</code></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">'hui'</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>查询用户ID 是4的用户/大于4的用户</em> <code class="language-plaintext highlighter-rouge">filter()</code></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">filter()</code> 可以用于非等值条件查询</li>
  <li>filter 和 filter_by 的区别是filter_by 参数是字段名, filter 参数是数据类名.字段名</li>
  <li>filter() 可以连续使用. 比如filter().filter().filter()</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="nb">id</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="nb">id</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>找到就返回，没有就报错(404)</em></p>

<ul>
  <li>没有数据就让路由返回404 错误</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>
<span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_404</span><span class="p">()</span>
<span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">username</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>统计数据条数</em></p>

<ul>
  <li>返回的数据只能是字符串</li>
  <li>还可以统计最大值, 最小值等数据</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">count</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>完整测试代码</p>

<p><a href="https://www.cnblogs.com/Orangeorchard/p/8133795.html">更多操作, and, or, like, in</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/find/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find</span><span class="p">():</span>
    <span class="c"># 根据主键进行查询</span>
    <span class="c"># u = User.query.get(4)</span>
    <span class="c"># return u.username</span>

    <span class="c"># 查询所有数据</span>
    <span class="c"># users = User.query.all()</span>
    <span class="c"># return ','.join(u.username for u in users)</span>

    <span class="c"># 指定过滤条件（只能是等值条件，可以是多个）</span>
    <span class="c"># u = User.query.filter_by(username='hui').first()</span>
    <span class="c"># return u.email</span>

    <span class="c"># 指定过滤条件（可以指定非等值条件）</span>
    <span class="c"># u = User.query.filter(User.id == 4).first()</span>
    <span class="c"># u = User.query.filter(User.id &gt; 4).first()</span>
    <span class="c"># return u.username</span>

    <span class="c"># 找到就返回，没有就报错(404)</span>
    <span class="c"># u = User.query.get_or_404(8)</span>
    <span class="c"># u = User.query.filter_by(id=4).first_or_404()</span>
    <span class="c"># return u.username</span>

    <span class="c"># 统计</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>todo: 自行测试：<code class="language-plaintext highlighter-rouge">limit、offset、order_by、group_by、paginate</code></em></p>

<h4 id="更新数据--dbsessionaddu">更新数据  <code class="language-plaintext highlighter-rouge">db.session.add(u)</code></h4>

<ul>
  <li>更新操作和新添加数据一样,用 db.session.add()</li>
  <li>参数对象u 修改后, 用 db.session.add() 操作, db 会判断u是否有primary_key. 如果u没有主键 那么就新建, 有就update</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/update/&lt;uid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
        <span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s">'xxx@163.com'</span>
        <span class="c"># 再次添加数据自动会识别为更新操作</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">'数据已修改'</span>
    <span class="k">return</span> <span class="s">'查无此人'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="删除数据--dbsessiondeleteu">删除数据  <code class="language-plaintext highlighter-rouge">db.session.delete(u)</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/delete/&lt;uid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">'数据已删除'</span>
    <span class="k">return</span> <span class="s">'查无此人'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<blockquote>
  <p>真实项目中, 数据库几乎不做物理删除，大多数是通过设置标志位来进行逻辑删除完成特定功能的。</p>
</blockquote>

<h3 id="sqlite-表字段类型-和-字段参数">SQLite 表字段类型 和 字段参数</h3>

<p>常见字段类型</p>

<table>
  <thead>
    <tr>
      <th>字段类型</th>
      <th>Python类型</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Integer</td>
      <td>int</td>
      <td>32位</td>
    </tr>
    <tr>
      <td>SmallInteger</td>
      <td>int</td>
      <td>16位</td>
    </tr>
    <tr>
      <td>BigInteger</td>
      <td>int/long</td>
      <td>不受限制的整数</td>
    </tr>
    <tr>
      <td>Float</td>
      <td>float</td>
      <td>浮点数</td>
    </tr>
    <tr>
      <td>String</td>
      <td>str</td>
      <td>变长字符串</td>
    </tr>
    <tr>
      <td>Text</td>
      <td>str</td>
      <td>变长字符串，做了优化</td>
    </tr>
    <tr>
      <td>Boolean</td>
      <td>bool</td>
      <td>布尔值</td>
    </tr>
    <tr>
      <td>Date</td>
      <td>datetime.date</td>
      <td>日期</td>
    </tr>
    <tr>
      <td>Time</td>
      <td>datetime.time</td>
      <td>时间</td>
    </tr>
    <tr>
      <td>DateTime</td>
      <td>datetime.datetime</td>
      <td>日期时间</td>
    </tr>
    <tr>
      <td>Interval</td>
      <td>datetime.timedelta</td>
      <td>时间间隔</td>
    </tr>
  </tbody>
</table>

<p>常见字段参数</p>

<table>
  <thead>
    <tr>
      <th>选项</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>primary_key</td>
      <td>字段是否作为主键索引，默认为False</td>
    </tr>
    <tr>
      <td>unique</td>
      <td>字段是否作为唯一索引，默认为False</td>
    </tr>
    <tr>
      <td>index</td>
      <td>字段是否作为普通索引，默认为False</td>
    </tr>
    <tr>
      <td>nullable</td>
      <td>字段是否可以为空，默认为True</td>
    </tr>
    <tr>
      <td>default</td>
      <td>为字段指定默认值</td>
    </tr>
  </tbody>
</table>

<h3 id="sqlalchemy-建表和插数据技巧二则">SQLAlchemy 建表和插数据技巧二则：</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>1.插入数据时可以不传值的情况有三种：自增的主键、有默认值的、可以为空的
2.flask-sqlalchemy中要求，每一张表都必须有一个主键，默认为id
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="数据库的迁移-flask-migrate">数据库的迁移 <code class="language-plaintext highlighter-rouge">flask-migrate</code></h3>

<h4 id="概念-">概念 :</h4>

<ul>
  <li>当数据模型更改时，需要将更改已有的数据库，这个过程叫数据库迁移.</li>
</ul>

<p>要求：</p>

<ul>
  <li>直接删除然后再创建有点简单粗暴，副作用有点大(原有的数据全部丢失)；</li>
  <li>要求既能将数据模型的更改应用到数据库，又保留原有的数据</li>
</ul>

<h4 id="安装和配置">安装和配置</h4>

<p>安装 flask-migrate：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-migrate
</pre></td></tr></tbody></table>
</div>
</div>

<p>配置：</p>

<ul>
  <li>先初始化migrate 对象</li>
  <li>然后将MigrateCommand 加到命令行</li>
  <li><code class="language-plaintext highlighter-rouge">dbmgrt</code> 是我们给命令起的名字, 叫什么都可以</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c"># 导入类库</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span><span class="p">,</span> <span class="n">MigrateCommand</span>
<span class="c"># 创建对象</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="c"># 添加数据库迁移命令</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">'dbmgrt'</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="开始迁移分三步">开始迁移分三步：</h4>

<p>注意:</p>

<ul>
  <li>以下命令都是在pycharm 中的 Terminal 中完成</li>
  <li>不是每次迁移都会成功(比如有冲突:修改字段类型,但是数据还没有改变)，若失败需要手动解决</li>
</ul>

<p>(1) <em>初始化</em>数据库迁移的仓库 <code class="language-plaintext highlighter-rouge">init</code></p>

<ul>
  <li>如果重来没迁移过, 那么第一次执行一次就行了</li>
  <li>
    <p>以后的迁移操作都是2和3结合使用</p>
  </li>
  <li>执行后,会发现项目目录下多了一个migrations 的目录</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.7 manage.py dbmgrt init
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) <em>生成迁移SQL 脚本</em>，会根据数据模型与数据表的差异生成SQL语句 <code class="language-plaintext highlighter-rouge">migrate</code></p>

<ul>
  <li>执行后, 在 migrations/versions 下面会生成新的迁移用的脚本</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.7 manage.py dbmgrt migrate
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) <em>执行迁移</em>，就是执行上面生成的SQL语句</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.7 manage.py dbmgrt upgrade
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="练习">练习</h3>

<ul>
  <li>flask项目的目录结构(具有扩展型)</li>
  <li>试着写一下用户的注册、激活、登录等</li>
</ul>

<h2 id="项目练习">项目练习</h2>

<p>项目需求:</p>

<ul>
  <li>用户注册登录</li>
  <li>用户信息管理</li>
  <li>博客发表回复</li>
  <li>博客列表展示</li>
  <li>博客详情展示</li>
  <li>分别显示内容</li>
  <li>点赞, 收藏, 搜索, 统计, 排序…</li>
</ul>

<h3 id="1-利用虚拟环境创建一个pycharm项目-并创建目录">(1) 利用虚拟环境创建一个pycharm项目, 并创建目录</h3>

<h4 id="pycharm-创建创建虚拟s">pycharm 创建创建虚拟s</h4>

<ul>
  <li>方法(1)
    <ul>
      <li>创建虚拟环境 : 在 pycharm 的 terminal 中进行下面的命令</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>pip3.7 install virtualenv <span class="c"># 安装</span>
<span class="c"># 进入项目目录,然后执行下面命令</span>
virtualenv venv <span class="c"># 创建</span>
<span class="nb">source</span> ./venv/bin/activate <span class="c"># 激活</span>
deactivate  <span class="c"># 退出虚拟环境</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>如果要指定虚拟环境的python版本,就需要用  -p</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>virtualenv -p /Library/Frameworks/Python.framework/Versions/3.7/bin/python3.7 env
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>方法(2)
    <ul>
      <li>
        <p>在pycharm 中创建一个新的项目, 直接指定编译环境使用虚拟环境.</p>
      </li>
      <li>
        <p>创建按后再pycharm 中的 terminal 中 pip3.6 list 查看包个数, 没什么东西就证明可用了.</p>
      </li>
    </ul>
  </li>
</ul>

<h4 id="为虚拟环境做依赖的配置信息文件">为虚拟环境做依赖的配置信息文件</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>pip3.7 freeze         <span class="c"># 查看 所有的Pip 环境安装的依赖包列表</span>
pip3.7 freeze &gt; requirements.txt   <span class="c"># 将所有的Pip 环境安装的依赖包导出到文件中</span>
pip3.7 install -r requirements.txt <span class="c"># 读取安装文件来安装 pip 包</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="为项目创建目录结构">为项目创建目录结构</h4>

<p><em>项目结构:</em></p>

<ul>
  <li>做一个项目, 最好提前将项目结构确定好, 项目启动后就不太容易改了.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre>blog/ 				<span class="c"># 项目根目录</span>
	app/			<span class="c"># 程序包目录</span>
		__init__.py
		templates/	<span class="c"># 模板夹</span>
			common/		<span class="c"># 被包含,被继承用的</span>
			errors/		<span class="c"># 报错类的模板</span>
			email/ 		<span class="c"># 邮件模板</span>
			marcos/		<span class="c"># 宏函数</span>
        static/		<span class="c"># 静态文件夹</span>
            img/
            css/
            js/
            upload/
            favicon.ico
		views/		<span class="c"># 蓝本视图函数文件</span>
		models/		<span class="c"># 数据模型文件</span>
		forms/		<span class="c"># form表单类</span>
		config.py	<span class="c"># 配置文件</span>
		email.py	<span class="c"># 其他一些需要用的类或者函数</span>
		extensions.py <span class="c"># 将所有添加的扩展放到一起. 比如 from xxx import xxx 这种代码</span>
		helper.py	<span class="c"># 放通用小函数的文件</span>
	migrations/		<span class="c"># 数据库迁移文件</span>
	tests/			<span class="c"># 测试文件目录</span>
	venv/			<span class="c"># 虚拟环境目录</span>
	requirements.txt# 项目依赖包列表文件. 里面列出来需要 pip 安装的所有包信息
	manage.py		<span class="c"># 启动控制文件</span>
	
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="1-设置项目配置信息-appconfigpy">(1) 设置项目配置信息 <code class="language-plaintext highlighter-rouge">app/config.py</code></h3>

<h4 id="配置文件appconfigpy"><em>配置文件app/config.py</em></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="c"># 通用配置</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>

    <span class="n">TEMPLATES_AUTO_RELOAD</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c"># 秘钥</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
    <span class="c"># 数据库</span>
    <span class="n">SQLALCHEMY_COMMIT_ON_TEARDOWN</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># 邮件</span>
    <span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s">'smtp.163.com'</span>
    <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s">'dalong_coo@163.com'</span>
    <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="s">'*******'</span>
    <span class="c">#上传文件</span>
    <span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>
    <span class="n">UPLOADED_PHOTOS_DEST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'static/upload'</span><span class="p">)</span>

    <span class="c"># 初始化操作, 完成特定环境的初始化</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="c"># 开发环境 - 继承自基本配置</span>
<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'blog-dev.sqlite'</span><span class="p">)</span>

<span class="c"># 测试环境</span>
<span class="k">class</span> <span class="nc">TestConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'blog-test.sqlite'</span><span class="p">)</span>

<span class="c"># 生产环境</span>
<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'sqlite:///'</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'blog.sqlite'</span><span class="p">)</span>
    <span class="c"># 邮件. 因为生产环境有些配置不同,这里要把部分内容重写.</span>
    <span class="n">MAIL_USE_SSL</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">MAIL_PORT</span> <span class="o">=</span> <span class="mi">465</span>

<span class="c"># 配置字典</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'development'</span><span class="p">:</span> <span class="n">DevelopmentConfig</span><span class="p">,</span>
    <span class="s">'testing'</span><span class="p">:</span> <span class="n">TestConfig</span><span class="p">,</span>
    <span class="s">'production'</span><span class="p">:</span> <span class="n">ProductionConfig</span><span class="p">,</span>
    <span class="c"># 默认配置</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="n">DevelopmentConfig</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="2-添加扩展类库">(2) 添加扩展类库</h3>

<h4 id="appextensionspy-中导入扩展并初始化"><code class="language-plaintext highlighter-rouge">app/extensions.py</code> 中导入扩展并初始化</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></td><td class="code"><pre><span class="c"># 导入类库</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span>
<span class="kn">from</span> <span class="nn">flask_uploads</span> <span class="kn">import</span> <span class="n">UploadSet</span>
<span class="kn">from</span> <span class="nn">flask_moment</span> <span class="kn">import</span> <span class="n">Moment</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">LoginManager</span>
<span class="c"># 创建对象</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">()</span>
<span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>

<span class="c"># 初始化扩展</span>
<span class="k">def</span> <span class="nf">config_extensions</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">bs</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">moment</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 用户登录认证</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 指定登陆失败的跳转的路由的端点</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span> <span class="s">'user.login'</span>
    <span class="c"># 设置登录失败的提示信息</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">login_message</span> <span class="o">=</span> <span class="s">'需要登录才能访问'</span>
    <span class="c"># 设置session 的保护级别</span>
    <span class="c"># None: 不使用session 保护, basic: 基本的保护, strong: 最严格的保护</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">session_protection</span> <span class="o">=</span> <span class="s">'strong'</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="3-配置蓝图-在蓝图中增加路由">(3) 配置蓝图, 在蓝图中增加路由</h3>

<h4 id="appviews-下创建蓝本">app/views/ 下创建蓝本</h4>

<p>main.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>

<span class="nd">@main.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'main/index.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="创建-appviews__init__py">创建 <code class="language-plaintext highlighter-rouge">app/views/__init__.py</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">.main</span> <span class="kn">import</span> <span class="n">main</span>
<span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">user</span>


<span class="c"># 蓝本默认配置</span>
<span class="n">DEFAULT_BLUEPRINT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c"># (蓝本, '前缀')</span>
    <span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">'/user'</span><span class="p">)</span>

<span class="p">)</span>


<span class="k">def</span> <span class="nf">config_blueprint</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">blueprint</span><span class="p">,</span> <span class="n">url_prefix</span> <span class="ow">in</span> <span class="n">DEFAULT_BLUEPRINT</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">blueprint</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="n">url_prefix</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="4-初始化配置--app__init__py">(4) 初始化配置  <code class="language-plaintext highlighter-rouge">app/__init__.py</code></h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__init__.py</code> 用于封装 create_app 工厂方法</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">app.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">config_extensions</span>
<span class="kn">from</span> <span class="nn">app.views</span> <span class="kn">import</span> <span class="n">config_blueprint</span>

<span class="c"># 封装一个工厂方法创建app, 并获取配置信息</span>
<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s">'default'</span><span class="p">):</span>

    <span class="c"># 创建实例</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">])</span>
    <span class="c"># 调用初始化配置</span>
    <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 初始化扩展库</span>
    <span class="n">config_extensions</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 配置蓝本</span>
    <span class="n">config_blueprint</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 定制报错信息</span>
    <span class="n">config_errorhandler</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 返回实例</span>
    <span class="k">return</span> <span class="n">app</span>


<span class="k">def</span> <span class="nf">config_errorhandler</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="c"># 再蓝图中定制的报错信息只在蓝图中有效. 如果想全局有效, 需要在 app/__init__.py中定制.</span>
    <span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">err404</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'errors/404.html'</span><span class="p">)</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="5-创建项目基础模板">(5) 创建项目基础模板</h3>

<h4 id="在-apptemplatescommon-中创建basehtml-是最基本的模板">在 app/templates/common 中创建base.html 是最基本的模板</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></td><td class="code"><pre>{% extends 'bootstrap/base.html' %}

{% from 'bootstrap/wtf.html' import quick_form %}

{% block title %}默认标题{% endblock %}

{# 定制导航条 #}
{% block navbar %}
    <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-inverse"</span> <span class="na">style=</span><span class="s">"border-radius: 0px;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span>
                        <span class="na">data-target=</span><span class="s">".navbar-collapse"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{ url_for('main.index') }}"</span><span class="nt">&gt;</span>首页<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>

            <span class="c">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>板块1<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>板块2<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;/ul&gt;</span>
                <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
                {% if current_user.is_authenticated %}
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.logout') }}"</span><span class="nt">&gt;</span>退出<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span>
                           <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>{{ current_user.username }} <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
                        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.profile') }}"</span><span class="nt">&gt;</span>个人信息<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.change_password') }}"</span><span class="nt">&gt;</span>修改密码<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>修改邮箱<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>修改头像<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                        <span class="nt">&lt;/ul&gt;</span>
                    <span class="nt">&lt;/li&gt;</span>
                {% else %}
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.login') }}"</span><span class="nt">&gt;</span>登录<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.register') }}"</span><span class="nt">&gt;</span>注册<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.forget_password') }}"</span><span class="nt">&gt;</span>找回密码<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                {% endif %}
                <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.navbar-collapse --&gt;</span>
        <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.container --&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
{% endblock %}

{# 定制内容 #}
{% block content %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        {% for message in get_flashed_messages() %}
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-warning alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>
                {{ message }}
            <span class="nt">&lt;/div&gt;</span>
        {% endfor %}
        {% block page %}默认内容{% endblock %}
    <span class="nt">&lt;/div&gt;</span>
{% endblock %}


{% block head %}
    {{ super() }}
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">type=</span><span class="s">"image/x-icon"</span> <span class="na">href=</span><span class="s">"{{ url_for('static', filename='favicon.ico') }}"</span> <span class="nt">/&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="创建-404-模板-templateserrors404page">创建 404 模板 templates/errors/404.page</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre>{% extends 'common/base.html' %}

{% block title %}
404报错了
{% endblock %}
{% block content %}
    {% block page %}

    {% endblock %}
    <span class="nt">&lt;h2&gt;</span>报错了<span class="nt">&lt;/h2&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="在-apptemplatesmain-中创建-indexhtml-继承-basehtml">在 app/templates/main 中创建 index.html 继承 base.html</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    首页
{% endblock %}

{% block page %}
    <span class="nt">&lt;h2&gt;</span>首页<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;br&gt;</span>
{% endblock %}

</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="在-appviewsmainpy-中创建路由-调用-indexhtml">在 app/views/main.py 中创建路由 调用 index.html</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>

<span class="nd">@main.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'main/index.html'</span><span class="p">)</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="6-managepy-中-调用-create_app函数-然后启动">(6) <code class="language-plaintext highlighter-rouge">manage.py</code> 中 调用 create_app函数, 然后启动</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c"># 调用工厂方法创建实例</span>
<span class="n">config_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'FLASK_CONFIG'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'default'</span>  <span class="c"># 可以在环境变量中设置 FLASK_CONFIG = production. 目的是为了不改代码</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">)</span>

<span class="c">#@app.route('/')</span>
<span class="c">#def index():</span>
<span class="c">#    return 'ok'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>启动服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.7 manage.py  runserver -r -d -h 0.0.0.0
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="邮件发送">邮件发送</h3>

<p><code class="language-plaintext highlighter-rouge">app/email.py</code> 创建 email 代码 , 导入相关依赖</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>


<span class="c"># 异步发送邮件</span>
<span class="k">def</span> <span class="nf">async_send_mail</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="c"># 必须在程序上下文中才能发送邮件，新建的线程没有，因此需要手动创建</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="c"># 发送邮件</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c"># 获取原始的app实例, 因为是发邮件是线程, 而线程需要实例上下文才能发送邮件, 所以需要创建一个带有上下文的app实例, 传递给邮件线程函数.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
    <span class="c"># 创建邮件对象</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
        <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'email/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.txt'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s">'email/'</span><span class="o">+</span><span class="n">template</span><span class="o">+</span><span class="s">'.html'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAIL_USERNAME'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c"># 创建线程对象, 并启动线程</span>
    <span class="k">return</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">async_send_mail</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="用户管理模块">用户管理模块</h3>

<p>需求: 注册-&gt;激活-&gt;登录认证-&gt;用户信息管理</p>

<h4 id="用户注册-登录-找回密码-修改密码-个人中心">用户注册, 登录, 找回密码, 修改密码, 个人中心</h4>

<p><em>添加注册的视图文件</em> <code class="language-plaintext highlighter-rouge">app/views/user.py</code></p>

<ul>
  <li>我犯的错误: form = RegisterForm() 忘了括号</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">RegisterForm</span><span class="p">,</span> <span class="n">LoginForm</span><span class="p">,</span> <span class="n">ChangePWDForm</span><span class="p">,</span> <span class="n">ForgetPWDForm</span><span class="p">,</span> <span class="n">RenewPWDForm</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">TimedJSONWebSignatureSerializer</span> <span class="k">as</span> <span class="n">Serializer</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">app.email</span> <span class="kn">import</span> <span class="n">send_mail</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">login_user</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'user'</span> <span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>


<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/register/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 根据表单数据创建用户对象</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c"># 将用户提交数据保存到数据库中</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>  <span class="c"># 此时还没有ID</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c"># 手动提交</span>
        <span class="c"># 生成token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">generate_activate_token</span><span class="p">()</span>
        <span class="c"># 发送激活邮件到注册邮箱, 需要用户点击激活连接</span>
        <span class="n">send_mail</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">'账户激活'</span><span class="p">,</span> <span class="s">'activate'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="c"># flash 用户, 提示下一步操作</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'注册成功, 请到邮箱激活,完成注册'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/register.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="c"># 用户激活</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/active/&lt;token&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">check_token_for_user_active</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'激活成功'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.login'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'激活失败'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>



<span class="c"># 用户登录</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 根据用户名查找用户</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'用户不存在'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'账户尚未激活, 请激活后再登录'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c"># 登录, 并完成状态记录中</span>
            <span class="n">login_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">remember_me</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'登录成功'</span><span class="p">)</span>
            <span class="c"># 跳转到URL中 next 参数对应的路由</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'next'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'无效的密码'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="c"># 退出登录</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/logout/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="c"># 退出当前已经登录的用户</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'您已经退出登录'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>


<span class="c"># 个人中心</span>

<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/profile/'</span><span class="p">)</span>
<span class="c"># 登录路由保护</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/profile.html'</span><span class="p">)</span>


<span class="c"># 修改密码</span>

<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/change_password/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">change_password</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ChangePWDForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 匹配原密码是否正确</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">oldpwd</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'原密码:'</span><span class="o">+</span><span class="n">form</span><span class="o">.</span><span class="n">oldpwd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">current_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'密码修改成功'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/change_password.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="c"># 找回密码</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/forget_password/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">forget_password</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ForgetPWDForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
            <span class="c"># 发送重置密码的函数</span>
            <span class="c"># 生成token</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">generate_activate_token</span><span class="p">()</span>
            <span class="c"># 发送重置密码邮件到注册邮箱, 需要用户点击重置连接</span>
            <span class="n">send_mail</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">'密码重置'</span><span class="p">,</span><span class="s">'forget_password'</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'重置密码邮件已经发送到您的邮箱, 请及时查收'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'您输入的邮箱信息有误,请重新尝试输入您注册时用的邮箱'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/forget_password.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="c"># 重置新密码: 确认用户token ,如果正确,跳转到密码重置页.</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/renew_token_check/&lt;token&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">renew_token_check</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="c"># 验证token</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">check_token_for_renew_password</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
        <span class="c"># 登录</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'请您尽快更新您的密码'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.renew_password'</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">"您的token 信息有误, 请重新尝试找回密码"</span>



<span class="c"># 重置密码</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/renew_password/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span><span class="s">'GET'</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">renew_password</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RenewPWDForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 匹配原密码是否正确</span>
            <span class="n">current_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'密码修改成功'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/renew_password.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p><em>添加表单类 app/forms/user.py</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span><span class="p">,</span> <span class="n">SubmitField</span><span class="p">,</span> <span class="n">BooleanField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">EqualTo</span><span class="p">,</span> <span class="n">Length</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c"># 用户注册表单</span>
<span class="k">class</span> <span class="nc">RegisterForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'用户名'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"用户名不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"字符只能是1~12位字符之间"</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'密码'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"密码长度是1~20字符之间"</span><span class="p">)])</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'确认密码'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"确认密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"确认密码长度是1~20字符之间"</span><span class="p">),</span> <span class="n">EqualTo</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"两次密码不一致"</span><span class="p">)])</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"邮箱"</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">Email</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"邮箱不能为空"</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"提交"</span><span class="p">)</span>

    <span class="c"># 自定义用户名验证器</span>
    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">'用户名已注册,请选用其他名称'</span><span class="p">)</span>

    <span class="c"># 自定义邮箱验证器</span>
    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">'邮箱已注册使用,请选用其他名称'</span><span class="p">)</span>


<span class="c"># 用户登录表单</span>
<span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'用户名'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"用户名不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"字符只能是1~12位字符之间"</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'密码'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"密码长度是1~20字符之间"</span><span class="p">)])</span>
    <span class="n">remember_me</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'记住我'</span><span class="p">)</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"提交"</span><span class="p">)</span>



<span class="c"># 修改密码</span>
<span class="k">class</span> <span class="nc">ChangePWDForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">oldpwd</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'原密码'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">'请输入原密码'</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="s">"密码长度为1~12个字符之间"</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'密码'</span><span class="p">,</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"密码长度是1~20字符之间"</span><span class="p">)])</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'确认密码'</span><span class="p">,</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"确认密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"确认密码长度是1~20字符之间"</span><span class="p">),</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"两次密码不一致"</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"提交"</span><span class="p">)</span>


<span class="c"># 重置密码</span>
<span class="k">class</span> <span class="nc">RenewPWDForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'密码'</span><span class="p">,</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"密码长度是1~20字符之间"</span><span class="p">)])</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'确认密码'</span><span class="p">,</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"确认密码不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"确认密码长度是1~20字符之间"</span><span class="p">),</span><span class="n">EqualTo</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">"两次密码不一致"</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"提交"</span><span class="p">)</span>


<span class="c"># 找回密码</span>
<span class="k">class</span> <span class="nc">ForgetPWDForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'请输入注册时使用的邮箱地址'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">Email</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"邮箱不能为空"</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'提交'</span><span class="p">)</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p><em>app/forms/<strong>init</strong>.py 文件</em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">RegisterForm</span><span class="p">,</span> <span class="n">LoginForm</span><span class="p">,</span> <span class="n">ChangePWDForm</span><span class="p">,</span> <span class="n">ForgetPWDForm</span><span class="p">,</span> <span class="n">RenewPWDForm</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/register.html</em></p>

<ul>
  <li>我犯的错误: {{ quick_form(form) }} 用双大括号</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    注册
{% endblock %}


{% block page %}
    <span class="nt">&lt;h2&gt;</span>注册<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    {{ quick_form(form) }}
{% endblock %}


</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/login.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    登录
{% endblock %}

{% block page %}
    <span class="nt">&lt;h2&gt;</span>登录<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    {{ quick_form(form) }}
{% endblock %}

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/forget_password.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
找回密码
{% endblock %}
{% block page %}
    <span class="nt">&lt;h2&gt;</span>找回密码<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    {{ quick_form(form) }}
{% endblock %}

</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/change_password.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
修改密码
{% endblock %}

{% block page %}
    <span class="nt">&lt;h2&gt;</span>修改密码<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    {{ quick_form(form) }}
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/renew_password.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
重置密码
{% endblock %}
{% block page %}
    <span class="nt">&lt;h2&gt;</span>重置密码<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;hr&gt;</span>
    {{ quick_form(form) }}
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>templates/user/profile.html</em></p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    个人中心
{% endblock %}

{% block page %}
    <span class="nt">&lt;h1&gt;</span>个人信息显示<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"username"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"{{ current_user.username }}"</span> <span class="na">readonly</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>邮箱<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"email"</span> <span class="na">value=</span><span class="s">"{{ current_user.email }}"</span> <span class="na">readonly</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
{% endblock %}


</pre></td></tr></tbody></table>
</div>
</div>

<p><em>/models/user.py 添加数据库模型, 并对密码的存储进行单独设置</em></p>

<ul>
  <li>这里的密码hash 是单向机密,不能解密</li>
  <li>还需要将账户激活的在这里定义</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></td><td class="code"><pre><span class="c"># 老师说这里要单独导入db 扩展, 因为下面代码要用到</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">login_manager</span>
<span class="c"># 一个python 自带的密码加密包, 感觉代替了传统的md5加密</span>
<span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">TimedJSONWebSignatureSerializer</span> <span class="k">as</span> <span class="n">Serializer</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">UserMixin</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'users'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">confirmed</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># 密码属性的保护</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">AttributeError</span><span class="p">(</span><span class="s">'密码是不可读的'</span><span class="p">)</span>

    <span class="c"># 设置密码加密, 加密后保存</span>
    <span class="nd">@password.setter</span>
    <span class="k">def</span> <span class="nf">password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>


    <span class="c"># 校验密码的函数</span>
    <span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="c"># 如果校验成功返回True , 否则返回 False</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>


    <span class="c"># 生成账户激活的token</span>
    <span class="k">def</span> <span class="nf">generate_activate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expires_in</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="c"># 生成一个加密字符串</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">],</span> <span class="n">expires_in</span><span class="o">=</span><span class="n">expires_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="nb">id</span><span class="p">})</span>

    <span class="c"># 获取token, 解密token, 然后激活账户</span>
    <span class="c"># 这里需要设置成静态方法, 因为激活前,还不知道用户是谁</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_token_for_user_active</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">check_active_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="p">:</span>
            <span class="c"># 没找到用户信息,异常情况</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># 确认没激活的时候就激活</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>


    <span class="c"># 获取token, 解密token, 然后重置密码</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_token_for_renew_password</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">check_active_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="p">:</span>
            <span class="c"># 没找到用户信息,异常情况</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># 确认是用户本人的token, 返回u, 让用户自己去修改密码</span>
        <span class="k">return</span> <span class="n">u</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_active_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 解密字符串, 可以生成一个字典</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'id'</span><span class="p">])</span>






<span class="c"># 登录认证的回调函数, 通过UID 获得用户的完整信息</span>
<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">loader_user</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>注意:</p>

<ul>
  <li>设计完数据模型, 不要忘记迁移操作</li>
  <li>新建的模型必须要让外部看到，否则迁移时没有办法实现</li>
</ul>

<p><em>创建 <code class="language-plaintext highlighter-rouge">app/models/__init__.py</code></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">.user</span> <span class="kn">import</span> <span class="n">User</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>为 email 函数创建创建邮件模板</em></p>

<p>templates/email/activate.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nt">&lt;h1&gt;</span>hello {{ username }} <span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>请点击右侧 <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.active', token=token, _external=True) }}"</span><span class="nt">&gt;</span>连接<span class="nt">&lt;/a&gt;</span> 激活<span class="nt">&lt;/p&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>templates/email/activate.text</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>hello {{ username }}
请复制右侧 {{ url_for('user.active', token=token, _external=True) }} 连接 激活
</pre></td></tr></tbody></table>
</div>
</div>

<p>templates/email/forget_password.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nt">&lt;h2&gt;</span>{{ username }} 您好. 请点击下面链接重置您的密码<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for('user.renew_token_check', token=token, _external=True) }}"</span><span class="nt">&gt;</span>重置密码<span class="nt">&lt;/a&gt;</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>templates/email/forget_password.txt</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>{{ username }} 您好. 请拷贝下面链接到您的浏览器中完成重置密码
{{ url_for('user.renew_token_check', token=token, _external=True) }}
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="执行数据迁移命令"><em>执行数据迁移命令</em></h4>

<ul>
  <li>如果第一步或者第二部失败了, 需要手动删掉 migrations 目录,然后再重头来</li>
  <li>迁移成功可以看到migrtions/versions 和 app/blog-dev.sqlite</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>python3.7 manage.py dbmgrt init
python3.7 manage.py dbmgrt migrate
python3.7 manage.py dbmgrt upgrade
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="用户登录认证">用户登录认证</h3>

<p>用户认证的逻辑:</p>

<p>(1)</p>

<ul>
  <li>
    <p>添加点击跳转链接</p>
  </li>
  <li>
    <p>添加登录视图函数</p>
  </li>
  <li>
    <p>添加模板文件</p>
  </li>
  <li>
    <p>视图函数添加校验逻辑</p>
  </li>
  <li>
    <p>flask-login</p>

    <p>配置：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">config_extensions</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
	<span class="o">...</span>
	<span class="c"># 用户登录认证管理</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c"># 指定登录的端点(视图函数)</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span> <span class="s">'user.login'</span>
    <span class="c"># 需要登录的提示信息</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">login_message</span> <span class="o">=</span> <span class="s">'需要登录才可访问'</span>
    <span class="c"># 设置session的保护级别</span>
    <span class="c"># None：不使用session保护；'basic'：基本的(默认)；'strong'：最严格的</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">session_protection</span> <span class="o">=</span> <span class="s">'strong'</span>
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>修改model类：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">UserMixin</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
	<span class="k">pass</span>
    
<span class="c"># 登录认证的回调</span>
<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">loader_user</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>  
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>完整的登录处理</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="nd">@user.route</span><span class="p">(</span><span class="s">'/login/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 根据用户名查找用户</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'无效的用户名'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'账户尚未激活，请激活后再登录'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c"># 用户登录，顺便可以完成'记住我'的功能</span>
            <span class="n">login_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">remember</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'登录成功'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'next'</span><span class="p">)</span> <span class="ow">or</span> 
                            <span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'无效的密码'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>退出登录及路由保护</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="c"># 退出登录</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/logout/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="c"># 退出当前登录的用户</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'您已退出登录'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
      
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/profile/'</span><span class="p">)</span>
<span class="c"># 路由保护(需要登录才可访问)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/profile.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li></li>
</ul>

<h3 id="flask_login总结">flask_login总结</h3>

<blockquote>
  <p>获取状态:</p>

  <ul>
    <li>登录认证: is_authenticated</li>
    <li>匿名状态: is_anonymous</li>
  </ul>

  <p>改变状态:</p>

  <ul>
    <li>login_user: 未登录 -&gt; 登录</li>
    <li>logout_user: 登录 -&gt; 未登录</li>
  </ul>

  <p>路由保护:</p>

  <ul>
    <li>login_required</li>
  </ul>

  <p>记住我:</p>

  <ul>
    <li>login_user(u, remember=form.remember_me.data)</li>
  </ul>
</blockquote>

<p>练习:</p>

<ul>
  <li>修改密码:</li>
  <li>找回密码: 需要带着一个加密的字符串(带上用户信息), 在登录位置添加</li>
  <li>修改邮箱: 需要邮箱认证</li>
  <li>
    <p>修改头像: 需要修改数据模型</p>
  </li>
  <li>
    <p>修改密码</p>

    <div class="language-text highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>1.添加点击跳转链接
2.添加对应的视图函数，渲染指定的模板文件
3.添加模板文件，渲染一个表单(原密码、新密码、确认密码)
4.校验后修改密码
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>找回密码</p>

    <div class="language-text highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>1.在登录页面添加点击跳转的链接
2.添加视图函数渲染指定模板(用户名或邮箱)
3.提交后校验确定用户，向其注册的邮箱发送一封邮件(携带个人信息)
4.点击邮件中的链接跳转处理，校验token后，渲染一个设置密码的表单
5.点击提交后保存新密码
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>修改邮箱</p>

    <div class="language-text highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>1.添加点击跳转的链接，添加视图函数，渲染指定模板
2.模板中显示一个表单，填入新的邮箱地址(为了安全可以要求输入用户密码)
3.提交后检验，向新的邮箱发送一封邮件(包含用户信息、新的邮箱)
4.点击邮件中的链接，校验token，将邮箱更换
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li></li>
</ul>

<h4 id="换头像的代码">换头像的代码:</h4>

<p>上传头像</p>

<div class="language-text highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>1.添加点击链接、添加视图函数、渲染指定模板
2.添加flask-uploads扩展配置
3.创建头像上传表单类
4.上传文件处理(随机文件名、缩略图、保存到数据库，删除原来头像)
5.修改用户模型(添加icon字段用于保存头像文件名)
</pre></td></tr></tbody></table>
</div>
</div>

<p>视图函数 app/views/user.py：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">app.helper</span> <span class="kn">import</span> <span class="n">random_string</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">photos</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c"># 上传/修改头像</span>
<span class="nd">@user.route</span><span class="p">(</span><span class="s">'/icon/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">icon</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">IconForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c"># 获取上传头像, 获取随机文件名, 保存新头像</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">random_string</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">photos</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">icon</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">photos</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="c"># 生成缩略图</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">photos</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">img</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">photos</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c"># 删除原有头像</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">icon</span> <span class="o">!=</span> <span class="s">'default_icon.jpeg'</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'UPLOADED_PHOTOS_DEST'</span><span class="p">],</span> <span class="n">current_user</span><span class="o">.</span><span class="n">icon</span><span class="p">))</span>
        <span class="c"># 保存新头像到数据库</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
        <span class="c"># 提示上传完成</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'头像已经成功保存'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.icon'</span><span class="p">))</span>
    <span class="n">img_url</span> <span class="o">=</span> <span class="n">photos</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">icon</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'user/icon.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">img_url</span><span class="o">=</span><span class="n">img_url</span><span class="p">)</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>app/templates/user/icon.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    用户头像
{% endblock %}
{% block page %}
    <span class="nt">&lt;h2&gt;</span>用户头像<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    {% if img_url %}<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ img_url }}"</span><span class="nt">&gt;</span>{% endif %}
    {{ quick_form(form) }}
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>修改扩展包信息 app/extensions.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_uploads</span> <span class="kn">import</span> <span class="n">UploadSet</span><span class="p">,</span> <span class="n">IMAGES</span><span class="p">,</span> <span class="n">configure_uploads</span><span class="p">,</span> <span class="n">patch_request_class</span>
<span class="n">photos</span> <span class="o">=</span> <span class="n">UploadSet</span><span class="p">(</span><span class="s">'photos'</span><span class="p">,</span> <span class="n">IMAGES</span><span class="p">)</span>

<span class="c"># 初始化扩展</span>
<span class="k">def</span> <span class="nf">config_extensions</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="c"># 上传文件</span>
    <span class="n">configure_uploads</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">photos</span><span class="p">)</span>
    <span class="n">patch_request_class</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>修改配置信息 app/config.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c">#上传文件</span>
<span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>
<span class="n">UPLOADED_PHOTOS_DEST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'static/upload'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>上传头像表单app/forms/user.py：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_wtf.file</span> <span class="kn">import</span> <span class="n">FileField</span><span class="p">,</span> <span class="n">FileAllowed</span><span class="p">,</span> <span class="n">FileRequired</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">photos</span>

<span class="k">class</span> <span class="nc">IconForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="n">FileField</span><span class="p">(</span><span class="s">'头像'</span><span class="p">,</span> 
                     <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">FileRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">'请选择文件'</span><span class="p">),</span> 
                     <span class="n">FileAllowed</span><span class="p">(</span><span class="n">photos</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">'只能上传图片'</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'上传'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>修改用户模型app/models/user.py：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c"># 头像</span>
	<span class="n">icon</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s">'default_icon.jpeg'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>迁移数据库</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>python3.7 manage.py db migrate
python3.7 manage.py db upgrade
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="博客管理">博客管理:</h3>

<p>步骤:</p>

<p>添加博客表数据模型</p>

<p>app/models/posts.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="kn">from</span>  <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">Posts</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'posts'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">rid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">)</span>
    <span class="c"># 外键关联user表, 有了外键, users 表就可以做引用了.</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'users.id'</span><span class="p">))</span>  <span class="c"># 和users.id 进行外键关联</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p>app/models/user.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c"># 在关联模型中添加反向引用, 模型是Post, 只有在需要数据的时候才读取, 所以是 dynamic</span>
    <span class="c"># 参数1: 关联模型</span>
    <span class="c"># 参数2: 反向引用的名称, 比如: p.user.icon 就是在调用博客信息是,直接可以从博客的表中获取user的图标信息</span>
    <span class="c"># 参数3: 加载方式, dynamic 表示动态加载</span>
    <span class="c"># 参数4: 设定表关系, 该参数可选</span>
    <span class="c"># 关系: 1对1(uselist=False), 1对多(uselist=True), 多对多</span>
    <span class="c"># 使用方法: u.posts.all()</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">'Posts'</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">'user'</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'dynamic'</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>app/models/<strong>init</strong>.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">.posts</span> <span class="kn">import</span> <span class="n">Posts</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>迁移</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>python3.7 manage.pdb  migrate

python3.7 manage.pdb upgrade
</pre></td></tr></tbody></table>
</div>
</div>

<p>app/forms/posts.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">TextAreaField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Length</span>

<span class="k">class</span> <span class="nc">PostsForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="c"># render_kw: 要渲染的html标签字段的属性字典</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextAreaField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">"这一刻的想法"</span><span class="p">,</span>  <span class="n">render_kw</span><span class="o">=</span><span class="p">{</span><span class="s">'placeholder'</span><span class="p">:</span> <span class="s">'这一刻的想法...'</span><span class="p">},</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">"内容不能为空"</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">'字符限定在3 ~ 140个字符之间'</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'提交'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>app/forms/<strong>init</strong>.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">.posts</span> <span class="kn">import</span> <span class="n">PostsForm</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>app/views/main.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">PostsForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Posts</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>


<span class="nd">@main.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostsForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'发表成功'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'请先登录再发表'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.login'</span><span class="p">))</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">Posts</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">rid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Posts</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'main/index.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">)</span>


</pre></td></tr></tbody></table>
</div>
</div>

<p>app/templates/main/index.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td class="code"><pre>{% extends 'common/base.html' %}
{% block title %}
    首页
{% endblock %}

{% block page %}
    {{ quick_form(form) }}
    {% for p in posts %}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media-left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;img</span> <span class="na">class=</span><span class="s">"media-object"</span> <span class="na">src=</span><span class="s">"{{ url_for('static', filename='upload/'+p.user.icon) }}"</span> <span class="na">alt=</span><span class="s">"icon"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media-body"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>发表于: {{ moment(p.timestamp).fromNow() }}<span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"media-heading"</span><span class="nt">&gt;</span>{{ p.user.username }}<span class="nt">&lt;/h4&gt;</span>
                {{ p.content }}
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    {% endfor %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ moment.include_moment() }}
    {{ moment.locale('zh-CN') }}
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="分页功能--flask_sqlalchemy-的--paginate-扩展包">分页功能- flask_SQLalchemy 的  <code class="language-plaintext highlighter-rouge">paginate</code> 扩展包</h3>

<h4 id="分页查询介绍paginate">分页查询介绍:paginate</h4>

<p>概念:paginate 是一个 SQLAlchemy 的一个方法, 会返回一个分页对象</p>

<ul>
  <li>返回结果是一个分页对象,叫做 <code class="language-plaintext highlighter-rouge">Pagination</code> 包含了所有分页信息</li>
</ul>

<p>参数:</p>

<ul>
  <li>page: 必选, 当前页号</li>
  <li>per_page: 可选, 每页显示条数, 不指定,默认是20条</li>
  <li>error_out: 可选, 当页码超出可选范围时是否报错, 默认是True 404错误. 可改成 False</li>
  <li>返回值:  返回分页对象 <code class="language-plaintext highlighter-rouge">Pagination</code>
    <ul>
      <li>Pagination 属性
        <ul>
          <li>items: 当前页数据</li>
          <li>page: 当前页号</li>
          <li>pages: 总共多少页</li>
          <li>total: 总记录条数</li>
          <li>per_page: 每页显示条数</li>
          <li>prev_num: 上页页码</li>
          <li>next_num: 下页页码</li>
          <li>has_prev: 是否有上一页</li>
          <li>has_next: 是否有下一页</li>
        </ul>
      </li>
      <li>Pagination 方法
        <ul>
          <li>prev: 上一页的分页对象</li>
          <li>next: 下一页的分页对象</li>
          <li>iter_pages: 是一个迭代器, 返回的是导航条上显示的页码号, 如果页数太多, 显示不完的页码, 显示None</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="将分页封装做成一个宏-用于显示分页条">将分页封装做成一个宏, 用于显示分页条</h4>

<p>创建宏 app/templates/common/marco.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre>{# 分页宏 #}
{% macro pagination_show(pagination, endpoint) %}
    <span class="nt">&lt;nav</span> <span class="na">aria-label=</span><span class="s">"Page navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"pagination"</span><span class="nt">&gt;</span>
            {# 上一页的按钮 #}
            <span class="nt">&lt;li</span> <span class="err">{%</span> <span class="na">if</span> <span class="na">not</span> <span class="na">pagination</span><span class="err">.</span><span class="na">has_prev</span> <span class="err">%}</span><span class="na">class=</span><span class="s">"disabled"</span><span class="err">{%</span> <span class="na">endif</span> <span class="err">%}</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% if pagination.has_prev %}{{ url_for(endpoint, page=pagination.prev_num, **kwargs) }}  {% else %}#{% endif %} "</span> <span class="na">aria-label=</span><span class="s">"Previous"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;laquo;</span><span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            {# 中间页码 #}
            {% for p in pagination.iter_pages() %}
                {% if p %}
                    <span class="nt">&lt;li</span> <span class="err">{%</span> <span class="na">if</span> <span class="na">p=</span><span class="s">=pagination.page</span> <span class="err">%}</span> <span class="na">class=</span><span class="s">"active"</span> <span class="err">{%</span> <span class="na">endif</span> <span class="err">%}</span> <span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url_for(endpoint, page=p, **kwargs) }}"</span><span class="nt">&gt;</span>{{ p }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                {% else %}
                    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span><span class="ni">&amp;hellip;</span><span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
                {% endif %}
            {% endfor %}


            {# 下一页的按钮 #}
            <span class="nt">&lt;li</span> <span class="err">{%</span> <span class="na">if</span> <span class="na">not</span> <span class="na">pagination</span><span class="err">.</span><span class="na">has_next</span> <span class="err">%}</span><span class="na">class=</span><span class="s">"disabled"</span><span class="err">{%</span> <span class="na">endif</span> <span class="err">%}</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% if pagination.has_next %}{{ url_for(endpoint, page=pagination.next_num, **kwargs) }}{% else %}#{% endif %}"</span> <span class="na">aria-label=</span><span class="s">"Next"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;raquo;</span><span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/nav&gt;</span>
{% endmacro %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>调用宏 app/templates/main/index.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre>{% extends 'common/base.html' %}

{% from 'common/macro.html' import pagination_show %}

{% block title %}
    首页
{% endblock %}

{% block page %}
    {{ quick_form(form) }}
    {% for p in posts %}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media-left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;img</span> <span class="na">height=</span><span class="s">"50"</span><span class="err">,</span> <span class="na">width=</span><span class="s">"50"</span> <span class="na">class=</span><span class="s">"media-object"</span> <span class="na">src=</span><span class="s">"{{ url_for('static', filename='upload/'+p.user.icon) }}"</span> <span class="na">alt=</span><span class="s">"icon"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"media-body"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>发表于: {{ moment(p.timestamp).fromNow() }}<span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"media-heading"</span><span class="nt">&gt;</span>{{ p.user.username }}<span class="nt">&lt;/h4&gt;</span>
                {{ p.content }}
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    {% endfor %}

    {# 展示分页导航条 #}
    {{ pagination_show(pagination, 'main.index') }}

{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ moment.include_moment() }}
    {{ moment.locale('zh-CN') }}
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>视图函数 app/views/main.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">PostsForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">Posts</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>


<span class="nd">@main.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostsForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'发表成功'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'请先登录再发表'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'user.login'</span><span class="p">))</span>
    <span class="c"># 获取页码,默认为1, 强制转换成整型</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'page'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">pagination</span> <span class="o">=</span> <span class="n">Posts</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">rid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Posts</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">error_out</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">items</span>
    <span class="c"># posts = Posts.query.filter_by(rid=0).order_by(Posts.timestamp.desc()).paginate()</span>
    <span class="c"># posts = Posts.query.filter_by(rid=0).order_by(Posts.timestamp.desc()).all()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'main/index.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">,</span> <span class="n">pagination</span><span class="o">=</span><span class="n">pagination</span><span class="p">)</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>练习:</p>

<ul>
  <li>点击博客内容, 跳转到博客详情(博客内容, 所有回复, 发表回复)</li>
  <li>点击头像,或者电机用户名, 跳转到用户发表的博客列表页面()</li>
  <li>要用分页显示</li>
  <li>导航条上增加”我发表的”, 查看我自己发表的所有博客</li>
  <li>添加博客收藏功能(多对多的关系, 老师明天讲).</li>
</ul>

<h3 id="博客收藏功能重点---表的多对多关系">博客收藏功能:重点 - 表的多对多关系</h3>

<p>新建一个表,存储用户和帖子的收藏关系</p>

<p>多对多的例子: 收藏帖子, 学生选课</p>

<h4 id="收藏博客实现步骤">收藏博客实现步骤</h4>

<p>(1) 添加中间关联表: app/models/<strong>init</strong>.py</p>

<ul>
  <li>db.Table 用于建立多对多关系的中间表</li>
  <li>用户收藏帖子关联表, 这张表不需要我们手动维护, 是SQLAchemy 自动维护的</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">app.extensions</span> <span class="kn">import</span> <span class="n">db</span>

<span class="c"># 用户收藏帖子关联表, 这张表不需要我们手动维护, 是SQLAchemy 自动维护的</span>
<span class="n">collections</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">'collections'</span><span class="p">,</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'users.id'</span><span class="p">)),</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'posts_id'</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'posts.id'</span><span class="p">))</span>
<span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(2) 在users  表中添加 favorites 字段, app/models/user.py</p>

<ul>
  <li>这个字段反向引用 Posts</li>
  <li>secondry 用于指定当前表 User 和 反向引用表 Posts 的中间表名</li>
  <li>backref 用于反向引用, 用于让post 对象也可以拿到users 中的收藏信息.</li>
  <li>比如: 获取收藏数: <code class="language-plaintext highlighter-rouge">{{ p.abc.count() }}</code></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
	<span class="o">...</span>
  <span class="c"># 添加收藏功能的反向引用</span>
  <span class="c"># secondry 表示中间表</span>
  <span class="c"># backref()用于定义一个backrefer对象,并放到 relationship 中使用. 该函数可以接受一个名字和任意多个参数</span>
  <span class="c"># 这里的users 可以是任何名字, 可以改成abc</span>
  <span class="n">favorites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">'Posts'</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="s">'collections'</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">'abc'</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'dynamic'</span><span class="p">),</span> <span class="n">lazy</span><span class="o">=</span><span class="s">'dynamic'</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(3) 迁移数据</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>python3.7 manage.py db migrate
python3.7 manage.py db upgrade
</pre></td></tr></tbody></table>
</div>
</div>

<p>(4) 定义相关函数: 添加收藏, 去雄收藏, 判断是否收藏 app/models/user.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="c"># 添加收藏</span>
<span class="k">def</span> <span class="nf">add_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Posts</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># 这里会直接操作中间表,添加新的数据到collections中</span>

<span class="c"># 取消收藏</span>
<span class="k">def</span> <span class="nf">del_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Posts</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># 这里会直接操作中间表,删除指定的数据</span>

<span class="c"># 判断是否收藏过</span>
<span class="k">def</span> <span class="nf">is_favorite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="c"># 获取所有已经收藏的博客</span>
    <span class="n">favorites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="nb">id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">favorites</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>(5)添加收藏按钮, 用 <code class="language-plaintext highlighter-rouge">ajax</code> 进行请求 templtes/main/index.html</p>

<ul>
  <li>ajax 请求的优势是局部刷新, 消耗服务器资源小</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>{% if current_user.is_authenticated %}
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"collect"</span> <span class="na">style=</span><span class="s">"cursor: pointer;"</span> <span class="na">url=</span><span class="s">"{{ url_for( 'posts.collect', pid=p.id) }}"</span><span class="nt">&gt;</span>{% if current_user.is_favorite(p.id) %}取消收藏{% else %}收藏{% endif %}<span class="nt">&lt;/span&gt;</span>
{% endif %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>(6) 做 ajax 请求 app/templates/main/index.html</p>

<div class="language-html highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre>{% block scripts %}
    {{ super() }}
    {{ moment.include_moment() }}
    {{ moment.locale('zh-CN') }}

    <span class="nt">&lt;script&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'.collect'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="c1">// this 在回调函数中没有意义. 需要将this 临时保存在另一个变量中.</span>
                <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">_this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'url'</span><span class="p">),</span> <span class="kd">function</span><span class="p">(){</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">_this</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'收藏'</span><span class="p">){</span>
                        <span class="nx">$</span><span class="p">(</span><span class="nx">_this</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">'取消收藏'</span><span class="p">)</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="nx">$</span><span class="p">(</span><span class="nx">_this</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">'收藏'</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">})</span>

    <span class="nt">&lt;/script&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table>
</div>
</div>

<p>(7) 添加新的蓝本文件 app/views/posts.py</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">current_user</span>

<span class="n">posts</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'posts'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>

<span class="c"># 这里需要将pid类型限制成整型, 否则可能找不到</span>
<span class="nd">@posts.route</span><span class="p">(</span><span class="s">'/collect/&lt;int:pid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="c"># 判断是否收藏</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_favorite</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
        <span class="c"># 取消收藏</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">del_favorite</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># 添加收藏</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">add_favorite</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="c"># jsonify 的作用是将python字典转成json 字符串</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'ok'</span><span class="p">})</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="项目总结">项目总结:</h3>

<ul>
  <li>用户管理
    <ul>
      <li>注册</li>
      <li>登录注册</li>
      <li>信息展示</li>
      <li>上传头像</li>
      <li>信息修改</li>
    </ul>
  </li>
  <li>博客管理
    <ul>
      <li>发表博客</li>
      <li>展示博客</li>
      <li>分页</li>
      <li>回复</li>
      <li>收藏</li>
      <li>统计显示</li>
    </ul>
  </li>
</ul>

<h2 id="restful-api-开发">RESTFul API 开发</h2>

<h3 id="概念">概念:</h3>

<blockquote>
  <p>RESTFUL: 一种软件架构风格、设计风格，而<strong>不是</strong>标准，只是提供了一组设计原则和约束条件。它主要用于客户端和服务器交互类的软件。基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存等机制。</p>

  <p>REST: 即表述性状态传递（英文：Representational State Transfer，简称REST）是Roy Fielding博士在2000年他的博士论文中提出来的一种软件架构风格。它是一种针对网络应用的设计和开发方式，可以降低开发的复杂性，提高系统的可伸缩性。</p>

  <p>API: 应用程序接口. 符合restful 风格的应用程序接口叫做restful api</p>

  <p>Restful的接口都是围绕着资源以及对资源的操作展开的</p>
</blockquote>

<p>资源:</p>

<blockquote>
  <p>网络上存在的任意实体,即使是一条消息也是资源</p>
</blockquote>

<p>操作:</p>

<blockquote>
  <p>所谓的操作就是对资源的CURD.</p>

  <p>对网络的任意操作都可以抽象为增删改查</p>

  <p>RestFul 对网络资源的操作抽象为 HTTP的各种方法(POST, GET, DELETE,PUT等), 以完成对资源的特定操作.</p>

</blockquote>

<table>
  <thead>
    <tr>
      <th>方法</th>
      <th>操作</th>
      <th>例子</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>GET</td>
      <td>获取全部资源</td>
      <td>http://127.0.0.1:5000/source</td>
    </tr>
    <tr>
      <td> </td>
      <td>获取指定资源</td>
      <td>http://127.0.0.1:5000/source/250</td>
    </tr>
    <tr>
      <td>POST</td>
      <td>创建新的资源</td>
      <td>http://127.0.0.1:5000/source</td>
    </tr>
    <tr>
      <td>PUT</td>
      <td>更新指定资源</td>
      <td>http://127.0.0.1:5000/250</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>删除指定资源</td>
      <td>http://127.0.0.1:5000/250</td>
    </tr>
  </tbody>
</table>

<p>数据: JSON</p>

<blockquote>
  <p>通常传输数据的格式是JSON, 有时也会结合GET传递参数</p>

  <ul>
    <li>JSON 指的是 JavaScript 对象表示法（<em>J</em>ava<em>S</em>cript <em>O</em>bject <em>N</em>otation）</li>
    <li>JSON 是轻量级的文本数据交换格式</li>
    <li>JSON 独立于语言 *</li>
    <li>JSON 具有自我描述性，更易理解</li>
    <li>JSON 是存储和交换文本信息的语法。类似 XML。</li>
    <li>JSON 比 XML 更小、更快，更易解析。</li>
  </ul>
</blockquote>

<p>使用的工具Postman 模拟 ResuFul 请求</p>

<blockquote>
  <p>说明: postman是一款非常好用的API测试工具, 可以轻松模拟各种请求.</p>

  <p>提示: 下载(getpostman.com)安装包, 一路next</p>
</blockquote>

<h3 id="原生实现">原生实现</h3>

<p>准备测试使用的数据和路由</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="c"># 定义测试数据(博客资源)</span>
<span class="n">posts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'Python语法'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'听别人说很简单, 但是想用好不容易'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'HTML'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'H5, CSS, JS, JQuery, bootstrap 都很简单'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'FLask'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'Flask 各种框架'</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'restful api 开发'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="get请求--获取所有资源">GET请求- 获取所有资源</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="c"># 获取所有资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_posts_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>请求方法</p>

<p>http://127.0.0.1:5000/posts/</p>

<h4 id="get-请求---获取指定资源">GET 请求 - 获取指定资源</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c"># 获取指定资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>请求方法</p>

<p>http://127.0.0.1:5000/posts/2</p>

<h4 id="post-创建新的资源">POST 创建新的资源</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="c"># 创建新的资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_posts</span><span class="p">():</span>
    <span class="c"># 判断是否有json数据传过来, 并判断title 和 content key 是否存在在json对象中</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="s">'title'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="s">'content'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c"># 400 bad request表示传过来的数据格式不正确</span>
    <span class="c"># 新建资源</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="n">posts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'content'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="c"># 保存资源</span>
    <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">}),</span> <span class="mi">201</span>  <span class="c"># 201 代表 created</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>请求方法:</p>

<blockquote>
  <p>请求地址: http://127.0.0.1:5000/posts</p>

  <p>请求body:</p>

  <div class="language-json highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Django"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Django 各种框架"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>
  </div>

  <ul>
    <li>这里有一个坑: 需要双引号来把内容括起来</li>
  </ul>

  <p>请求头: Content-Type application/json</p>

</blockquote>

<h4 id="put-修改指定资源">PUT 修改指定资源</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'PUT'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'title'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">'content'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'content'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<blockquote>
  <p>请求方法: http://127.0.0.1:5000/posts/1</p>

  <p>请求Body:</p>

  <div class="language-json highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"改成Django"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"改成Django 各种框架"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table>
</div>
  </div>

  <p>请求头: Content-Type application/json</p>

</blockquote>

<h4 id="delete-删除指定资源">DELETE 删除指定资源</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'DELETE'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">posts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'资源已删除'</span><span class="p">})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>请求方法: http://127.0.0.1:5000/posts/3</p>

<h4 id="错误定制">错误定制</h4>

<p>如果不定制错误, 那么就会返回浏览器默认的错误格式.</p>

<p>返回浏览器指定的错误也有好处, 浏览器返回的错误给出了具体的问题所在, 所以方便调试</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="c"># 错误定制. 如果不定制错误, 那么就会返回浏览器默认的错误格式</span>

<span class="c"># &lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span>
<span class="c"># &lt;title&gt;404 Not Found&lt;/title&gt;</span>
<span class="c"># &lt;h1&gt;Not Found&lt;/h1&gt;</span>
<span class="c"># &lt;p&gt;The requested URL was not found on the server.  If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span>
<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'页面没找到'</span><span class="p">}),</span> <span class="mi">404</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bad_request</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'坏请求'</span><span class="p">}),</span> <span class="mi">400</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="身份认证">身份认证</h4>

<p>安装</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-httpauth
</pre></td></tr></tbody></table>
</div>
</div>

<p>代码实现: 三个步骤</p>

<ul>
  <li>(1) 在需要认证保护的路由上面加上 <code class="language-plaintext highlighter-rouge">@auth.login_required</code>装饰器, 这个装饰器会调用 <code class="language-plaintext highlighter-rouge">@auth.verify_password</code> 所定义的验证方法</li>
  <li>(2) 定义一个 <code class="language-plaintext highlighter-rouge">@auth.verify_password</code> 验证用户名和密码. 这里大多数情况下需要从数据库中匹配用户名密码. 如果验证失败了,会调用 <code class="language-plaintext highlighter-rouge">@auth.error_handler</code> 装饰器定义的方法</li>
  <li>(3) 定义 <code class="language-plaintext highlighter-rouge">@auth.error_handler</code> 方法处理错误</li>
  <li>注意: 上面装饰器的开头都是 <code class="language-plaintext highlighter-rouge">@auth 开头, 不是@app</code></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="c"># 导入类库</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="c"># 创建对象</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="c"># 认证的回调函数</span>
<span class="nd">@auth.verify_password</span>
<span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="c"># 此处理论上应该查询数据，这里模拟使用</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">'Jerry'</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s">'123456'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="c"># 定制认证错误显示</span>
<span class="nd">@auth.error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'Unauthorized Access'</span><span class="p">}),</span> <span class="mi">403</span>
  
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts'</span><span class="p">)</span>
<span class="c"># 路由保护</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">get_posts_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">})</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>使用方法:</p>

<blockquote>
  <p>postman 在认证中设置用户名密码, 才能通过认证</p>
</blockquote>

<h4 id="完整代码">完整代码</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>


<span class="c"># 创建认证对象</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>


<span class="c"># 认证回调函数</span>
<span class="nd">@auth.verify_password</span>
<span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
    <span class="c"># 此处是模拟功能, 真正场景需要查询数据库</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">'Jerry'</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s">'123456'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="nd">@auth.error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'unautheried user'</span><span class="p">})</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="c"># 定义测试数据(博客资源)</span>
<span class="n">posts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'Python语法'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'听别人说很简单, 但是想用好不容易'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'HTML'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'H5, CSS, JS, JQuery, bootstrap 都很简单'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="s">'FLask'</span><span class="p">,</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="s">'Flask 各种框架'</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="c"># 错误定制. 如果不定制错误, 那么就会返回浏览器默认的错误格式</span>
<span class="c"># 返回浏览器指定的错误也有好处, 浏览器返回的错误给出了具体的问题所在, 所以方便调试</span>

<span class="c"># &lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span>
<span class="c"># &lt;title&gt;404 Not Found&lt;/title&gt;</span>
<span class="c"># &lt;h1&gt;Not Found&lt;/h1&gt;</span>
<span class="c"># &lt;p&gt;The requested URL was not found on the server.  If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'page not found'</span><span class="p">}),</span> <span class="mi">404</span>

<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bad_request</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'bad request'</span><span class="p">}),</span> <span class="mi">400</span>




<span class="c"># 获取所有资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts'</span><span class="p">)</span>
<span class="c"># # 路由保护</span>
<span class="nd">@auth.login_required</span>  <span class="c"># 这里有一个认证保护的例子</span>
<span class="k">def</span> <span class="nf">get_posts_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">posts</span><span class="p">})</span>


<span class="c"># 获取指定资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>


<span class="c"># 创建新的资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_posts</span><span class="p">():</span>
    <span class="c"># 判断是否有json数据传过来, 并判断title 和 content key 是否存在在json对象中</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="s">'title'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="s">'content'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c"># 400 bad request表示传过来的数据格式不正确</span>
    <span class="c"># 新建资源</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'id'</span><span class="p">:</span> <span class="n">posts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">'title'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span>
        <span class="s">'content'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'content'</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="c"># 保存资源</span>
    <span class="n">posts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">}),</span> <span class="mi">201</span>  <span class="c"># 201 代表 created</span>


<span class="c"># 修改指定的资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'PUT'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'title'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">'content'</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">'content'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'posts'</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>



<span class="c"># 删除指定资源</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/posts/&lt;int:pid&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'DELETE'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_posts</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">,</span> <span class="n">posts</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">posts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'数据已删除'</span><span class="p">})</span>



<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'restful api 开发'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">mgr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="flask-restful-实现restful">flask-restful 实现RestFul</h3>

<h4 id="安装-1">安装:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>pip3.7 install flask-restful
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="完整代码-1">完整代码</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="c"># 导入类库</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">TimedJSONWebSignatureSerializer</span> <span class="k">as</span> <span class="n">Serializer</span>


<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>


<span class="nd">@auth.verify_password</span>
<span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="n">username_or_token</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">username_or_token</span> <span class="o">==</span> <span class="s">'Jerry'</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s">'123456'</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username_or_token</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c"># 如果是token, 解密token</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">username_or_token</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="nd">@auth.error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="s">'unauthorized access'</span><span class="p">}),</span> <span class="mi">403</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'123456'</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c"># 创建对象</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="c"># 创建一个资源类，一个资源的完整操作一般需要两个资源类</span>
<span class="c"># 需要写一个类继承 Resource, 一个资源的完整操作需要定义两个类, 一个负责带参数, 另一个负责不带参数</span>
<span class="k">class</span> <span class="nc">UserAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c"># 添加认证, 只要写一行, 对类中的所有方法都有效</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>

    <span class="c"># 定义和restful 请求方法同名的方法</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="c"># return {'User': 'GET'}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'User'</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">username</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'User'</span><span class="p">:</span> <span class="s">'PUT'</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'User'</span><span class="p">:</span> <span class="s">'DELETE'</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">UserListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c"># 添加认证, 只要写一行, 对类中的所有方法都有效</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'UserList'</span><span class="p">:</span> <span class="s">'GET'</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">'UserList'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">}</span>

<span class="c"># 添加资源，第一个参数是类名, 第二个参数是路由地址, 第三个参数是其他可以进来的路由.</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">UserAPI</span><span class="p">,</span> <span class="s">'/users/&lt;int:uid&gt;'</span><span class="p">,</span> <span class="s">'/u/&lt;int:uid&gt;'</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">UserListAPI</span><span class="p">,</span> <span class="s">'/users'</span><span class="p">)</span>



<span class="c"># 若不是在创建Api对象时设置app，那么init_app调用要放在添加资源之后</span>
<span class="c"># 如果需要将创建API对象和初始化app分离, 那么初始化app时一定要将初始化代码放在创建的restful类的后面</span>
<span class="c"># api.init_app(app)</span>
<span class="c">#api.init_app(app)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'flask-restful'</span>


<span class="c"># 生成一段乱码发给客户, 乱码中带有token</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/get_token'</span><span class="p">)</span>
<span class="nd">@auth.login_required</span>
<span class="k">def</span> <span class="nf">get_token</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Serializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">],</span> <span class="n">expires_in</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'username'</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">username</span><span class="p">})</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>请求方法:</p>

<blockquote>
  <p>(1). 首先在postman中输入用户名密码, 然后请求 http://127.0.0.1:5000/get_token , GET 方法就可以.</p>

  <p>返回的body中会带回来一个字符串, 类似于: eyJhbGciOiJIUzI1NiIsImlhdCI6MTUxNTY2ODgxMCwiZXhwIjoxNTE1NjcyNDEwfQ.eyJ1c2VybmFtZSI6IkplcnJ5In0.uBn42cOTVW9mEjFrpdRA3qZXj-5rIhMv6mhlwcLcya8</p>

  <p>(2). 将字符串放在 postman 用户名里, 密码留空, 然后再请求</p>

  <p>http://127.0.0.1:5000</p>
</blockquote>

<h2 id="flask-项目部署">Flask 项目部署</h2>

<p>Web 工作原理</p>

<blockquote>
  <p>客户端(浏览器) &lt;=&gt; web服务端(nginx) &lt;=&gt; WSGI &lt;=&gt; Python(Flask) &lt;=&gt; 数据库</p>

  <p>WSGI 是一个 PYthon 通用标准协议, uWSGI 是一个实现</p>

  <p>Fast-CGI 是 PHP 通用标准协议</p>
</blockquote>

<h3 id="nginx-安装">nginx 安装</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c"># Nginx 安装</span>
yum install -y nginx
sed -i <span class="s1">'s/listen       80 default_server/listen       8081 default_server/g'</span> /etc/nginx/nginx.conf
sed -i <span class="s1">'s/listen       \[::\]:80 default_server/listen       \[::\]:8081 default_server/g'</span> /etc/nginx/nginx.conf
systemctl start nginx.service
systemctl <span class="nb">enable </span>nginx.service
</pre></td></tr></tbody></table>
</div>
</div>

<p><em>nginx 配置文件和web 目录</em></p>

<ul>
  <li>查看启动状态: systemctl status nginx</li>
  <li>web 目录: /usr/share/nginx/html</li>
  <li>配置文件: /etc/nginx/nginx.conf</li>
</ul>

<h3 id="1配置nginx-虚拟主机">(1)配置Nginx 虚拟主机</h3>

<ul>
  <li>
    <p>/etc/nginx/nginx.conf 最后一个大括号前面添加</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>include vhost/<span class="k">*</span>.conf;
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>创建vhost目录</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>mkdir /etc/nginx/vhost
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>在该目录下建立配置文件  www.blog.com.conf</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>server <span class="o">{</span>
        listen 8082;
        server_name www.blog.com blog.com;

        location / <span class="o">{</span>
                root html/blog;
                index index.html;
        <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>创建虚拟主机目录和文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>mkdir /usr/share/nginx/html/blog 
<span class="nb">echo</span> <span class="s1">'hello blog'</span> &gt; /usr/share/nginx/html/blog 
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>做本地域名劫持 vim /etc/hosts, 增加一行. 前面的IP 是自己在局域网的IP</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>10.11.56.210 www.blog.com
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h3 id="2添加博客内容">(2)添加博客内容</h3>

<p>在blog文件夹下建立一个 <code class="language-plaintext highlighter-rouge">test.py</code> 文件</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">'welcome flask'</span>

<span class="k">if</span> <span class="n">__name</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">mgr</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TEMPLATES_AUTO_RELOAD'</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>运行服务, 并在客户端访问</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>python3.7 test.py runserver -r -d -h0.0.0.0
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="3安装-uwsgi">(3)安装 uWSGI</h3>

<p>说明: uWSGI 是实现了WSGI协议的应用程序</p>

<p>安装运行后就不需要在用  python3.6 test.py -r -d -h0.0.0.0 来启动服务了</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>yum install uwsgi
systemctl start uwsgi

<span class="c"># 另一种方法</span>
<span class="c"># pip3.7 install uwsgi</span>
<span class="c"># ln -s /usr/local/python3.7/bin/uwsgi /usr/bin/uwsgi</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="配置参数">配置参数:</h4>

<ul>
  <li>更多参数 uwsgi –help</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre>http		<span class="c"># 采用http协议</span>
socket		<span class="c"># 使用 socket</span>
wsgi-file 	<span class="c"># 指定接收到的数据交给那个文件处理 manage.py</span>
callable	<span class="c"># 指定交给那个对象来处理 app</span>
chdir 		<span class="c"># 网站根目录 /usr/share/nginx/html/blog</span>
daemonize	<span class="c"># 后台启动, 需要指定一个日志文件</span>
processes	<span class="c"># 指定进程数</span>
threads		<span class="c"># 指定线程数. 总的线程数是进程数 * 线程数</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="wsgi-以-http-启动方法">WSGI 以 http 启动方法:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nb">cd</span> /usr/share/nginx/html/blog
uwsgi --http 10.11.56.210:5000 --wsgi-file test.py --callable app
</pre></td></tr></tbody></table>
</div>
</div>

<p>然后到浏览器中访问: http://10.11.56.210:5000</p>

<h4 id="wsgi-以-socket-启动">WSGI 以 socket 启动:</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>vim /etc/nginx/vhost/www.blog.com.conf
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>server <span class="o">{</span>
        listen 8082;
        server_name www.blog.com blog.com;

        location / <span class="o">{</span>
        <span class="c">#       root html/blog;</span>
        <span class="c">#       index index.html;</span>
                include uwsgi_params;        <span class="c"># 包含需要的参数</span>
                uwsgi_pass 127.0.0.1:5000;   <span class="c"># 指定的转发地址(socket 协议)</span>
        <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>启动</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>systemctl restart nginx
uwsgi --socket 127.0.0.1:5000 --wsgi-file test.py --callable app
</pre></td></tr></tbody></table>
</div>
</div>

<p>为了简化配置命令, 也可以写uwsgi配置文件 , 在blog目录下创建uwsgi.ini</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="o">[</span>uwsgi]
socket <span class="o">=</span> 127.0.0.1:5000
wsgi-file <span class="o">=</span> test.py
callable <span class="o">=</span> app
daemonize <span class="o">=</span> /var/log/uwsgi.log
<span class="c"># 如果用多线程, 需要制定threads 参数</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>再次启动</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>uwsgi uwsgi.ini
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="静态文件处理">静态文件处理</h3>

<p>修改nginx 配置, 让静态内容不进行转发</p>

<p>vim /etc/nginx/vhost/www.blog.com.conf</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre>server <span class="o">{</span>
        listen 8082;
        server_name www.blog.com blog.com;
        location /static <span class="o">{</span> 				<span class="c"># 如果网址路径匹配到 /static</span>
                 root html/blog/;		<span class="c"># 那么就获取 web服务器 目录的html/blog 的内容</span>
                <span class="c">#alias /html/blog/statics/</span>
        <span class="o">}</span>
        location / <span class="o">{</span>
        <span class="c">#       root html/blog;</span>
        <span class="c">#       index index.html;</span>
                include uwsgi_params;
                uwsgi_pass 127.0.0.1:5000;
        <span class="o">}</span>

<span class="o">}</span>

</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>如果多个路由可以匹配到进来的path, nginx采用最大前缀匹配原则,</li>
</ul>

<h3 id="流程回顾">流程回顾:</h3>

<p>(1) 浏览器获取输入的www.blog.com
(2) /etc/hosts 劫持了这个域名, 进行本机域名解析, ip 为 10.11.56.210
(3) nginx 开始查找这个域名如何处理, 检索 /etc/nginx/nginx.conf 文件
(4) nginx 在 文件尾部找到 include vhost/*.conf; 而后在/etc/nginx/vhost 目录下找到www.blog.com.conf 文件
(5) www.blog.com.conf 文件找到 www.blog.com 的处理方法.</p>

<ul>
  <li>监听8082端口的信息</li>
  <li>将处理www.blog.com 的请求.</li>
  <li>路由/static 将内容转发到  html/blog/下面的内容返回.</li>
  <li>路由/   将内容转发给uwsgi , 转发的地址是127.0.0.1:5000</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre>server <span class="o">{</span>
        listen 8082;
        server_name www.blog.com blog.com;
        location /static <span class="o">{</span>
                root html/blog/;
        <span class="o">}</span>
        location / <span class="o">{</span>
        <span class="c">#       root html/blog;</span>
        <span class="c">#       index index.html;</span>
                include uwsgi_params;  <span class="c"># 带上 /etc/nginx/uwsgi_params 文件中的参数</span>
                uwsgi_pass 127.0.0.1:5000;
        <span class="o">}</span>

<span class="o">}</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>(6) <code class="language-plaintext highlighter-rouge">uwsgi --socket 127.0.0.1:5000 --wsgi-file test.py --callable app</code> , 启动的 uwsgi 服务正在监听 127.0.0.1:5000, 将接收到的信息发给 test.py 程序, 并呼叫app 这个程序来处理.</p>

<p>(7) 接下来就是flask 的逻辑以及返回了.</p>


            </div>

            <!-- Rating -->
            
            <div class="rating mb-4 d-flex align-items-center">
                <strong class="mr-1">Rating:</strong> <div class="rating-holder">
<div class="c-rating c-rating--regular" data-rating-value="4.5">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>5</button>
</div>
</div>
            </div>
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2019-11-10">10 Nov 2019</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Flask">Flask</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Python">Python</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//Python-Crowler-In-Actrion/"> &laquo; Python Crowler In Action</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//Django-In-Action/">Django In Action &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

<script type="application/ld+json">
{
  "@context": "http://schema.org/",
  "@type": "Review",
  "itemReviewed": {
    "@type": "Thing",
    "name": "Flask Framework for Python"
  },
  "author": {
    "@type": "Person",
    "name": "Dalong"
  },
  "datePublished": "2019-11-10",
  "reviewRating": {
    "@type": "Rating",
    "ratingValue": "4.5",
    "bestRating": "5"
  }
}
</script>

</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Linux">Linux (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Python">Python (16)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Mysql">Mysql (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Redis">Redis (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MongoDB">MongoDB (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Flask">Flask (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Django">Django (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#DjangoRest">DjangoRest (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Numpy">Numpy (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Panda">Panda (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Sklearn">Sklearn (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Jupyter">Jupyter (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#OpenCV">OpenCV (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#AI">AI (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Tensorflow">Tensorflow (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Microservice">Microservice (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Docker">Docker (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#NLP">NLP (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#AWS">AWS (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Architecture">Architecture (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Agile">Agile (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Scrum">Scrum (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MLPS">MLPS (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#PIPL">PIPL (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Metaverse">Metaverse (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Togaf">Togaf (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ChatGPT">ChatGPT (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#OpenAI">OpenAI (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#LLM">LLM (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure">Azure (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Data-Science">Data Science (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ITIL">ITIL (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#IT">IT (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Jekyll">Jekyll (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Github">Github (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Liquid">Liquid (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Markdown">Markdown (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2023 Dalong's personal blog 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="#">Designed</a> by Dalong.work
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
